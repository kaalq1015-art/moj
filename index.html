<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ูุญุฑู ูุทุงุจูุฉ ุงูุตููู (ูุฏุนู OCR)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js'></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap');
        body { font-family: 'Tajawal', sans-serif; }
        /* ุชุฃุซูุฑ ูุจุถ ุฃุซูุงุก ุงููุนุงูุฌุฉ ุงูุซูููุฉ */
        .pulse-animation { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    </style>
</head>
<body class="bg-gray-50 p-5 md:p-10">

    <div class="max-w-5xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-3xl font-bold text-blue-900">ูุธุงู ุงููุทุงุจูุฉ ุงูุนูุงุฑู ุงูุฐูู (v2.0)</h1>
            <p class="text-gray-600 mt-2">ูุฏุนู ุงูุขู ุงูุตููู ุงูุฑูููุฉ ูุงูููุณูุญุฉ ุถูุฆูุงู (OCR)</p>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-blue-500">
                <label class="block font-bold mb-2 flex items-center">
                    ๐ 1. ุตู ุญุตุฑ ุงููุฑุซุฉ
                    <span id="inhStatus" class="text-xs mr-2 text-gray-400"></span>
                </label>
                <input type="file" id="inheritanceFile" accept=".pdf" class="file-input w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-500">
                <label class="block font-bold mb-2 flex items-center">
                    โ๏ธ 2. ุตู ุงูููุงูุฉ
                    <span id="poaStatus" class="text-xs mr-2 text-gray-400"></span>
                </label>
                <input type="file" id="poaFile" accept=".pdf" class="file-input w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100"/>
            </div>
        </div>

        <div class="text-center mb-10 space-y-3">
            <button onclick="startProcessing()" id="processBtn" class="bg-blue-900 hover:bg-blue-800 text-white font-bold py-4 px-12 rounded-lg transition-all shadow-lg text-lg">
                ๐ก๏ธ ุจุฏุก ุงูุชุญููู ูุงููุทุงุจูุฉ
            </button>
            <div id="processingStatus" class="text-blue-700 font-semibold hidden pulse-animation">
                ุฌุงุฑู ุชููุฆุฉ ุงููุญุฑูุงุช...
            </div>
            <div id="ocrWarning" class="text-amber-600 text-sm hidden">
                โ๏ธ ุชูุจูู: ุชู ุงูุชุดุงู ูููุงุช ููุณูุญุฉ ุถูุฆูุงู. ุนูููุฉ ุงูู OCR ูุฏ ุชุณุชุบุฑู ููุชุงู ุฃุทูู (ุฏูููุฉ ุฃู ุฃูุซุฑ) ุญุณุจ ุณุฑุนุฉ ุฌูุงุฒู.
            </div>
        </div>

        <div id="resultsArea" class="hidden">
             <div id="summaryAlert" class="mb-6 p-4 rounded-lg flex items-center gap-3"></div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white rounded-xl shadow overflow-hidden">
                    <div class="bg-gray-800 text-white px-4 py-2 font-bold">ุฌุฏูู ูุทุงุจูุฉ ุงููุฑุซุฉ</div>
                    <div class="max-h-96 overflow-y-auto">
                        <table class="w-full text-right border-collapse" id="resultsTable">
                            <thead class="sticky top-0 bg-gray-100 shadow-sm">
                                <tr class="text-sm text-gray-600">
                                    <th class="p-3 border">ุงูุทุฑู (ูู ุตู ุงูุญุตุฑ)</th>
                                    <th class="p-3 border">ุฑูู ุงููููุฉ ุงููุณุชุฎุฑุฌ</th>
                                    <th class="p-3 border">ุงูุญุงูุฉ ูู ุงูููุงูุฉ</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow p-6 border border-gray-200">
                    <h3 class="font-bold text-lg mb-4 text-blue-900 border-b pb-2">ุชุญููู ูุทุงู ูุตูุงุญูุงุช ุงูููุงูุฉ</h3>
                    <div id="poaDetails" class="space-y-3 text-sm"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ุฅุนุฏุงุฏ ููุชุจุฉ PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        // --- ุฏูุงู ูุณุงุนุฏุฉ ูููุงุฌูุฉ ---
        const updateStatus = (msg, showOcrWarning = false) => {
            const statusDiv = document.getElementById('processingStatus');
            const ocrWarnDiv = document.getElementById('ocrWarning');
            statusDiv.innerText = msg;
            statusDiv.classList.remove('hidden');
            if(showOcrWarning) ocrWarnDiv.classList.remove('hidden');
            else ocrWarnDiv.classList.add('hidden');
        };

        const setFileStatus = (elementId, status, isOCR = false) => {
            const el = document.getElementById(elementId);
            el.innerText = status;
            el.className = `text-xs mr-2 ${isOCR ? 'text-amber-600 font-bold' : 'text-green-600'}`;
        };


        // --- ุงููุญุฑู ุงูุฃุณุงุณู (HYBRID ENGINE) ---

        // 1. ุงููุญุงููุฉ ุงูุณุฑูุนุฉ: ุงุณุชุฎุฑุงุฌ ุงููุต ุงูุฑููู ุงููุจุงุดุฑ
        async function tryQuickExtraction(pdfDoc) {
            let fullText = "";
            for (let i = 1; i <= pdfDoc.numPages; i++) {
                const page = await pdfDoc.getPage(i);
                const content = await page.getTextContent();
                fullText += content.items.map(item => item.str).join(" ");
            }
            return fullText;
        }

        // 2. ุงููุญุงููุฉ ุงูุซูููุฉ: ุงุณุชุฎุฑุงุฌ ุงููุต ุนุจุฑ OCR ููุตูุฑ
        async function performOCR(pdfDoc, fileTypeLabel) {
            updateStatus(`ุฌุงุฑู ุชุดุบูู OCR ุนูู ${fileTypeLabel}... (ูุฐู ุงูุนูููุฉ ุชุณุชุบุฑู ููุชุงู)`, true);
            
            // ุชููุฆุฉ ุนุงูู Tesseract ููุบุฉ ุงูุนุฑุจูุฉ
            const worker = await Tesseract.createWorker('ara');
            let fullText = "";

            for (let i = 1; i <= pdfDoc.numPages; i++) {
                updateStatus(`ุฌุงุฑู ุชุญููู ุตูุญุฉ ${i} ูู ${pdfDoc.numPages} ูู ${fileTypeLabel}...`, true);
                
                const page = await pdfDoc.getPage(i);
                // ุฒูุงุฏุฉ ุฏูุฉ ุงูุตูุฑุฉ (scale 2.0) ูุชุญุณูู ูุชุงุฆุฌ ุงูู OCR
                const viewport = page.getViewport({ scale: 2.0 });
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                // ุชุญููู ุตูุญุฉ PDF ุฅูู ุตูุฑุฉ ูู ุงูู canvas
                await page.render({ canvasContext: ctx, viewport: viewport }).promise;

                // ุชูููุฐ ุงูู OCR ุนูู ุงูุตูุฑุฉ
                const { data: { text } } = await worker.recognize(canvas);
                fullText += text + " ";
            }
            await worker.terminate(); // ุฅุบูุงู ุงูุนุงูู ูุชูููุฑ ุงูุฐุงูุฑุฉ
            return fullText;
        }

        // 3. ุงูุฏุงูุฉ ุงูุฐููุฉ ุงูุชู ุชูุฑุฑ ุฃู ุทุฑููุฉ ุชุณุชุฎุฏู
        async function smartExtract(file, statusElementId, fileTypeLabel) {
            setFileStatus(statusElementId, "ุฌุงุฑู ุงูุชุญููู...");
            const arrayBuffer = await file.arrayBuffer();
            const pdfDoc = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

            // ุงูุฎุทูุฉ ุฃ: ุชุฌุฑุจุฉ ุงูุงุณุชุฎุฑุงุฌ ุงูุณุฑูุน
            let text = await tryQuickExtraction(pdfDoc);

            // ุงูุฎุทูุฉ ุจ: ุงูุชุญูู ููุง ุฅุฐุง ูุงู ุงููุต ุงููุณุชุฎุฑุฌ ูููุฏุงู
            // ุฅุฐุง ูุงู ุงููุต ูุตูุฑุงู ุฌุฏุงู (ุฃูู ูู 100 ุญุฑู)ุ ูุนุชุจุฑ ุงูููู "ุตูุฑุฉ" ููุดุบู ุงูู OCR
            if (text.trim().length < 100) {
                setFileStatus(statusElementId, "ููู ูุตูุฑ (ูุชุทูุจ OCR)", true);
                console.log(`${fileTypeLabel} ูุจุฏู ูุตูุฑุฉ. ุฌุงุฑู ุงูุชุญููู ูู OCR...`);
                text = await performOCR(pdfDoc, fileTypeLabel);
            } else {
                setFileStatus(statusElementId, "ููู ุฑููู (ูุตู)");
            }
            return text;
        }

        // --- ููุทู ุงููุทุงุจูุฉ (ููุณ ุงูุณุงุจู) ---
        function findIDs(text) {
            // ุชูุธูู ุงููุต ููููุงู ูุจู ุงูุจุญุซ ูุฒูุงุฏุฉ ุงูุฏูุฉ ูู ุงูู OCR
            const cleanText = text.replace(/[^\d\s]/g, ' '); 
            const regex = /\b1\d{9}\b/g;
            return [...new Set(cleanText.match(regex) || [])];
        }

        async function startProcessing() {
            const inhFile = document.getElementById('inheritanceFile').files[0];
            const poaFile = document.getElementById('poaFile').files[0];
            const btn = document.getElementById('processBtn');
            const resultsArea = document.getElementById('resultsArea');

            if (!inhFile || !poaFile) { alert("ูุฑุฌู ุงุฎุชูุงุฑ ุงูููููู ุฃููุงู"); return; }

            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');
            resultsArea.classList.add('hidden');
            updateStatus("ุจุฏุก ุนูููุฉ ุชุญููู ุงููููุงุช...");

            try {
                // ุงุณุชุฎุฑุงุฌ ุงููุตูุต ุจุงุณุชุฎุฏุงู ุงููุญุฑู ุงูุฐูู
                updateStatus("ุฌุงุฑู ุชุญููู ุตู ุญุตุฑ ุงููุฑุซุฉ...");
                const inhText = await smartExtract(inhFile, 'inhStatus', "ุตู ุงููุฑุซุฉ");

                updateStatus("ุฌุงุฑู ุชุญููู ุตู ุงูููุงูุฉ...");
                const poaText = await smartExtract(poaFile, 'poaStatus', "ุตู ุงูููุงูุฉ");

                updateStatus("ุฌุงุฑู ูุทุงุจูุฉ ุงูุจูุงูุงุช...");
                const heirsIDs = findIDs(inhText);
                const principalIDs = findIDs(poaText);

                if (heirsIDs.length === 0) {
                    alert("ูู ูุชู ุงูุนุซูุฑ ุนูู ุฃู ุฃุฑูุงู ูููุงุช ูู ุตู ุญุตุฑ ุงููุฑุซุฉ. ุชุฃูุฏ ูู ุฌูุฏุฉ ุงูููู.");
                    throw new Error("No IDs found in inheritance doc");
                }

                displayResults(heirsIDs, principalIDs, poaText);

            } catch (error) {
                console.error(error);
                updateStatus("ุญุฏุซ ุฎุทุฃ! ุฑุงุฌุน ูุญุฏุฉ ุงูุชุญูู (Console) ููุชูุงุตูู.");
                alert("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงููุนุงูุฌุฉ. ุฅุฐุง ููุช ุชุณุชุฎุฏู OCRุ ุชุฃูุฏ ูู ุงุชุตุงู ุงูุฅูุชุฑูุช ูุชุญููู ูููุงุช ุงููุบุฉ ูุฃูู ูุฑุฉ.");
            } finally {
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
                btn.innerText = "๐ก๏ธ ุจุฏุก ุงูุชุญููู ูุงููุทุงุจูุฉ";
                document.getElementById('processingStatus').classList.add('hidden');
                document.getElementById('ocrWarning').classList.add('hidden');
            }
        }

        // --- ุนุฑุถ ุงููุชุงุฆุฌ (ููุณ ุงูุณุงุจู ูุน ุชุญุณููุงุช ุทูููุฉ) ---
        function displayResults(heirs, principals, poaText) {
            const resultsArea = document.getElementById('resultsArea');
            const tbody = document.querySelector('#resultsTable tbody');
            const summary = document.getElementById('summaryAlert');
            const poaDetails = document.getElementById('poaDetails');
            
            resultsArea.classList.remove('hidden');
            tbody.innerHTML = "";
            let missingCount = 0;

            heirs.forEach((id, index) => {
                const isPresent = principals.includes(id);
                if (!isPresent) missingCount++;
                const row = `
                    <tr class="border-b ${isPresent ? 'bg-green-50' : 'bg-red-50'}">
                        <td class="p-3 text-sm text-gray-700">ุทุฑู ุฑูู ${index + 1}</td>
                        <td class="p-3 font-mono text-blue-800">${id}</td>
                        <td class="p-3 font-bold ${isPresent ? 'text-green-700' : 'text-red-700'}">
                            ${isPresent ? 'โ ููุฌูุฏ ููููู' : 'โ ุบูุฑ ููุฌูุฏ'}
                        </td>
                    </tr>`;
                tbody.innerHTML += row;
            });

            if (missingCount === 0) {
                summary.className = "mb-6 p-4 rounded-lg flex items-center gap-3 bg-green-100 text-green-900 border-l-4 border-green-600 shadow-sm";
                summary.innerHTML = `<div class="text-2xl">โ</div><div><h4 class="font-bold">ุงูููุงูุฉ ููุชููุฉ ุงูุฃุทุฑุงู</h4><p class="text-sm">ุฌููุน ุงูุฃุทุฑุงู ุงููุณุชุฎุฑุฌุฉ ูู ุตู ุงูุญุตุฑ (${heirs.length}) ููุฌูุฏูู ูู ุงูููุงูุฉ.</p></div>`;
            } else {
                summary.className = "mb-6 p-4 rounded-lg flex items-center gap-3 bg-red-100 text-red-900 border-l-4 border-red-600 shadow-sm pulse-animation";
                summary.innerHTML = `<div class="text-2xl">โ๏ธ</div><div><h4 class="font-bold">ุชูุจูู: ุงูููุงูุฉ ูุงูุตุฉ</h4><p class="text-sm">ููุฌุฏ ุนุฏุฏ (${missingCount}) ูู ุงููุฑุซุฉ ูู ูุชู ุงูุนุซูุฑ ุนูู ูููุงุชูู ูู ุงูููุงูุฉ.</p></div>`;
            }

             // ุชุญุณูู ุงูุจุญุซ ุนู ุงููููุงุช ุงูููุชุงุญูุฉ ูุฏุนู ุฃุฎุทุงุก ุงูู OCR ุงููุญุชููุฉ
             // ูุซูุงู ุงูุจุญุซ ุนู "ุจูุน" ูุฏ ูุฌุฏูุง ุงูู OCR "ุจูุบ" ุฃู "ููุน"
            const hasSelling = /ุจูุน|ุงูุฑุงุบ|ุฅูุฑุงุบ|ูุจูุน|ููุงูุฑุงุบ/.test(poaText);
            const hasReceiving = /ูุจุถ|ุงุณุชูุงู|ููุงุณุชูุงู|ููุจุถ|ุงุณุชูุงู ุงููุจูุบ/.test(poaText);
            const poaSnippet = poaText.substring(0, 300) + "..."; // ุนุฑุถ ููุชุทู

            poaDetails.innerHTML = `
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="bg-blue-50 p-3 rounded-lg border border-blue-100 text-center">
                        <span class="block text-gray-500 text-xs">ุตูุงุญูุฉ ุงูุจูุน ูุงูุฅูุฑุงุบ</span>
                        <span class="font-bold ${hasSelling?'text-green-700':'text-red-700'} text-lg">${hasSelling ? 'โ ูุชููุฑุฉ' : 'โ ุบูุฑ ูุงุถุญุฉ'}</span>
                    </div>
                    <div class="bg-blue-50 p-3 rounded-lg border border-blue-100 text-center">
                        <span class="block text-gray-500 text-xs">ุตูุงุญูุฉ ูุจุถ ุงูุซูู</span>
                        <span class="font-bold ${hasReceiving?'text-green-700':'text-red-700'} text-lg">${hasReceiving ? 'โ ูุชููุฑุฉ' : 'โ ุบูุฑ ูุงุถุญุฉ'}</span>
                    </div>
                </div>
                <div>
                    <h4 class="font-bold text-gray-700 mb-1 text-sm">ููุชุทู ูู ุจุฏุงูุฉ ูุต ุงูููุงูุฉ ุงููุณุชุฎุฑุฌ:</h4>
                    <p class="bg-gray-100 p-3 rounded text-xs text-gray-600 leading-relaxed h-24 overflow-y-auto">${poaSnippet}</p>
                </div>
            `;
        }
    </script>
</body>
</html>
