<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙˆÙƒÙŠÙ„ Ø§Ù„ÙˆØ±Ø«Ø©</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Arial', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #2c3e50 0%, #4a6491 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        header h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }

        header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .upload-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
            background: #f8f9fa;
        }

        @media (max-width: 768px) {
            .upload-section {
                grid-template-columns: 1fr;
            }
        }

        .upload-box {
            background: white;
            border: 3px dashed #4a6491;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .upload-box:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .upload-box h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.4rem;
        }

        .upload-box input[type="file"] {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }

        .upload-box input[type="file"]:hover {
            border-color: #4a6491;
        }

        .file-info {
            padding: 10px;
            background: #f1f8ff;
            border-radius: 8px;
            font-size: 0.9rem;
            color: #4a6491;
            min-height: 50px;
        }

        .controls {
            padding: 20px;
            text-align: center;
            background: #f8f9fa;
        }

        button {
            background: linear-gradient(135deg, #4a6491 0%, #2c3e50 100%);
            color: white;
            border: none;
            padding: 15px 35px;
            margin: 0 10px;
            border-radius: 50px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        #resetBtn {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .results-section {
            padding: 30px;
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .summary-card h3 {
            margin-bottom: 15px;
            font-size: 1.6rem;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .result-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .result-card:hover {
            border-color: #4a6491;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .result-card h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .detailed-results {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th {
            background: #2c3e50;
            color: white;
            padding: 15px;
            text-align: right;
            font-weight: 600;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            text-align: right;
        }

        tr:hover {
            background: #f5f9ff;
        }

        .status-complete {
            color: #27ae60;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-incomplete {
            color: #e74c3c;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .raw-data {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .raw-data-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .raw-data-grid {
                grid-template-columns: 1fr;
            }
        }

        .data-box {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .data-box h4 {
            color: #2c3e50;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 0.9rem;
            color: #555;
            line-height: 1.5;
        }

        .alert {
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(-10px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4a6491;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            color: #e74c3c;
            background: #fdf2f2;
            padding: 10px;
            border-radius: 5px;
            margin: 5px 0;
        }

        .success {
            color: #27ae60;
            background: #f0f9f0;
            padding: 10px;
            border-radius: 5px;
            margin: 5px 0;
        }

        .hidden {
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4a6491, #2c3e50);
            width: 0%;
            transition: width 0.5s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ”„ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙˆÙƒÙŠÙ„ Ø§Ù„ÙˆØ±Ø«Ø©</h1>
            <p>Ù†Ø¸Ø§Ù… Ù…Ø·Ø§Ø¨Ù‚Ø© Ù…Ù†Ø·Ù‚ÙŠ Ù…Ø­Ù„ÙŠ Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ÙƒØªÙ…Ø§Ù„ ØªÙˆÙƒÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ±Ø«Ø©</p>
            <p><small>ÙŠØ¹Ù…Ù„ ÙƒÙ„ÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ - Ù„Ø§ ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø£ÙŠ Ø®Ø§Ø¯Ù… Ø®Ø§Ø±Ø¬ÙŠ</small></p>
        </header>

        <div class="upload-section">
            <div class="upload-box">
                <h3>ğŸ“„ ØµÙƒ Ø­ØµØ± Ø§Ù„ÙˆØ±Ø«Ø©</h3>
                <input type="file" id="heirsFile" accept=".pdf" onchange="handleFileUpload(this, 'heirsInfo')">
                <div class="progress-bar hidden" id="heirsProgress">
                    <div class="progress-fill"></div>
                </div>
                <div class="file-info" id="heirsInfo"></div>
            </div>
            
            <div class="upload-box">
                <h3>ğŸ“‹ ØµÙƒ Ø§Ù„ÙˆÙƒØ§Ù„Ø©</h3>
                <input type="file" id="poaFile" accept=".pdf" onchange="handleFileUpload(this, 'poaInfo')">
                <div class="progress-bar hidden" id="poaProgress">
                    <div class="progress-fill"></div>
                </div>
                <div class="file-info" id="poaInfo"></div>
            </div>
        </div>

        <div class="controls">
            <button id="processBtn" onclick="processDocuments()" disabled>
                <span id="processText">ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚</span>
                <span id="processLoading" class="loading hidden"></span>
            </button>
            <button id="resetBtn" onclick="resetAll()">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
        </div>

        <div class="results-section" id="resultsSection">
            <div class="summary-card" id="summary">
                <h3>ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</h3>
                <p>Ù‚Ù… Ø¨Ø±ÙØ¹ Ù…Ù„ÙÙŠ PDF (ØµÙƒ Ø­ØµØ± Ø§Ù„ÙˆØ±Ø«Ø© ÙˆØµÙƒ Ø§Ù„ÙˆÙƒØ§Ù„Ø©) Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</p>
            </div>

            <div class="results-grid">
                <div class="result-card">
                    <h4>ğŸ‘¥ Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„ÙˆØ±Ø«Ø©</h4>
                    <div id="heirsMatchResult">Ø§Ù†ØªØ¸Ø± Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª...</div>
                </div>
                
                <div class="result-card">
                    <h4>ğŸ”— ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù†Ø·Ø§Ù‚</h4>
                    <div id="scopeValidationResult">Ø§Ù†ØªØ¸Ø± Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª...</div>
                </div>
                
                <div class="result-card">
                    <h4>ğŸ‘¤ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆÙƒÙŠÙ„</h4>
                    <div id="agentValidationResult">Ø§Ù†ØªØ¸Ø± Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª...</div>
                </div>
            </div>

            <div class="detailed-results">
                <h3>ğŸ“‹ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ</h3>
                <table id="detailsTable">
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ø§Ø³Ù…</th>
                            <th>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</th>
                            <th>ØµÙ„Ø© Ø§Ù„Ù‚Ø±Ø§Ø¨Ø© / Ø§Ù„Ø¯ÙˆØ±</th>
                            <th>Ø­Ø§Ù„Ø© Ø§Ù„ØªÙˆÙƒÙŠÙ„</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 20px; color: #666;">
                                Ù„Ù… ÙŠØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø¨Ø¹Ø¯
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="raw-data">
                <h3>ğŸ“„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø©</h3>
                <div class="raw-data-grid">
                    <div class="data-box">
                        <h4>Ø¨ÙŠØ§Ù†Ø§Øª ØµÙƒ Ø§Ù„Ø­ØµØ±</h4>
                        <pre id="heirsRawData">Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§ Ù…Ø­ØªÙˆÙ‰ ØµÙƒ Ø­ØµØ± Ø§Ù„ÙˆØ±Ø«Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø±ÙØ¹</pre>
                    </div>
                    <div class="data-box">
                        <h4>Ø¨ÙŠØ§Ù†Ø§Øª ØµÙƒ Ø§Ù„ÙˆÙƒØ§Ù„Ø©</h4>
                        <pre id="poaRawData">Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§ Ù…Ø­ØªÙˆÙ‰ ØµÙƒ Ø§Ù„ÙˆÙƒØ§Ù„Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø±ÙØ¹</pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== ØªØ¹Ø±ÙŠÙ Ø§Ù„ÙƒÙ„Ø§Ø³Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ====================
        
        class PDFParser {
            constructor() {
                this.textContent = '';
            }

            async extractTextFromPDF(file, onProgress) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    
                    reader.onload = async (e) => {
                        try {
                            const typedarray = new Uint8Array(e.target.result);
                            const pdf = await pdfjsLib.getDocument({
                                data: typedarray,
                                cMapUrl: 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/cmaps/',
                                cMapPacked: true,
                            }).promise;
                            
                            let fullText = '';
                            const totalPages = pdf.numPages;
                            
                            for (let i = 1; i <= totalPages; i++) {
                                if (onProgress) {
                                    onProgress(Math.round((i / totalPages) * 100));
                                }
                                
                                const page = await pdf.getPage(i);
                                const textContent = await page.getTextContent();
                                const pageText = textContent.items
                                    .map(item => item.str)
                                    .join(' ');
                                fullText += pageText + '\n';
                            }
                            
                            this.textContent = fullText;
                            resolve(fullText);
                        } catch (error) {
                            reject(new Error('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù PDF: ' + error.message));
                        }
                    };
                    
                    reader.onerror = () => {
                        reject(new Error('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù'));
                    };
                    
                    reader.readAsArrayBuffer(file);
                });
            }

            extractIDNumbers(text) {
                const idPattern = /\b\d{10}\b/g;
                const matches = text.match(idPattern) || [];
                return [...new Set(matches)];
            }

            extractArabicNames(text) {
                const namePattern = /[\u0600-\u06FF]{2,}(?:\s+[\u0600-\u06FF]{2,}){1,3}/g;
                const matches = text.match(namePattern) || [];
                return matches.map(name => name.trim()).filter(name => name.length > 3);
            }

            extractDocumentNumbers(text) {
                const patterns = [
                    /ØµÙƒ\s*Ø±Ù‚Ù…\s*[:Ø›]\s*(\d+)/i,
                    /Ø±Ù‚Ù…\s*Ø§Ù„ØµÙƒ\s*[:Ø›]\s*(\d+)/i,
                    /Ø±Ù‚Ù…\s*[:Ø›]\s*(\d+)/i,
                    /ØµÙƒ\s*Ø­ØµØ±\s*ÙˆØ±Ø«Ø©\s*Ø±Ù‚Ù…\s*(\d+)/i,
                    /\b\d{5,15}\b/g
                ];
                
                const results = [];
                patterns.forEach(pattern => {
                    const matches = text.match(pattern);
                    if (matches) {
                        if (Array.isArray(matches)) {
                            if (pattern.source.includes('(\\d+)')) {
                                results.push(matches[1]);
                            } else {
                                matches.forEach(m => {
                                    const num = m.replace(/\D/g, '');
                                    if (num.length >= 5) results.push(num);
                                });
                            }
                        }
                    }
                });
                
                return [...new Set(results)];
            }

            parseHeirsCertificate(text) {
                console.log("Ø¨Ø¯Ø¡ ØªØ­Ù„ÙŠÙ„ ØµÙƒ Ø­ØµØ± Ø§Ù„ÙˆØ±Ø«Ø©");
                const data = {
                    deceased: { name: null, id: null },
                    heirs: [],
                    documentNumber: null,
                    rawText: text
                };

                try {
                    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø±Ù‚Ù… Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©
                    const docNumbers = this.extractDocumentNumbers(text);
                    if (docNumbers.length > 0) {
                        data.documentNumber = docNumbers[0];
                        console.log("Ø±Ù‚Ù… Ø§Ù„ØµÙƒ Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬:", data.documentNumber);
                    }

                    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù‡ÙˆÙŠØ©
                    const ids = this.extractIDNumbers(text);
                    console.log("Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø©:", ids);
                    
                    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡
                    const names = this.extractArabicNames(text);
                    console.log("Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø©:", names);

                    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…ØªÙˆÙÙ‰ - Ø£Ù†Ù…Ø§Ø· Ù…Ø®ØªÙ„ÙØ©
                    const deceasedPatterns = [
                        /Ø§Ù„Ù…ØªÙˆÙ[ÙŠÙ‰]\s*[:Ø›]\s*([^\n\r]+)/i,
                        /Ø§Ø³Ù…\s*Ø§Ù„Ù…ØªÙˆÙ[ÙŠÙ‰]\s*[:Ø›]\s*([^\n\r]+)/i,
                        /Ø§Ù„Ù…ØªÙˆÙ[ÙŠÙ‰]\s+([\u0600-\u06FF\s]+?)(?=\n|\r|\.|ØŒ|$)/i,
                        /Ø§Ù„Ù…Ø±Ø­ÙˆÙ…\s+([\u0600-\u06FF\s]+)/i
                    ];
                    
                    for (const pattern of deceasedPatterns) {
                        const match = text.match(pattern);
                        if (match && match[1]) {
                            const deceasedName = match[1].trim();
                            data.deceased.name = deceasedName;
                            console.log("Ø§Ø³Ù… Ø§Ù„Ù…ØªÙˆÙÙ‰ Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬:", deceasedName);
                            
                            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù‡ÙˆÙŠØ© Ø§Ù„Ù…ØªÙˆÙÙ‰ Ø¨Ø§Ù„Ù‚Ø±Ø¨ Ù…Ù† Ø§Ø³Ù…Ù‡
                            const searchArea = text.substring(Math.max(0, text.indexOf(match[0]) - 100), 
                                                             Math.min(text.length, text.indexOf(match[0]) + 200));
                            const idMatch = searchArea.match(/\d{10}/);
                            if (idMatch) {
                                data.deceased.id = idMatch[0];
                                console.log("Ù‡ÙˆÙŠØ© Ø§Ù„Ù…ØªÙˆÙÙ‰:", data.deceased.id);
                            }
                            break;
                        }
                    }

                    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ±Ø«Ø© - Ø¹Ø¯Ø© Ø£Ù†Ù…Ø§Ø·
                    const heirsSectionPatterns = [
                        /Ø§Ù„ÙˆØ±Ø«Ø©[\s\S]*?(?=\n\s*\n|Ø§Ù„ØªØ§Ø±ÙŠØ®|Ø§Ù„Ø®Ø§ØªÙ…|Ø´ÙƒØ±|$)/i,
                        /Ø§Ù„Ø£Ø³Ù…Ø§Ø¡[\s\S]*?(?=\n\s*\n|Ø§Ù„ØªØ§Ø±ÙŠØ®|Ø§Ù„Ø®Ø§ØªÙ…|Ø´ÙƒØ±|$)/i,
                        /Ø¨Ù†[Ø§Ø©Øª]?\s+[\u0600-\u06FF]+[\s\S]*?(?=\n\s*\n|Ø§Ù„ØªØ§Ø±ÙŠØ®|Ø§Ù„Ø®Ø§ØªÙ…|Ø´ÙƒØ±|$)/i,
                        /Ø°ÙƒÙˆØ±[\s\S]*?(?=\n\s*\n|Ø¥Ù†Ø§Ø«|$)/i,
                        /Ø¥Ù†Ø§Ø«[\s\S]*?(?=\n\s*\n|$)/i
                    ];
                    
                    let heirsSection = '';
                    for (const pattern of heirsSectionPatterns) {
                        const match = text.match(pattern);
                        if (match && match[0].length > 20) {
                            heirsSection = match[0];
                            console.log("ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‚Ø³Ù… Ø§Ù„ÙˆØ±Ø«Ø©");
                            break;
                        }
                    }

                    // Ø¥Ø°Ø§ Ù„Ù… Ù†Ø¬Ø¯ Ù‚Ø³Ù… Ù…Ø­Ø¯Ø¯ØŒ Ù†Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù†Øµ ÙƒÙ„Ù‡
                    if (!heirsSection) {
                        heirsSection = text;
                    }

                    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¬Ù…ÙŠØ¹ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù‡ÙˆÙŠØ© ÙÙŠ Ø§Ù„Ù‚Ø³Ù…
                    const heirIds = this.extractIDNumbers(heirsSection);
                    
                    // Ù„ÙƒÙ„ Ø±Ù‚Ù… Ù‡ÙˆÙŠØ©ØŒ Ù†Ø­Ø§ÙˆÙ„ Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø³Ù… ÙˆØ¹Ù„Ø§Ù‚Ø© Ø§Ù„Ù‚Ø±Ø§Ø¨Ø©
                    heirIds.forEach(id => {
                        if (id === data.deceased.id) return; // ØªØ®Ø·ÙŠ Ø§Ù„Ù…ØªÙˆÙÙ‰
                        
                        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø§Ø³Ù… Ø­ÙˆÙ„ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©
                        const idIndex = heirsSection.indexOf(id);
                        const start = Math.max(0, idIndex - 100);
                        const end = Math.min(heirsSection.length, idIndex + 100);
                        const context = heirsSection.substring(start, end);
                        
                        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ù…Ù† Ø§Ù„Ø³ÙŠØ§Ù‚
                        const nameMatches = context.match(/[\u0600-\u06FF]{2,}(?:\s+[\u0600-\u06FF]{2,}){1,3}/g);
                        let name = 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                        if (nameMatches && nameMatches.length > 0) {
                            // Ù†Ø£Ø®Ø° Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£Ø·ÙˆÙ„ Ø¹Ø§Ø¯Ø© (Ø§Ù„Ø£ÙƒØ«Ø± Ø§ÙƒØªÙ…Ø§Ù„Ø§Ù‹)
                            nameMatches.sort((a, b) => b.length - a.length);
                            name = nameMatches[0].trim();
                        }
                        
                        // ØªØ­Ø¯ÙŠØ¯ Ø¹Ù„Ø§Ù‚Ø© Ø§Ù„Ù‚Ø±Ø§Ø¨Ø©
                        let relation = 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                        const relationPatterns = [
                            { pattern: /Ø§Ø¨Ù†|ÙˆÙ„Ø¯|Ø§Ù„Ø§Ø¨Ù†/i, relation: 'Ø§Ø¨Ù†' },
                            { pattern: /Ø§Ø¨Ù†Ø©|Ø¨Ù†Øª|Ø§Ù„Ø§Ø¨Ù†Ø©/i, relation: 'Ø§Ø¨Ù†Ø©' },
                            { pattern: /Ø²ÙˆØ¬/i, relation: 'Ø²ÙˆØ¬' },
                            { pattern: /Ø²ÙˆØ¬Ø©/i, relation: 'Ø²ÙˆØ¬Ø©' },
                            { pattern: /Ø£Ø¨|ÙˆØ§Ù„Ø¯/i, relation: 'Ø£Ø¨' },
                            { pattern: /Ø£Ù…|ÙˆØ§Ù„Ø¯Ø©/i, relation: 'Ø£Ù…' },
                            { pattern: /Ø£Ø®/i, relation: 'Ø£Ø®' },
                            { pattern: /Ø£Ø®Øª/i, relation: 'Ø£Ø®Øª' },
                            { pattern: /Ø¬Ø¯/i, relation: 'Ø¬Ø¯' },
                            { pattern: /Ø¬Ø¯Ø©/i, relation: 'Ø¬Ø¯Ø©' },
                            { pattern: /Ø¹Ù…/i, relation: 'Ø¹Ù…' },
                            { pattern: /Ø¹Ù…Ø©/i, relation: 'Ø¹Ù…Ø©' },
                            { pattern: /Ø®Ø§Ù„/i, relation: 'Ø®Ø§Ù„' },
                            { pattern: /Ø®Ø§Ù„Ø©/i, relation: 'Ø®Ø§Ù„Ø©' }
                        ];
                        
                        for (const rel of relationPatterns) {
                            if (rel.pattern.test(context)) {
                                relation = rel.relation;
                                break;
                            }
                        }
                        
                        // ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø±
                        if (!data.heirs.some(heir => heir.id === id)) {
                            data.heirs.push({
                                name: name,
                                id: id,
                                relation: relation
                            });
                        }
                    });

                    // Ø¥Ø°Ø§ Ù„Ù… Ù†Ø¹Ø«Ø± Ø¹Ù„Ù‰ ÙˆØ±Ø«Ø© Ø¨Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©ØŒ Ù†Ø­Ø§ÙˆÙ„ Ø·Ø±ÙŠÙ‚Ø© Ø¨Ø¯ÙŠÙ„Ø©
                    if (data.heirs.length === 0) {
                        console.log("Ù…Ø­Ø§ÙˆÙ„Ø© Ø·Ø±ÙŠÙ‚Ø© Ø¨Ø¯ÙŠÙ„Ø© Ù„Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ±Ø«Ø©");
                        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£Ø²ÙˆØ§Ø¬ Ù…Ù† Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ÙˆØ£Ø±Ù‚Ø§Ù… Ø§Ù„Ù‡ÙˆÙŠØ©
                        const lines = text.split('\n').filter(line => line.trim().length > 0);
                        lines.forEach(line => {
                            const idMatch = line.match(/\d{10}/);
                            if (idMatch && idMatch[0] !== data.deceased.id) {
                                const nameMatch = line.match(/[\u0600-\u06FF]{2,}(?:\s+[\u0600-\u06FF]{2,}){1,3}/);
                                if (nameMatch) {
                                    data.heirs.push({
                                        name: nameMatch[0].trim(),
                                        id: idMatch[0],
                                        relation: 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'
                                    });
                                }
                            }
                        });
                    }

                    console.log("Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ±Ø«Ø© Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬ÙŠÙ†:", data.heirs.length);
                    return data;
                } catch (error) {
                    console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ ØµÙƒ Ø­ØµØ± Ø§Ù„ÙˆØ±Ø«Ø©:", error);
                    return data;
                }
            }

            parsePowerOfAttorney(text) {
                console.log("Ø¨Ø¯Ø¡ ØªØ­Ù„ÙŠÙ„ ØµÙƒ Ø§Ù„ÙˆÙƒØ§Ù„Ø©");
                const data = {
                    principals: [],
                    agent: { name: null, id: null },
                    documentNumber: null,
                    deceasedName: null,
                    heirsCertificateNumber: null,
                    rawText: text,
                    hasFinancialAuthority: false
                };

                try {
                    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚
                    const docNumbers = this.extractDocumentNumbers(text);
                    if (docNumbers.length > 0) {
                        data.documentNumber = docNumbers[0];
                        console.log("Ø±Ù‚Ù… ØµÙƒ Ø§Ù„ÙˆÙƒØ§Ù„Ø©:", data.documentNumber);
                    }

                    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù‡ÙˆÙŠØ©
                    const ids = this.extractIDNumbers(text);
                    console.log("Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù‡ÙˆÙŠØ© ÙÙŠ Ø§Ù„ÙˆÙƒØ§Ù„Ø©:", ids);
                    
                    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡
                    const names = this.extractArabicNames(text);

                    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…ÙˆÙƒÙ„ÙŠÙ†
                    const principalPatterns = [
                        /Ø§Ù„Ù…ÙˆÙƒÙ„[ÙˆÙ†]?\s*[:Ø›]\s*([^\n\r]+)/gi,
                        /Ù†Ø­Ù†\s*([^:]+?)(?=\s*\n|ÙˆÙƒÙ„Ù†Ø§|Ø¨ØªØ§Ø±ÙŠØ®|$)/gi,
                        /Ø£Ù†Ø§\s*([^:]+?)(?=\s*\n|ÙˆÙƒÙ„Øª|Ø¨ØªØ§Ø±ÙŠØ®|$)/gi,
                        /Ø§Ù„Ø³Ø§Ø¯Ø©\s*([^:]+?)(?=\s*\n|Ø¨ØªØ§Ø±ÙŠØ®|$)/gi
                    ];
                    
                    let foundPrincipals = false;
                    
                    for (const pattern of principalPatterns) {
                        const matches = [...text.matchAll(pattern)];
                        if (matches.length > 0) {
                            matches.forEach(match => {
                                const section = match[0];
                                const sectionIds = this.extractIDNumbers(section);
                                const sectionNames = this.extractArabicNames(section);
                                
                                sectionIds.forEach((id, index) => {
                                    const name = sectionNames[index] || match[1] || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                                    if (!data.principals.some(p => p.id === id)) {
                                        data.principals.push({
                                            name: name.trim(),
                                            id: id
                                        });
                                    }
                                });
                                
                                // Ø¥Ø°Ø§ Ù„Ù… Ù†Ø¬Ø¯ Ø£Ø±Ù‚Ø§Ù… Ù‡ÙˆÙŠØ©ØŒ Ù†Ø­Ø§ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø§Ø³Ù… ÙÙ‚Ø·
                                if (sectionIds.length === 0 && match[1]) {
                                    const name = match[1].trim();
                                    if (name.length > 3) {
                                        data.principals.push({
                                            name: name,
                                            id: null
                                        });
                                    }
                                }
                            });
                            foundPrincipals = true;
                            break;
                        }
                    }

                    // Ø·Ø±ÙŠÙ‚Ø© Ø¨Ø¯ÙŠÙ„Ø©: Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙˆØ±Ø¨Ø·Ù‡Ø§ Ø¨Ø£Ù‚Ø±Ø¨ Ø§Ø³Ù…
                    if (!foundPrincipals || data.principals.length === 0) {
                        console.log("Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø·Ø±ÙŠÙ‚Ø© Ø¨Ø¯ÙŠÙ„Ø© Ù„Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙƒÙ„ÙŠÙ†");
                        ids.forEach(id => {
                            // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø­ÙˆÙ„ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©
                            const idIndex = text.indexOf(id);
                            if (idIndex === -1) return;
                            
                            const start = Math.max(0, idIndex - 150);
                            const end = Math.min(text.length, idIndex + 50);
                            const context = text.substring(start, end);
                            
                            // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ù…Ù† Ø§Ù„Ø³ÙŠØ§Ù‚
                            const nameMatches = context.match(/[\u0600-\u06FF]{2,}(?:\s+[\u0600-\u06FF]{2,}){1,3}/g);
                            let name = 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                            if (nameMatches && nameMatches.length > 0) {
                                nameMatches.sort((a, b) => {
                                    // Ù†ÙØ¶Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø°ÙŠ ÙŠØ¸Ù‡Ø± Ù‚Ø¨Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©
                                    const aIndex = context.indexOf(a);
                                    const bIndex = context.indexOf(b);
                                    return aIndex - bIndex;
                                });
                                name = nameMatches[0].trim();
                            }
                            
                            // ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø± ÙˆØ¹Ø¯Ù… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆÙƒÙŠÙ„ ÙƒÙ…ÙˆÙƒÙ„
                            if (!data.principals.some(p => p.id === id) && 
                                (!data.agent.id || data.agent.id !== id)) {
                                data.principals.push({
                                    name: name,
                                    id: id
                                });
                            }
                        });
                    }

                    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆÙƒÙŠÙ„
                    const agentPatterns = [
                        /Ø§Ù„ÙˆÙƒÙŠÙ„\s*[:Ø›]\s*([^\n\r]+)/i,
                        /ÙˆÙƒÙ„[Ù†Ø§]\s+([^:]+?)(?=\s*Ø¨Ø¹Ù†ÙˆØ§Ù†|Ø¨ØªØ§Ø±ÙŠØ®|$)/i,
                        /ÙŠÙ…Ø«Ù„Ù†Ø§\s+([^:]+?)(?=\s*Ø¨Ø¹Ù†ÙˆØ§Ù†|Ø¨ØªØ§Ø±ÙŠØ®|$)/i,
                        /Ù†Ø§Ø¦Ø¨[Ø§\s]*Ø¹Ù†[Ø§\s]+([^:]+?)(?=\s*Ø¨Ø¹Ù†ÙˆØ§Ù†|Ø¨ØªØ§Ø±ÙŠØ®|$)/i
                    ];
                    
                    for (const pattern of agentPatterns) {
                        const match = text.match(pattern);
                        if (match && match[1]) {
                            const agentName = match[1].trim();
                            data.agent.name = agentName;
                            console.log("Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„:", agentName);
                            
                            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù‡ÙˆÙŠØ© Ø§Ù„ÙˆÙƒÙŠÙ„
                            const searchArea = text.substring(Math.max(0, text.indexOf(match[0]) - 100), 
                                                             Math.min(text.length, text.indexOf(match[0]) + 200));
                            const idMatch = searchArea.match(/\d{10}/);
                            if (idMatch) {
                                data.agent.id = idMatch[0];
                                console.log("Ù‡ÙˆÙŠØ© Ø§Ù„ÙˆÙƒÙŠÙ„:", data.agent.id);
                            }
                            break;
                        }
                    }

                    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù… Ø§Ù„Ù…ØªÙˆÙÙ‰ ÙÙŠ Ø§Ù„ÙˆÙƒØ§Ù„Ø©
                    const deceasedInPOAPatterns = [
                        /Ø§Ù„ØªØ±ÙƒØ©\s*Ø§Ù„Ø¹Ø§Ø¦Ø¯Ø©\s*Ù…Ù†\s*([\u0600-\u06FF\s]+)/i,
                        /Ø§Ù„Ø¥Ø±Ø«\s*Ø§Ù„Ø®Ø§Øµ\s*Ø¨\s*([\u0600-\u06FF\s]+)/i,
                        /Ø§Ù„Ù…ØªÙˆÙ[ÙŠÙ‰]\s*([\u0600-\u06FF\s]+)/i,
                        /Ø§Ù„Ù…Ø±Ø­ÙˆÙ…\s*([\u0600-\u06FF\s]+)/i,
                        /ØªØ±ÙƒØ©\s*([\u0600-\u06FF\s]+)/i
                    ];
                    
                    for (const pattern of deceasedInPOAPatterns) {
                        const match = text.match(pattern);
                        if (match && match[1]) {
                            data.deceasedName = match[1].trim();
                            console.log("Ø§Ø³Ù… Ø§Ù„Ù…ØªÙˆÙÙ‰ ÙÙŠ Ø§Ù„ÙˆÙƒØ§Ù„Ø©:", data.deceasedName);
                            break;
                        }
                    }

                    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø±Ù‚Ù… ØµÙƒ Ø­ØµØ± Ø§Ù„ÙˆØ±Ø«Ø© ÙÙŠ Ø§Ù„ÙˆÙƒØ§Ù„Ø©
                    const heirsCertPatterns = [
                        /ØµÙƒ\s*Ø­ØµØ±\s*ÙˆØ±Ø«Ø©\s*Ø±Ù‚Ù…\s*(\d+)/i,
                        /Ø±Ù‚Ù…\s*ØµÙƒ\s*Ø§Ù„Ø­ØµØ±\s*(\d+)/i,
                        /Ø­ØµØ±\s*ÙˆØ±Ø«Ø©\s*Ø±Ù‚Ù…\s*(\d+)/i,
                        /ØµÙƒ\s*Ø§Ù„ÙˆØ±Ø«Ø©\s*Ø±Ù‚Ù…\s*(\d+)/i,
                        /ÙˆØ±Ù‚Ø©\s*Ø­ØµØ±\s*Ø§Ù„ÙˆØ±Ø«Ø©\s*Ø±Ù‚Ù…\s*(\d+)/i
                    ];
                    
                    for (const pattern of heirsCertPatterns) {
                        const match = text.match(pattern);
                        if (match && match[1]) {
                            data.heirsCertificateNumber = match[1];
                            console.log("Ø±Ù‚Ù… ØµÙƒ Ø§Ù„Ø­ØµØ± ÙÙŠ Ø§Ù„ÙˆÙƒØ§Ù„Ø©:", data.heirsCertificateNumber);
                            break;
                        }
                    }

                    // Ø¥Ø°Ø§ Ù„Ù… Ù†Ø¬Ø¯ Ø¨Ø§Ù„Ù†Ù…Ø·ØŒ Ù†Ø¨Ø­Ø« Ø¹Ù† Ø£ÙŠ Ø±Ù‚Ù… ÙˆØ«ÙŠÙ‚Ø© Ù…Ø°ÙƒÙˆØ±
                    if (!data.heirsCertificateNumber && data.documentNumber) {
                        // Ù†Ø¨Ø­Ø« Ø¹Ù† Ø£ÙŠ Ø°ÙƒØ± Ù„Ø±Ù‚Ù… ÙˆØ«ÙŠÙ‚Ø© ÙÙŠ Ø³ÙŠØ§Ù‚ Ø§Ù„Ø¥Ø±Ø«
                        const inheritanceContext = text.toLowerCase();
                        if (inheritanceContext.includes('Ø­ØµØ±') || inheritanceContext.includes('ÙˆØ±Ø«Ø©') || inheritanceContext.includes('Ø¥Ø±Ø«')) {
                            const numbers = this.extractDocumentNumbers(text);
                            if (numbers.length > 1) {
                                // Ù†Ø£Ø®Ø° Ø«Ø§Ù†ÙŠ Ø±Ù‚Ù… (ØºØ§Ù„Ø¨Ø§Ù‹ ÙŠÙƒÙˆÙ† Ø±Ù‚Ù… ØµÙƒ Ø§Ù„Ø­ØµØ±)
                                data.heirsCertificateNumber = numbers[1];
                            }
                        }
                    }

                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©
                    const financialKeywords = ['Ø¨ÙŠØ¹', 'Ø¥ÙØ±Ø§Øº', 'Ø§Ø³ØªÙ„Ø§Ù…', 'Ù…Ø¨Ù„Øº', 'Ø«Ù…Ù†', 'Ø³Ø¹Ø±', 'ØªØ­ØµÙŠÙ„', 'ØªÙ†Ø§Ø²Ù„', 'ØªØ³Ø¬ÙŠÙ„', 'Ù‚Ø¨Ø¶', 'Ù†Ù‚Ù„', 'ØªØµØ±Ù'];
                    data.hasFinancialAuthority = financialKeywords.some(keyword => 
                        text.includes(keyword)
                    );

                    console.log("Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆÙƒÙ„ÙŠÙ† Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬ÙŠÙ†:", data.principals.length);
                    console.log("ØµÙ„Ø§Ø­ÙŠØ§Øª Ù…Ø§Ù„ÙŠØ©:", data.hasFinancialAuthority);
                    
                    return data;
                } catch (error) {
                    console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ ØµÙƒ Ø§Ù„ÙˆÙƒØ§Ù„Ø©:", error);
                    return data;
                }
            }
        }

        class DataMatcher {
            constructor() {
                this.results = {
                    heirsMatch: {
                        complete: false,
                        missingHeirs: [],
                        matchedHeirs: [],
                        totalHeirs: 0
                    },
                    scopeValidation: {
                        certificateMatch: false,
                        deceasedNameMatch: false,
                        details: []
                    },
                    agentValidation: {
                        isHeir: false,
                        hasFinancialAuthority: false,
                        details: []
                    },
                    summary: ''
                };
            }

            matchHeirs(heirsData, poaData) {
                console.log("Ø¨Ø¯Ø¡ Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„ÙˆØ±Ø«Ø©");
                
                if (!heirsData || !poaData) {
                    console.error("Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ÙƒØ§ÙÙŠØ© Ù„Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©");
                    return this.results.heirsMatch;
                }
                
                const heirsIds = heirsData.heirs.map(heir => heir.id);
                const principalIds = poaData.principals.map(principal => principal.id).filter(id => id);
                
                console.log("Ø£Ø±Ù‚Ø§Ù… Ù‡ÙˆÙŠØ© Ø§Ù„ÙˆØ±Ø«Ø©:", heirsIds);
                console.log("Ø£Ø±Ù‚Ø§Ù… Ù‡ÙˆÙŠØ© Ø§Ù„Ù…ÙˆÙƒÙ„ÙŠÙ†:", principalIds);
                
                // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ±Ø«Ø© Ø§Ù„Ù…ÙÙ‚ÙˆØ¯ÙŠÙ†
                this.results.heirsMatch.missingHeirs = heirsData.heirs.filter(heir => 
                    !principalIds.includes(heir.id)
                );
                
                // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ±Ø«Ø© Ø§Ù„Ù…ØªØ·Ø§Ø¨Ù‚ÙŠÙ†
                this.results.heirsMatch.matchedHeirs = heirsData.heirs.filter(heir => 
                    principalIds.includes(heir.id)
                );
                
                this.results.heirsMatch.totalHeirs = heirsData.heirs.length;
                this.results.heirsMatch.complete = this.results.heirsMatch.missingHeirs.length === 0;
                
                console.log("Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ±Ø«Ø© Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚ÙŠÙ†:", this.results.heirsMatch.matchedHeirs.length);
                console.log("Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ±Ø«Ø© Ø§Ù„Ù…ÙÙ‚ÙˆØ¯ÙŠÙ†:", this.results.heirsMatch.missingHeirs.length);
                console.log("Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© ÙƒØ§Ù…Ù„Ø©:", this.results.heirsMatch.complete);
                
                return this.results.heirsMatch;
            }

            validateScope(heirsData, poaData) {
                console.log("Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù†Ø·Ø§Ù‚");
                const details = [];
                
                // Ù…Ø·Ø§Ø¨Ù‚Ø© Ø±Ù‚Ù… ØµÙƒ Ø­ØµØ± Ø§Ù„ÙˆØ±Ø«Ø©
                if (heirsData.documentNumber && poaData.heirsCertificateNumber) {
                    const certMatch = heirsData.documentNumber === poaData.heirsCertificateNumber;
                    this.results.scopeValidation.certificateMatch = certMatch;
                    
                    details.push({
                        type: 'certificate',
                        label: 'Ù…Ø·Ø§Ø¨Ù‚Ø© Ø±Ù‚Ù… ØµÙƒ Ø§Ù„Ø­ØµØ±',
                        status: certMatch ? 'success' : 'error',
                        message: certMatch 
                            ? `âœ… Ø§Ù„Ø±Ù‚Ù… ${heirsData.documentNumber} Ù…ØªØ·Ø§Ø¨Ù‚`
                            : `âŒ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø© (ØµÙƒ Ø§Ù„Ø­ØµØ±: ${heirsData.documentNumber} â‰  Ø§Ù„ÙˆÙƒØ§Ù„Ø©: ${poaData.heirsCertificateNumber})`
                    });
                } else {
                    details.push({
                        type: 'certificate',
                        label: 'Ù…Ø·Ø§Ø¨Ù‚Ø© Ø±Ù‚Ù… ØµÙƒ Ø§Ù„Ø­ØµØ±',
                        status: 'warning',
                        message: heirsData.documentNumber 
                            ? `âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø±Ù‚Ù… ØµÙƒ Ø§Ù„Ø­ØµØ± ÙÙŠ Ø§Ù„ÙˆÙƒØ§Ù„Ø© (Ø±Ù‚Ù… Ø§Ù„ØµÙƒ: ${heirsData.documentNumber})`
                            : 'âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø±Ù‚Ù… ØµÙƒ Ø§Ù„Ø­ØµØ±'
                    });
                }
                
                // Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ø³Ù… Ø§Ù„Ù…ØªÙˆÙÙ‰
                if (heirsData.deceased.name && poaData.deceasedName) {
                    const nameMatch = this.normalizeName(heirsData.deceased.name) === 
                                    this.normalizeName(poaData.deceasedName);
                    this.results.scopeValidation.deceasedNameMatch = nameMatch;
                    
                    details.push({
                        type: 'deceased',
                        label: 'Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ø³Ù… Ø§Ù„Ù…ØªÙˆÙÙ‰',
                        status: nameMatch ? 'success' : 'error',
                        message: nameMatch 
                            ? `âœ… Ø§Ù„Ø§Ø³Ù… "${heirsData.deceased.name}" Ù…ØªØ·Ø§Ø¨Ù‚`
                            : `âŒ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø© (ØµÙƒ Ø§Ù„Ø­ØµØ±: "${heirsData.deceased.name}" â‰  Ø§Ù„ÙˆÙƒØ§Ù„Ø©: "${poaData.deceasedName}")`
                    });
                } else {
                    details.push({
                        type: 'deceased',
                        label: 'Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ø³Ù… Ø§Ù„Ù…ØªÙˆÙÙ‰',
                        status: 'warning',
                        message: heirsData.deceased.name 
                            ? `âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ù…ØªÙˆÙÙ‰ ÙÙŠ Ø§Ù„ÙˆÙƒØ§Ù„Ø© (Ø§Ù„Ø§Ø³Ù…: ${heirsData.deceased.name})`
                            : 'âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ù…ØªÙˆÙÙ‰ ÙÙŠ ØµÙƒ Ø§Ù„Ø­ØµØ±'
                    });
                }
                
                this.results.scopeValidation.details = details;
                return this.results.scopeValidation;
            }

            validateAgent(heirsData, poaData) {
                console.log("Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆÙƒÙŠÙ„");
                const details = [];
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙˆÙƒÙŠÙ„ Ù…Ù† Ø§Ù„ÙˆØ±Ø«Ø©
                if (poaData.agent.id) {
                    const isHeir = heirsData.heirs.some(heir => heir.id === poaData.agent.id);
                    this.results.agentValidation.isHeir = isHeir;
                    
                    details.push({
                        type: 'agent_identity',
                        label: 'Ù‡ÙˆÙŠØ© Ø§Ù„ÙˆÙƒÙŠÙ„',
                        status: isHeir ? 'success' : 'info',
                        message: isHeir 
                            ? `âœ… Ø§Ù„ÙˆÙƒÙŠÙ„ ${poaData.agent.name || ''} Ù‡Ùˆ Ø£Ø­Ø¯ Ø§Ù„ÙˆØ±Ø«Ø©`
                            : `â„¹ï¸ Ø§Ù„ÙˆÙƒÙŠÙ„ ${poaData.agent.name || ''} Ù„ÙŠØ³ Ù…Ù† Ø§Ù„ÙˆØ±Ø«Ø©`
                    });
                } else {
                    details.push({
                        type: 'agent_identity',
                        label: 'Ù‡ÙˆÙŠØ© Ø§Ù„ÙˆÙƒÙŠÙ„',
                        status: 'warning',
                        message: poaData.agent.name 
                            ? `âš ï¸ Ø§Ù„ÙˆÙƒÙŠÙ„ ${poaData.agent.name} - Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ù‡ÙˆÙŠØªÙ‡`
                            : 'âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆÙƒÙŠÙ„'
                    });
                }
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©
                this.results.agentValidation.hasFinancialAuthority = poaData.hasFinancialAuthority;
                
                details.push({
                    type: 'financial_authority',
                    label: 'Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©',
                    status: poaData.hasFinancialAuthority ? 'success' : 'warning',
                    message: poaData.hasFinancialAuthority 
                        ? 'âœ… Ø§Ù„ÙˆÙƒØ§Ù„Ø© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ØµÙ„Ø§Ø­ÙŠØ§Øª Ù…Ø§Ù„ÙŠØ© (Ø¨ÙŠØ¹ØŒ Ø¥ÙØ±Ø§ØºØŒ Ø§Ø³ØªÙ„Ø§Ù…ØŒ Ø¥Ù„Ø®)'
                        : 'âš ï¸ Ø§Ù„ÙˆÙƒØ§Ù„Ø© Ù‚Ø¯ Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ØµÙ„Ø§Ø­ÙŠØ§Øª Ù…Ø§Ù„ÙŠØ© ÙƒØ§Ù…Ù„Ø© (ÙŠÙØ¶Ù„ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©)'
                });
                
                this.results.agentValidation.details = details;
                return this.results.agentValidation;
            }

            generateSummary(heirsData, poaData) {
                const missingCount = this.results.heirsMatch.missingHeirs.length;
                const totalHeirs = this.results.heirsMatch.totalHeirs;
                const matchedCount = totalHeirs - missingCount;
                
                let summary = '';
                
                if (totalHeirs === 0) {
                    summary = 'âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙˆØ±Ø«Ø© ÙÙŠ ØµÙƒ Ø§Ù„Ø­ØµØ±';
                } else if (this.results.heirsMatch.complete) {
                    summary = `âœ… ØªÙ… ØªÙˆÙƒÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ±Ø«Ø© (${totalHeirs} ÙˆØ§Ø±Ø«)`;
                } else {
                    summary = `âš ï¸ ÙŠÙˆØ¬Ø¯ ${missingCount} ÙˆØ±Ø«Ø© Ù„Ù… ÙŠÙˆÙ‚Ø¹ÙˆØ§ Ø§Ù„ÙˆÙƒØ§Ù„Ø©`;
                }
                
                if (totalHeirs > 0) {
                    summary += `\nğŸ“Š ${matchedCount}/${totalHeirs} ÙˆØ§Ø±Ø« ØªÙ… ØªÙˆÙƒÙŠÙ„Ù‡Ù…`;
                }
                
                if (this.results.scopeValidation.certificateMatch && heirsData.deceased.name) {
                    summary += `\nğŸ”— ØµÙƒ Ø§Ù„ÙˆÙƒØ§Ù„Ø© Ù…Ø±ØªØ¨Ø· Ø¨Ø§Ù„Ù…ØªÙˆÙÙ‰ ${heirsData.deceased.name}`;
                    summary += `\nğŸ“„ Ù…Ø±ØªØ¨Ø· Ø¨ØµÙƒ Ø§Ù„Ø­ØµØ± Ø±Ù‚Ù… ${heirsData.documentNumber || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"}`;
                } else {
                    summary += `\nâš ï¸ ØªÙ†Ø¨ÙŠÙ‡: Ù‡Ù†Ø§Ùƒ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø±Ø¨Ø· Ø§Ù„ØµÙƒÙˆÙƒ`;
                }
                
                this.results.summary = summary;
                return summary;
            }

            normalizeName(name) {
                if (!name) return '';
                return name
                    .replace(/[Ø¥Ø£Ø¢Ø§]/g, 'Ø§')
                    .replace(/Ø©/g, 'Ù‡')
                    .replace(/Ù‰/g, 'ÙŠ')
                    .replace(/Ø¦/g, 'ÙŠ')
                    .replace(/Ø¤/g, 'Ùˆ')
                    .replace(/[^Ø§-ÙŠ\s]/g, '')
                    .replace(/\s+/g, ' ')
                    .trim()
                    .toLowerCase();
            }

            getAllResults() {
                return this.results;
            }
        }

        // ==================== Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ© ====================
        
        let pdfParser = new PDFParser();
        let dataMatcher = new DataMatcher();
        let heirsData = null;
        let poaData = null;
        let isProcessing = false;

        // ==================== Ø¯ÙˆØ§Ù„ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„ÙØ§Øª ====================

        async function handleFileUpload(inputElement, infoDivId) {
            const file = inputElement.files[0];
            const infoDiv = document.getElementById(infoDivId);
            const progressBar = document.getElementById(infoDivId.replace('Info', 'Progress'));
            
            if (!file) {
                infoDiv.innerHTML = '<div class="alert alert-warning">âŒ Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù</div>';
                updateProcessButton();
                return;
            }
            
            if (!file.type.includes('pdf') && !file.name.toLowerCase().endsWith('.pdf')) {
                infoDiv.innerHTML = '<div class="alert alert-danger">âŒ Ø§Ù„Ù…Ù„Ù ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù…Ù† Ù†ÙˆØ¹ PDF</div>';
                inputElement.value = '';
                updateProcessButton();
                return;
            }
            
            if (file.size > 10 * 1024 * 1024) { // 10 MB
                infoDiv.innerHTML = '<div class="alert alert-danger">âŒ Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹ (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 10 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª)</div>';
                inputElement.value = '';
                updateProcessButton();
                return;
            }
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
            progressBar.classList.remove('hidden');
            const progressFill = progressBar.querySelector('.progress-fill');
            progressFill.style.width = '0%';
            
            infoDiv.innerHTML = `<div class="alert alert-info">
                <span class="loading"></span> Ø¬Ø§Ø±ÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù: ${file.name} (${(file.size/1024).toFixed(1)} KB)
            </div>`;
            
            try {
                const text = await pdfParser.extractTextFromPDF(file, (progress) => {
                    progressFill.style.width = `${progress}%`;
                });
                
                // Ø¥Ø®ÙØ§Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
                setTimeout(() => {
                    progressBar.classList.add('hidden');
                }, 500);
                
                if (infoDivId === 'heirsInfo') {
                    heirsData = pdfParser.parseHeirsCertificate(text);
                    displayRawData('heirsRawData', heirsData);
                    infoDiv.innerHTML = `<div class="alert alert-success">
                        âœ… ØªÙ… ØªØ­Ù„ÙŠÙ„ ØµÙƒ Ø­ØµØ± Ø§Ù„ÙˆØ±Ø«Ø© Ø¨Ù†Ø¬Ø§Ø­
                        <br><small>ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${heirsData.heirs.length} ÙˆØ§Ø±Ø«</small>
                    </div>`;
                } else if (infoDivId === 'poaInfo') {
                    poaData = pdfParser.parsePowerOfAttorney(text);
                    displayRawData('poaRawData', poaData);
                    infoDiv.innerHTML = `<div class="alert alert-success">
                        âœ… ØªÙ… ØªØ­Ù„ÙŠÙ„ ØµÙƒ Ø§Ù„ÙˆÙƒØ§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­
                        <br><small>ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${poaData.principals.length} Ù…ÙˆÙƒÙ„</small>
                    </div>`;
                }
                
                updateProcessButton();
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù:', error);
                progressBar.classList.add('hidden');
                infoDiv.innerHTML = `<div class="alert alert-danger">
                    âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù PDF
                    <br><small>${error.message || 'ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…Ø­Ù…ÙŠ Ø¨ÙƒÙ„Ù…Ø© Ø³Ø±'}</small>
                </div>`;
                inputElement.value = '';
                updateProcessButton();
            }
        }

        function displayRawData(elementId, data) {
            const element = document.getElementById(elementId);
            if (element && data) {
                // Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù†Ø¸Ù…Ø©
                let formattedData = '';
                
                if (elementId === 'heirsRawData') {
                    formattedData = `ğŸ“‹ ØµÙƒ Ø­ØµØ± Ø§Ù„ÙˆØ±Ø«Ø©\n`;
                    formattedData += `========================\n`;
                    formattedData += `Ø§Ù„Ù…ØªÙˆÙÙ‰: ${data.deceased.name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}\n`;
                    formattedData += `Ø±Ù‚Ù… Ù‡ÙˆÙŠØ© Ø§Ù„Ù…ØªÙˆÙÙ‰: ${data.deceased.id || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}\n`;
                    formattedData += `Ø±Ù‚Ù… Ø§Ù„ØµÙƒ: ${data.documentNumber || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}\n`;
                    formattedData += `\nÙ‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙˆØ±Ø«Ø© (${data.heirs.length}):\n`;
                    data.heirs.forEach((heir, index) => {
                        formattedData += `${index + 1}. ${heir.name} (${heir.id}) - ${heir.relation}\n`;
                    });
                } else if (elementId === 'poaRawData') {
                    formattedData = `ğŸ“‹ ØµÙƒ Ø§Ù„ÙˆÙƒØ§Ù„Ø©\n`;
                    formattedData += `========================\n`;
                    formattedData += `Ø±Ù‚Ù… Ø§Ù„ØµÙƒ: ${data.documentNumber || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}\n`;
                    formattedData += `Ø§Ù„ÙˆÙƒÙŠÙ„: ${data.agent.name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'} (${data.agent.id || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'})\n`;
                    formattedData += `Ø§Ø³Ù… Ø§Ù„Ù…ØªÙˆÙÙ‰ ÙÙŠ Ø§Ù„ÙˆÙƒØ§Ù„Ø©: ${data.deceasedName || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}\n`;
                    formattedData += `Ø±Ù‚Ù… ØµÙƒ Ø§Ù„Ø­ØµØ± ÙÙŠ Ø§Ù„ÙˆÙƒØ§Ù„Ø©: ${data.heirsCertificateNumber || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}\n`;
                    formattedData += `ØµÙ„Ø§Ø­ÙŠØ§Øª Ù…Ø§Ù„ÙŠØ©: ${data.hasFinancialAuthority ? 'Ù†Ø¹Ù…' : 'Ù„Ø§'}\n`;
                    formattedData += `\nÙ‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆÙƒÙ„ÙŠÙ† (${data.principals.length}):\n`;
                    data.principals.forEach((principal, index) => {
                        formattedData += `${index + 1}. ${principal.name} (${principal.id || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'})\n`;
                    });
                }
                
                element.textContent = formattedData;
            }
        }

        function updateProcessButton() {
            const processBtn = document.getElementById('processBtn');
            const processText = document.getElementById('processText');
            
            if (heirsData && poaData && !isProcessing) {
                processBtn.disabled = false;
                processText.textContent = 'ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚';
            } else if (isProcessing) {
                processBtn.disabled = true;
                processText.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...';
            } else {
                processBtn.disabled = true;
                processText.textContent = heirsData && !poaData 
                    ? 'ğŸ“‹ Ø§Ù†ØªØ¸Ø± Ø±ÙØ¹ ØµÙƒ Ø§Ù„ÙˆÙƒØ§Ù„Ø©' 
                    : !heirsData && poaData 
                    ? 'ğŸ“„ Ø§Ù†ØªØ¸Ø± Ø±ÙØ¹ ØµÙƒ Ø§Ù„Ø­ØµØ±' 
                    : 'ğŸ“ Ø§Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙÙŠÙ† Ø£ÙˆÙ„Ø§Ù‹';
            }
        }

        // ==================== Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ====================

        async function processDocuments() {
            if (!heirsData || !poaData || isProcessing) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙÙŠÙ† Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }
            
            isProcessing = true;
            updateProcessButton();
            
            const processLoading = document.getElementById('processLoading');
            processLoading.classList.remove('hidden');
            
            try {
                // Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©
                dataMatcher.matchHeirs(heirsData, poaData);
                dataMatcher.validateScope(heirsData, poaData);
                dataMatcher.validateAgent(heirsData, poaData);
                dataMatcher.generateSummary(heirsData, poaData);
                
                // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
                displayResults();
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©:', error);
                document.getElementById('summary').innerHTML = `
                    <h3>ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</h3>
                    <div class="alert alert-danger">âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©: ${error.message}</div>
                `;
            } finally {
                isProcessing = false;
                processLoading.classList.add('hidden');
                updateProcessButton();
                
                // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø¥Ù„Ù‰ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
                document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
            }
        }

        function displayResults() {
            const results = dataMatcher.getAllResults();
            
            // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ø®Øµ
            const summaryDiv = document.getElementById('summary');
            summaryDiv.innerHTML = `
                <h3>ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</h3>
                <div style="white-space: pre-line; line-height: 1.8; font-size: 1.1rem;">
                    ${results.summary}
                    ${results.heirsMatch.complete ? 
                        '\nâœ… <strong>Ø§Ù„ÙˆÙƒØ§Ù„Ø© ØµØ§Ù„Ø­Ø© Ù„Ù„Ø¨ÙŠØ¹</strong>' : 
                        '\nâŒ <strong>Ø§Ù„ÙˆÙƒØ§Ù„Ø© Ù†Ø§Ù‚ØµØ© ÙˆÙ„Ø§ ØªØµÙ„Ø­ Ù„Ù„Ø¨ÙŠØ¹</strong>'}
                </div>
            `;
            
            // Ø¹Ø±Ø¶ Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„ÙˆØ±Ø«Ø©
            const heirsMatchDiv = document.getElementById('heirsMatchResult');
            if (results.heirsMatch.totalHeirs === 0) {
                heirsMatchDiv.innerHTML = `
                    <div class="alert alert-warning">
                        âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙˆØ±Ø«Ø© ÙÙŠ ØµÙƒ Ø§Ù„Ø­ØµØ±
                        <br><small>Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø§Ù„Ù…Ù„Ù ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ù…Ø®ØªÙ„Ù</small>
                    </div>
                `;
            } else if (results.heirsMatch.complete) {
                heirsMatchDiv.innerHTML = `
                    <div class="alert alert-success">
                        âœ… ØªÙ… ØªÙˆÙƒÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ±Ø«Ø©
                        <br><small>${results.heirsMatch.matchedHeirs.length} ÙˆØ§Ø±Ø« ØªÙ… ØªÙˆÙƒÙŠÙ„Ù‡Ù…</small>
                    </div>
                `;
            } else {
                const missingList = results.heirsMatch.missingHeirs
                    .map(h => `â€¢ ${h.name} (${h.id}) - ${h.relation}`)
                    .join('<br>');
                
                heirsMatchDiv.innerHTML = `
                    <div class="alert alert-danger">
                        âŒ ÙŠÙˆØ¬Ø¯ ${results.heirsMatch.missingHeirs.length} ÙˆØ±Ø«Ø© Ù„Ù… ÙŠÙˆÙ‚Ø¹ÙˆØ§
                        <br><br>
                        <strong>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙˆØ±Ø«Ø© Ø§Ù„Ù†Ø§Ù‚ØµÙŠÙ†:</strong>
                        <br>${missingList}
                        <br><br>
                        <small>âš ï¸ Ø§Ù„ÙˆÙƒØ§Ù„Ø© Ù†Ø§Ù‚ØµØ© ÙˆÙ„Ø§ ØªØµÙ„Ø­ Ù„Ù„Ø¨ÙŠØ¹</small>
                    </div>
                `;
            }
            
            // Ø¹Ø±Ø¶ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù†Ø·Ø§Ù‚
            const scopeDiv = document.getElementById('scopeValidationResult');
            const scopeDetails = results.scopeValidation.details
                .map(d => {
                    let className = '';
                    if (d.status === 'success') className = 'status-complete';
                    else if (d.status === 'error') className = 'status-incomplete';
                    else if (d.status === 'warning') className = 'alert alert-warning';
                    
                    return `<div class="${className}">${d.message}</div>`;
                })
                .join('');
            scopeDiv.innerHTML = scopeDetails || '<div class="alert alert-warning">âš ï¸ Ù„Ù… ØªØªØ­Ù‚Ù‚ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù†Ø·Ø§Ù‚</div>';
            
            // Ø¹Ø±Ø¶ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆÙƒÙŠÙ„
            const agentDiv = document.getElementById('agentValidationResult');
            const agentDetails = results.agentValidation.details
                .map(d => {
                    let className = '';
                    if (d.status === 'success') className = 'status-complete';
                    else if (d.status === 'info') className = 'alert alert-info';
                    else if (d.status === 'warning') className = 'alert alert-warning';
                    
                    return `<div class="${className}">${d.message}</div>`;
                })
                .join('');
            agentDiv.innerHTML = agentDetails || '<div class="alert alert-warning">âš ï¸ Ù„Ù… ØªØªØ­Ù‚Ù‚ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆÙƒÙŠÙ„</div>';
            
            // Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ
            displayDetailsTable();
        }

        function displayDetailsTable() {
            const tableBody = document.getElementById('tableBody');
            const results = dataMatcher.getAllResults();
            
            let html = '';
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØªÙˆÙÙ‰
            if (heirsData.deceased.name) {
                html += `
                    <tr style="background-color: #f9f9f9;">
                        <td><strong>${heirsData.deceased.name}</strong></td>
                        <td>${heirsData.deceased.id || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
                        <td><em>Ø§Ù„Ù…ØªÙˆÙÙ‰</em></td>
                        <td>-</td>
                    </tr>
                `;
            }
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØ±Ø«Ø©
            heirsData.heirs.forEach(heir => {
                const isAuthorized = results.heirsMatch.matchedHeirs.some(h => h.id === heir.id);
                
                html += `
                    <tr>
                        <td>${heir.name}</td>
                        <td>${heir.id}</td>
                        <td>${heir.relation}</td>
                        <td class="${isAuthorized ? 'status-complete' : 'status-incomplete'}">
                            ${isAuthorized ? 'âœ… Ù…ÙƒØªÙ…Ù„' : 'âŒ Ù†Ø§Ù‚Øµ'}
                        </td>
                    </tr>
                `;
            });
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆÙƒÙŠÙ„ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…Ù† Ø§Ù„ÙˆØ±Ø«Ø©
            if (poaData.agent.id && !results.agentValidation.isHeir) {
                html += `
                    <tr style="background-color: #f0f8ff;">
                        <td><strong>${poaData.agent.name || 'Ø§Ù„ÙˆÙƒÙŠÙ„'}</strong></td>
                        <td>${poaData.agent.id || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
                        <td><strong>ÙˆÙƒÙŠÙ„</strong></td>
                        <td class="status-complete">âœ… Ù…ÙÙˆØ¶</td>
                    </tr>
                `;
            }
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆÙƒÙ„ÙŠÙ† Ø§Ù„Ø¥Ø¶Ø§ÙÙŠÙŠÙ† (ØºÙŠØ± Ø§Ù„ÙˆØ±Ø«Ø©)
            const nonHeirPrincipals = poaData.principals.filter(principal => 
                !heirsData.heirs.some(heir => heir.id === principal.id)
            );
            
            nonHeirPrincipals.forEach(principal => {
                html += `
                    <tr style="background-color: #fff8e1;">
                        <td>${principal.name}</td>
                        <td>${principal.id || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
                        <td>Ù…ÙˆÙƒÙ„ Ø¥Ø¶Ø§ÙÙŠ</td>
                        <td class="status-complete">âœ… Ù…ÙÙˆØ¶</td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html || `
                <tr>
                    <td colspan="4" style="text-align: center; padding: 20px; color: #666;">
                        Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§
                    </td>
                </tr>
            `;
        }

        // ==================== Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ† ====================

        function resetAll() {
            if (isProcessing) {
                if (!confirm('Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„ÙØ§ØªØŒ Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø¥Ù„ØºØ§Ø¡ØŸ')) {
                    return;
                }
            }
            
            heirsData = null;
            poaData = null;
            dataMatcher = new DataMatcher();
            isProcessing = false;
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            document.getElementById('heirsFile').value = '';
            document.getElementById('poaFile').value = '';
            document.getElementById('heirsInfo').innerHTML = '';
            document.getElementById('poaInfo').innerHTML = '';
            document.getElementById('heirsProgress').classList.add('hidden');
            document.getElementById('poaProgress').classList.add('hidden');
            
            document.getElementById('summary').innerHTML = `
                <h3>ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</h3>
                <p>Ù‚Ù… Ø¨Ø±ÙØ¹ Ù…Ù„ÙÙŠ PDF (ØµÙƒ Ø­ØµØ± Ø§Ù„ÙˆØ±Ø«Ø© ÙˆØµÙƒ Ø§Ù„ÙˆÙƒØ§Ù„Ø©) Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</p>
            `;
            
            document.getElementById('heirsMatchResult').innerHTML = 'Ø§Ù†ØªØ¸Ø± Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª...';
            document.getElementById('scopeValidationResult').innerHTML = 'Ø§Ù†ØªØ¸Ø± Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª...';
            document.getElementById('agentValidationResult').innerHTML = 'Ø§Ù†ØªØ¸Ø± Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª...';
            
            document.getElementById('tableBody').innerHTML = `
                <tr>
                    <td colspan="4" style="text-align: center; padding: 20px; color: #666;">
                        Ù„Ù… ÙŠØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø¨Ø¹Ø¯
                    </td>
                </tr>
            `;
            
            document.getElementById('heirsRawData').textContent = 'Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§ Ù…Ø­ØªÙˆÙ‰ ØµÙƒ Ø­ØµØ± Ø§Ù„ÙˆØ±Ø«Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø±ÙØ¹';
            document.getElementById('poaRawData').textContent = 'Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§ Ù…Ø­ØªÙˆÙ‰ ØµÙƒ Ø§Ù„ÙˆÙƒØ§Ù„Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø±ÙØ¹';
            
            document.getElementById('processLoading').classList.add('hidden');
            updateProcessButton();
            
            // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„Ø£Ø¹Ù„Ù‰
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ==================== Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© ====================

        document.addEventListener('DOMContentLoaded', function() {
            console.log('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙˆÙƒÙŠÙ„ Ø§Ù„ÙˆØ±Ø«Ø©');
            updateProcessButton();
            
            // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©
            window.addEventListener('error', function(e) {
                console.error('Ø®Ø·Ø£ Ø¹Ø§Ù…:', e.error);
            });
        });
    </script>
</body>
</html>
