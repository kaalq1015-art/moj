<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù…Ø­Ù„Ù„ Ø§Ù„Ø¹Ø¯Ù„ÙŠ Ø§Ù„Ø¨Ù„Ø§ØªÙŠÙ†ÙŠ v2026 | Platinum MOJ Parser</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'IBM Plex Sans Arabic', sans-serif; background: #f8fafc; color: #1e293b; }
        .drop-zone {
            border: 2px dashed #cbd5e1;
            background: #ffffff;
            transition: all 0.3s ease;
            position: relative;
            cursor: pointer;
        }
        .drop-zone:hover, .drop-zone.active {
            border-color: #f97316;
            background: #fff7ed;
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .drop-zone input { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
        .deceased-card {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            color: white;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .agent-row { background-color: #fff7ed !important; border-right: 4px solid #f97316 !important; }
        .agent-badge { background-color: #ffedd5; color: #9a3412; border: 1px solid #fdba74; padding: 2px 8px; border-radius: 6px; font-weight: bold; font-size: 0.75rem; }
        .clause-box {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 1rem;
            font-size: 0.85rem;
            line-height: 1.8;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            color: #475569;
        }
        .loader {
            width: 40px; height: 40px;
            border: 4px solid #f97316;
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .notification {
            position: fixed; top: 20px; left: 20px; padding: 12px 24px;
            border-radius: 12px; font-weight: bold; z-index: 1000;
            animation: slideIn 0.3s ease-out; color: white;
        }
        @keyframes slideIn { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto space-y-6">
        
        <header class="bg-white p-6 rounded-2xl shadow-sm border-b-4 border-orange-500 flex flex-wrap justify-between items-center gap-4">
            <div>
                <h1 class="text-3xl font-bold text-slate-800 tracking-tight">Ø§Ù„Ù…Ø­Ù„Ù„ Ø§Ù„Ø¹Ø¯Ù„ÙŠ <span class="text-orange-600">Ø§Ù„Ø¨Ù„Ø§ØªÙŠÙ†ÙŠ</span></h1>
                <p class="text-slate-500 mt-1 flex items-center gap-2">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                    Ù†Ø¸Ø§Ù… Ø°ÙƒÙŠ Ù„ÙØ­Øµ ØµÙƒÙˆÙƒ Ø§Ù„ÙˆØ±Ø«Ø© ÙˆØ§Ù„ÙˆÙƒØ§Ù„Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠØ©
                </p>
            </div>
            <div class="flex gap-3">
                <button onclick="location.reload()" class="px-5 py-2.5 bg-slate-100 hover:bg-slate-200 rounded-xl text-slate-700 font-semibold transition">Ø¨Ø¯Ø¡ ÙØ­Øµ Ø¬Ø¯ÙŠØ¯</button>
                <button onclick="exportToExcel()" id="exportBtn" class="hidden px-5 py-2.5 bg-emerald-600 hover:bg-emerald-700 text-white rounded-xl font-semibold shadow-lg shadow-emerald-200 transition">ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div id="heirsZone" class="drop-zone p-8 rounded-2xl text-center group">
                <input type="file" id="heirsFile" accept="application/pdf,image/*">
                <div class="text-4xl mb-3 opacity-40 group-hover:opacity-100 transition duration-300">ğŸ“„</div>
                <h3 class="text-lg font-bold text-slate-700">ØµÙƒ Ø­ØµØ± Ø§Ù„ÙˆØ±Ø«Ø©</h3>
                <p id="heirsMsg" class="text-sm text-slate-400 mt-2">Ø§Ø³Ø­Ø¨ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ù†Ù‚Ø± Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±</p>
            </div>
            <div id="poaZone" class="drop-zone p-8 rounded-2xl text-center group">
                <input type="file" id="poaFile" accept="application/pdf,image/*">
                <div class="text-4xl mb-3 opacity-40 group-hover:opacity-100 transition duration-300">âš–ï¸</div>
                <h3 class="text-lg font-bold text-slate-700">ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„ÙˆÙƒØ§Ù„Ø©</h3>
                <p id="poaMsg" class="text-sm text-slate-400 mt-2">Ø§Ø³Ø­Ø¨ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ù†Ù‚Ø± Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±</p>
            </div>
        </div>

        <div id="loadingSection" class="hidden bg-white p-10 rounded-2xl shadow-inner text-center border">
            <span class="loader"></span>
            <p id="progressText" class="mt-4 text-slate-800 font-bold tracking-wide">Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
            <div class="mt-6 w-full max-w-lg mx-auto bg-slate-100 rounded-full h-3 overflow-hidden border">
                <div id="progressBar" class="bg-orange-500 h-full transition-all duration-500 shadow-[0_0_10px_rgba(249,115,22,0.5)]" style="width: 0%"></div>
            </div>
        </div>

        <div id="resultsSection" class="hidden space-y-6 animate-fade-in">
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div id="deceasedCard" class="lg:col-span-2 deceased-card p-6 flex flex-wrap items-center justify-between gap-6">
                    <div class="flex items-center gap-5">
                        <div class="bg-white/10 p-4 rounded-2xl text-3xl shadow-inner">ğŸ‘¤</div>
                        <div>
                            <h2 class="text-slate-400 text-xs uppercase font-bold tracking-tighter">Ø§Ù„Ù…ÙˆØ±Ø« (ØµØ§Ø­Ø¨ Ø§Ù„ØªØ±ÙƒØ©)</h2>
                            <div class="flex items-center gap-3 mt-1">
                                <span id="deceasedId" class="text-2xl font-mono font-bold text-white">---</span>
                                <span class="bg-orange-500/20 text-orange-400 text-[10px] px-2 py-1 rounded-md border border-orange-500/30">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</span>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white/5 p-4 rounded-xl border border-white/10">
                        <h2 class="text-slate-400 text-[10px] uppercase font-bold mb-1">Ø­Ø§Ù„Ø© Ø±Ø¨Ø· Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚</h2>
                        <div id="linkingStatus" class="text-sm font-bold text-white italic">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ø¨Ø·...</div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border p-6 flex items-center justify-between">
                    <div>
                        <h3 class="text-slate-500 text-sm font-bold">Ù†Ø³Ø¨Ø© Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„ØªÙˆÙƒÙŠÙ„</h3>
                        <p id="appointmentRate" class="text-4xl font-black text-orange-600 mt-1">0%</p>
                    </div>
                    <div id="matchCircle" class="w-16 h-16 rounded-full border-4 border-slate-100 flex items-center justify-center font-bold text-xs text-slate-400">
                        Score
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border overflow-hidden">
                <div class="p-4 bg-slate-50 border-b flex justify-between items-center">
                    <h2 class="font-bold text-slate-800 flex items-center gap-2">
                        <span class="p-1.5 bg-orange-100 rounded-lg">ğŸ‘¥</span> Ø¬Ø¯ÙˆÙ„ Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø£Ø·Ø±Ø§Ù
                    </h2>
                    <span id="totalHeirsCount" class="text-xs font-bold bg-slate-200 px-3 py-1 rounded-full text-slate-600">0 ÙˆØ±Ø«Ø©</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-right">
                        <thead class="bg-slate-50 text-slate-400 text-[10px] uppercase font-bold">
                            <tr>
                                <th class="p-4">Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„ÙˆØ·Ù†ÙŠØ©</th>
                                <th class="p-4">Ø§Ù„Ø§Ø³Ù… (Ø§Ù„Ù…ÙƒØªØ´Ù)</th>
                                <th class="p-4">Ø§Ù„ØµÙØ©</th>
                                <th class="p-4 text-center">Ø­Ø§Ù„Ø© Ø§Ù„ÙˆÙƒØ§Ù„Ø©</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTable" class="divide-y divide-slate-100 text-sm font-semibold text-slate-700"></tbody>
                    </table>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="bg-white rounded-2xl shadow-sm border-t-4 border-blue-500 flex flex-col">
                    <div class="p-4 bg-blue-50/50 flex items-center justify-between border-b">
                        <h3 class="font-bold text-blue-900 text-sm">ğŸ  Ø¨Ù†Ø¯ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª</h3>
                        <span id="estateScore" class="bg-blue-100 text-blue-700 text-[10px] font-bold px-2 py-0.5 rounded-full">0%</span>
                    </div>
                    <div id="estateText" class="clause-box flex-grow border-none text-[11px]"></div>
                </div>
                <div class="bg-white rounded-2xl shadow-sm border-t-4 border-red-500 flex flex-col">
                    <div class="p-4 bg-red-50/50 flex items-center justify-between border-b">
                        <h3 class="font-bold text-red-900 text-sm">âš–ï¸ Ø¨Ù†Ø¯ Ø§Ù„Ù…Ø­Ø§ÙƒÙ…</h3>
                        <span id="legalScore" class="bg-red-100 text-red-700 text-[10px] font-bold px-2 py-0.5 rounded-full">0%</span>
                    </div>
                    <div id="legalText" class="clause-box flex-grow border-none text-[11px]"></div>
                </div>
                <div class="bg-white rounded-2xl shadow-sm border-t-4 border-emerald-500 flex flex-col">
                    <div class="p-4 bg-emerald-50/50 flex items-center justify-between border-b">
                        <h3 class="font-bold text-emerald-900 text-sm">ğŸ’° Ø¨Ù†Ø¯ Ø§Ù„Ø£Ù…ÙˆØ§Ù„</h3>
                        <span id="claimsScore" class="bg-emerald-100 text-emerald-700 text-[10px] font-bold px-2 py-0.5 rounded-full">0%</span>
                    </div>
                    <div id="claimsText" class="clause-box flex-grow border-none text-[11px]"></div>
                </div>
                <div class="bg-white rounded-2xl shadow-sm border-t-4 border-amber-500 flex flex-col">
                    <div class="p-4 bg-amber-50/50 flex items-center justify-between border-b">
                        <h3 class="font-bold text-amber-900 text-sm">ğŸ“ Ù†Ø·Ø§Ù‚ Ø§Ù„ÙˆÙƒØ§Ù„Ø©</h3>
                        <span id="scopeScore" class="bg-amber-100 text-amber-700 text-[10px] font-bold px-2 py-0.5 rounded-full">0%</span>
                    </div>
                    <div id="scopeText" class="clause-box flex-grow border-none text-[11px]"></div>
                </div>
            </div>

            <div class="flex flex-wrap justify-center gap-4 py-4">
                <button onclick="window.print()" class="px-8 py-3 bg-slate-800 text-white font-bold rounded-xl shadow-lg hover:bg-slate-700 transition">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙÙ†ÙŠ</button>
                <button onclick="downloadJSON()" class="px-8 py-3 bg-white text-slate-700 border font-bold rounded-xl shadow-sm hover:bg-slate-50 transition">ğŸ’¾ Ø­ÙØ¸ ÙƒÙ…Ù„Ù Ø¨ÙŠØ§Ù†Ø§Øª</button>
            </div>
        </div>
    </div>

    <script>
        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø­Ø±ÙƒØ§Øª
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        let files = { heirs: null, poa: null };
        let finalResults = null;

        // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ø¥Ø³Ù‚Ø§Ø·
        setupDropZone('heirs'); setupDropZone('poa');

        function setupDropZone(key) {
            const zone = document.getElementById(`${key}Zone`);
            const input = document.getElementById(`${key}File`);
            const msg = document.getElementById(`${key}Msg`);
            
            zone.addEventListener('dragover', (e) => { e.preventDefault(); zone.classList.add('active'); });
            zone.addEventListener('dragleave', () => zone.classList.remove('active'));
            zone.addEventListener('drop', (e) => { 
                e.preventDefault(); zone.classList.remove('active');
                handleFile(e.dataTransfer.files[0], key, msg);
            });
            input.addEventListener('change', (e) => handleFile(e.target.files[0], key, msg));
        }

        function handleFile(file, key, msgElement) {
            if (!file) return;
            files[key] = file;
            msgElement.innerHTML = `<span class="font-bold text-orange-600">${file.name}</span><br><span class="text-[10px] text-green-600 font-bold uppercase tracking-widest">âœ… Ready to Analyze</span>`;
            if (files.heirs && files.poa) {
                document.getElementById('loadingSection').classList.remove('hidden');
                setTimeout(processDocuments, 500);
            }
        }

        async function processDocuments() {
            try {
                updateProgress(15, "Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¨ÙŠØ§Ù†Ø§Øª ØµÙƒ Ø§Ù„Ø­ØµØ±...");
                const hText = await extractText(files.heirs);
                
                updateProgress(45, "Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆÙƒØ§Ù„Ø©...");
                const pText = await extractText(files.poa);
                
                updateProgress(70, "Ø¬Ø§Ø±ÙŠ Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø£Ø·Ø±Ø§Ù ÙˆÙØ­Øµ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª...");
                const heirsData = analyzeInheritance(hText);
                const poaData = analyzePOA(pText, heirsData);
                
                finalResults = { heirsData, poaData };
                renderDashboard(heirsData, poaData);
                
                updateProgress(100, "Ø§ÙƒØªÙ…Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­");
                setTimeout(() => {
                    document.getElementById('loadingSection').classList.add('hidden');
                    document.getElementById('resultsSection').classList.remove('hidden');
                    document.getElementById('exportBtn').classList.remove('hidden');
                }, 500);
            } catch (err) {
                console.error(err);
                showNotification("ÙØ´Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„: ØªØ£ÙƒØ¯ Ù…Ù† Ø¬ÙˆØ¯Ø© Ø§Ù„Ù…Ù„ÙØ§Øª", "bg-red-600");
                document.getElementById('loadingSection').classList.add('hidden');
            }
        }

        // --- Ù…Ø­Ø±Ùƒ Ø§Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù‡Ø¬ÙŠÙ† ---
        async function extractText(file) {
            if (file.type === 'application/pdf') {
                const doc = await pdfjsLib.getDocument(await file.arrayBuffer()).promise;
                let text = "";
                for (let i = 1; i <= doc.numPages; i++) {
                    const page = await doc.getPage(i);
                    const content = await page.getTextContent();
                    text += content.items.map(s => s.str).join(" ") + "\n";
                }
                if (text.trim().length > 100) return text;
            }
            return await runOCR(file);
        }

        async function runOCR(file) {
            const worker = await Tesseract.createWorker('ara');
            const { data: { text } } = await worker.recognize(file);
            await worker.terminate();
            return text;
        }

        // --- Ù…Ø­Ø±Ùƒ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠ ---
        function analyzeInheritance(text) {
            const clean = normalize(text);
            const idMatch = clean.match(/1\d{9}/);
            const decId = idMatch ? idMatch[0] : null;
            
            // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø±Ù‚Ù… Ø§Ù„ØµÙƒ
            const docNumMatch = clean.match(/(ØµÙƒ|Ø±Ù‚Ù…)\s*(\d{10,12})/);
            const docNumber = docNumMatch ? docNumMatch[2] : null;

            const allIds = [...new Set(clean.match(/1\d{9}/g) || [])];
            const heirs = allIds.filter(id => id !== decId);
            
            return { decId, heirs, docNumber, raw: text };
        }

        function analyzePOA(text, hData) {
            const clean = normalize(text);
            const allIds = [...new Set(clean.match(/1\d{9}/g) || [])];
            
            // ÙƒØ´Ù Ø±Ù‚Ù… Ø§Ù„ØµÙƒ Ø§Ù„Ù…Ø°ÙƒÙˆØ± ÙÙŠ Ø§Ù„ÙˆÙƒØ§Ù„Ø© Ù„Ù„Ø±Ø¨Ø·
            const linkedDocMatch = clean.match(/(Ø­ØµØ±|ÙˆØ±Ø«Ù‡|Ø±Ù‚Ù…)\s*(\d{10,12})/);
            const linkedDocNumber = linkedDocMatch ? linkedDocMatch[2] : null;
            const isLinked = hData.docNumber && linkedDocNumber && hData.docNumber.slice(-5) === linkedDocNumber.slice(-5);

            let agentId = null;
            const principals = [];
            
            allIds.forEach(id => {
                const idx = clean.indexOf(id);
                const context = clean.substring(idx - 100, idx + 100);
                if (context.includes("ÙˆÙƒÙŠÙ„") && !context.includes("Ù…ÙˆÙƒÙ„")) agentId = id;
                else principals.push(id);
            });

            // ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨Ù†ÙˆØ¯
            const clauses = {
                estate: findClause(text, ['Ø¹Ù‚Ø§Ø±', 'Ø¨ÙŠØ¹', 'Ø§ÙØ±Ø§Øº', 'Ø´Ø±Ø§Ø¡', 'ØµÙƒÙˆÙƒ']),
                legal: findClause(text, ['Ù…Ø­ÙƒÙ…Ù‡', 'Ø¯Ø¹ÙˆÙŠ', 'Ù‚Ø¶Ø§Ø¡', 'ØªØ±Ø§ÙØ¹', 'Ø®Ù„Ø§Ù']),
                claims: findClause(text, ['Ù…Ø§Ù„ÙŠÙ‡', 'Ø§Ø³ØªÙ„Ø§Ù…', 'Ø´ÙŠÙƒØ§Øª', 'ØµØ±Ù', 'Ø¨Ù†ÙˆÙƒ']),
                scope: findClause(text, ['Ù†Ø·Ø§Ù‚', 'ØµÙ„Ø§Ø­ÙŠÙ‡', 'ØªÙÙˆÙŠØ¶', 'Ø¹Ø§Ù…', 'Ø®Ø§Øµ'])
            };

            return { agentId, principals, clauses, isLinked, linkedDocNumber };
        }

        function findClause(text, keywords) {
            const paragraphs = text.split(/\n\s*\n/);
            return paragraphs.find(p => keywords.some(k => normalize(p).includes(k))) || "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨Ù†Ø¯ ØµØ±ÙŠØ­.";
        }

        // --- Ù…Ø­Ø±Ùƒ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ---
        function renderDashboard(h, p) {
            document.getElementById('deceasedId').innerText = h.decId || "ØºÙŠØ± Ù…ÙƒØªØ´Ù";
            
            const linkEl = document.getElementById('linkingStatus');
            if (p.isLinked) {
                linkEl.innerHTML = "âœ… Ù…Ø±ØªØ¨Ø·Ø© Ø¨ØµÙƒ Ø§Ù„Ø­ØµØ± Ø±Ù‚Ù… " + h.docNumber;
                linkEl.className = "text-sm font-bold text-emerald-400 italic";
            } else {
                linkEl.innerHTML = "âš ï¸ Ø§Ù„Ø±Ø¨Ø· ØºÙŠØ± Ù…Ø¤ÙƒØ¯ (ØµÙƒ Ø§Ù„Ø­ØµØ±: " + (p.linkedDocNumber || "Ù„Ù… ÙŠØ°ÙƒØ±") + ")";
                linkEl.className = "text-sm font-bold text-amber-400 italic";
            }

            const total = h.heirs.length;
            const signed = h.heirs.filter(id => p.principals.includes(id) || id === p.agentId).length;
            const rate = total > 0 ? Math.round((signed/total)*100) : 0;
            
            document.getElementById('appointmentRate').innerText = rate + "%";
            document.getElementById('totalHeirsCount').innerText = total + " ÙˆØ±Ø«Ø© Ù…Ø³ØªØ®Ø±Ø¬ÙŠÙ†";

            const table = document.getElementById('resultsTable');
            table.innerHTML = "";
            h.heirs.forEach(id => {
                const isSigned = p.principals.includes(id);
                const isAgent = id === p.agentId;
                table.innerHTML += `
                    <tr class="${isAgent ? 'agent-row' : ''} border-b">
                        <td class="p-4 font-mono">${id}</td>
                        <td class="p-4 text-slate-400 text-xs italic">Ø§Ø³ØªØ®Ø±Ø§Ø¬ ØªÙ„Ù‚Ø§Ø¦ÙŠ...</td>
                        <td class="p-4">${isAgent ? '<span class="agent-badge">Ø§Ù„ÙˆÙƒÙŠÙ„</span>' : 'ÙˆØ§Ø±Ø«'}</td>
                        <td class="p-4 text-center">
                            ${isSigned || isAgent ? '<span class="text-emerald-600">âœ… Ù…ÙƒØªÙ…Ù„</span>' : '<span class="text-red-500">âŒ Ù…ÙÙ‚ÙˆØ¯</span>'}
                        </td>
                    </tr>
                `;
            });

            // Ø§Ù„Ø¨Ù†ÙˆØ¯
            renderClauseBox('estate', p.clauses.estate, ['Ø¨ÙŠØ¹', 'Ø§ÙØ±Ø§Øº', 'Ø¹Ù‚Ø§Ø±']);
            renderClauseBox('legal', p.clauses.legal, ['Ù…Ø­ÙƒÙ…Ù‡', 'ØªØ±Ø§ÙØ¹']);
            renderClauseBox('claims', p.clauses.claims, ['Ø§Ø³ØªÙ„Ø§Ù…', 'Ø´ÙŠÙƒØ§Øª', 'Ù…Ø¨Ø§Ù„Øº']);
            renderClauseBox('scope', p.clauses.scope, ['ÙˆÙƒØ§Ù„Ù‡', 'ØªÙÙˆÙŠØ¶']);
        }

        function renderClauseBox(id, text, keys) {
            const box = document.getElementById(id + 'Text');
            box.innerText = text;
            const score = keys.filter(k => normalize(text).includes(k)).length;
            const pct = Math.min(Math.round((score/keys.length)*100), 100);
            document.getElementById(id + 'Score').innerText = pct + "%";
        }

        // --- Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© ---
        function normalize(s) {
            return s.replace(/[Ù -Ù©]/g, d => "0123456789"['Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©'.indexOf(d)])
                    .replace(/[Ø£Ø¥Ø¢]/g, 'Ø§').replace(/Ø©/g, 'Ù‡').replace(/Ù‰/g, 'ÙŠ')
                    .replace(/\s+/g, ' ').toLowerCase();
        }

        function updateProgress(pct, msg) {
            document.getElementById('progressBar').style.width = pct + "%";
            document.getElementById('progressText').innerText = msg;
        }

        function showNotification(msg, colorClass) {
            const div = document.createElement('div');
            div.className = `notification ${colorClass} shadow-xl`;
            div.innerText = msg;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }

        function exportToExcel() {
            let csv = "ID,Status\n";
            finalResults.heirsData.heirs.forEach(id => {
                const status = finalResults.poaData.principals.includes(id) ? "Included" : "Missing";
                csv += `${id},${status}\n`;
            });
            const blob = new Blob([csv], {type: 'text/csv'});
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('href', url);
            a.setAttribute('download', 'analysis_report.csv');
            a.click();
        }

        function downloadJSON() {
            const blob = new Blob([JSON.stringify(finalResults, null, 2)], {type: 'application/json'});
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "legal_analysis_data.json";
            a.click();
        }
    </script>
</body>
</html>
