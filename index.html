<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø§Ù„Ù…Ø­Ù„Ù„ Ø§Ù„Ø¹Ø¯Ù„ÙŠ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ø¯Ø«Ø© (Smart Hunt)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@500;700;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Tajawal', sans-serif; background: #f8fafc; }
        .drop-box { border: 3px dashed #cbd5e1; transition: 0.3s; background: white; cursor: pointer; }
        .drop-box.active { border-color: #10b981; background: #ecfdf5; }
        .result-area { white-space: pre-wrap; line-height: 1.8; font-size: 0.95rem; color: #334155; }
        .loading { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body class="p-6 md:p-12">

    <div class="max-w-6xl mx-auto space-y-8">
        
        <header class="text-center bg-white p-6 rounded-3xl shadow-sm border-b-4 border-emerald-600">
            <h1 class="text-3xl font-black text-gray-800">Ù†Ø¸Ø§Ù… ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙƒÙˆÙƒ <span class="text-emerald-600">(Smart Hunt)</span></h1>
            <p class="text-gray-500 mt-2">ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† "Ù…ÙØ§ØªÙŠØ­ Ø§Ù„ÙƒÙ„Ù…Ø§Øª" Ù„Ø¶Ù…Ø§Ù† Ø³Ø­Ø¨ Ø§Ù„Ù†Øµ Ø­ØªÙ‰ Ù„Ùˆ ÙƒØ§Ù†Øª Ø§Ù„ØµÙˆØ±Ø© ØºÙŠØ± ÙˆØ§Ø¶Ø­Ø©</p>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div id="heirsZone" class="drop-box p-8 rounded-2xl text-center relative group">
                <input type="file" id="heirsFile" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                <span class="text-4xl block mb-2">ğŸ“„</span>
                <h3 class="font-bold text-gray-700">1. ØµÙƒ Ø­ØµØ± Ø§Ù„ÙˆØ±Ø«Ø©</h3>
                <p id="heirsTxt" class="text-sm text-gray-400">Ø§Ø¶ØºØ· Ø£Ùˆ Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ù„Ù Ù‡Ù†Ø§</p>
            </div>

            <div id="poaZone" class="drop-box p-8 rounded-2xl text-center relative group">
                <input type="file" id="poaFile" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                <span class="text-4xl block mb-2">âš–ï¸</span>
                <h3 class="font-bold text-gray-700">2. ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„ÙˆÙƒØ§Ù„Ø©</h3>
                <p id="poaTxt" class="text-sm text-gray-400">Ø§Ø¶ØºØ· Ø£Ùˆ Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ù„Ù Ù‡Ù†Ø§</p>
            </div>
        </div>

        <div id="loader" class="hidden text-center py-4 text-emerald-600 font-bold loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø³Ø­ Ø§Ù„Ø¶ÙˆØ¦ÙŠ ÙˆØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†ØµÙˆØµ...</div>

        <div id="results" class="hidden space-y-6">
            
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="bg-gray-50 p-4 border-b font-bold text-gray-700 flex justify-between">
                    <span>ØªÙ‚Ø±ÙŠØ± Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„ÙˆØ±Ø«Ø©</span>
                    <span id="heirCountBadge" class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded"></span>
                </div>
                <table class="w-full text-right text-sm">
                    <thead class="bg-gray-100 text-gray-500">
                        <tr><th class="p-3">Ø§Ù„Ù‡ÙˆÙŠØ©</th><th class="p-3">Ø§Ù„ØµÙØ©</th><th class="p-3">Ø§Ù„Ø­Ø§Ù„Ø©</th></tr>
                    </thead>
                    <tbody id="tableBody" class="divide-y"></tbody>
                </table>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white p-5 rounded-xl shadow-sm border-t-4 border-blue-500">
                    <h3 class="font-bold text-blue-800 mb-2">ğŸ  Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª (Ø§Ù„Ø¨ÙŠØ¹ ÙˆØ§Ù„Ø¥ÙØ±Ø§Øº)</h3>
                    <div id="estateBox" class="result-area bg-blue-50 p-3 rounded-lg h-40 overflow-y-auto"></div>
                </div>
                <div class="bg-white p-5 rounded-xl shadow-sm border-t-4 border-red-500">
                    <h3 class="font-bold text-red-800 mb-2">âš–ï¸ Ø§Ù„Ù…Ø­Ø§ÙƒÙ… (Ù‚Ø³Ù…Ø© Ø§Ù„ØªØ±ÙƒØ©)</h3>
                    <div id="legalBox" class="result-area bg-red-50 p-3 rounded-lg h-40 overflow-y-auto"></div>
                </div>
            </div>

            <button onclick="document.getElementById('rawTextBox').classList.toggle('hidden')" class="text-xs text-gray-400 underline w-full text-center">Ø¹Ø±Ø¶ Ø§Ù„Ù†Øµ Ø§Ù„Ø®Ø§Ù… (Ù„Ù„Ù…Ø¨Ø±Ù…Ø¬)</button>
            <div id="rawTextBox" class="hidden bg-gray-900 text-green-400 p-4 rounded-lg text-xs font-mono h-40 overflow-auto dir-ltr text-left"></div>
        </div>

    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        const files = { heirs: null, poa: null };
        const zones = { heirs: document.getElementById('heirsZone'), poa: document.getElementById('poaZone') };
        const texts = { heirs: document.getElementById('heirsTxt'), poa: document.getElementById('poaTxt') };

        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª
        ['heirs', 'poa'].forEach(type => {
            document.getElementById(`${type}File`).addEventListener('change', (e) => handleUpload(e.target.files[0], type));
        });

        function handleUpload(file, type) {
            if(!file) return;
            files[type] = file;
            zones[type].classList.add('active');
            texts[type].innerText = `âœ… ${file.name}`;
            if(files.heirs && files.poa) processFiles();
        }

        async function processFiles() {
            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('results').classList.add('hidden');

            try {
                // 1. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†ØµÙˆØµ
                const hText = await extractText(files.heirs);
                const pText = await extractText(files.poa);

                // Ø¹Ø±Ø¶ Ø§Ù„Ù†Øµ Ø§Ù„Ø®Ø§Ù… Ù„Ù„ØªØµØ­ÙŠØ­
                document.getElementById('rawTextBox').innerText = "--- POA TEXT ---\n" + pText;

                // 2. ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                const heirsData = analyzeHeirs(hText);
                const poaData = analyzePOA(pText);

                // 3. Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
                renderTable(heirsData, poaData);
                renderClauses(pText); // Ù†Ø±Ø³Ù„ Ø§Ù„Ù†Øµ Ø§Ù„Ø£ØµÙ„ÙŠ Ù„Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ù…ÙŠÙ‚

            } catch (err) {
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£: " + err.message);
                console.error(err);
            } finally {
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('results').classList.remove('hidden');
            }
        }

        // --- Ù…Ø­Ø±Ùƒ Ø§Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø°ÙƒÙŠ (Smart Hunt Engine) ---

        function renderClauses(text) {
            const clean = normalize(text);
            
            // 1. ØµÙŠØ¯ Ø¨Ù†Ø¯ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª (Estate Hunting)
            // Ù†Ø¨Ø­Ø« Ø¹Ù† ÙƒÙ„Ù…Ø§Øª Ù…ÙØªØ§Ø­ÙŠØ© Ù‚ÙˆÙŠØ© Ø¬Ø¯Ø§Ù‹ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙÙ‚Ø·
            const estateKeywords = [
                "Ø§Ù„Ø¨ÙŠØ¹ ÙˆØ§Ù„Ø§ÙØ±Ø§Øº", "Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø«Ù…Ù†", "Ø§ÙØ±Ø§Øº Ø§Ù„Ø¹Ù‚Ø§Ø±", 
                "ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙƒÙˆÙƒ", "Ø§Ø¯Ø®Ø§Ù„ Ø§Ù„ØµÙƒÙˆÙƒ", "ÙƒØªØ§Ø¨Ø§Øª Ø§Ù„Ø¹Ø¯Ù„", "Ø§Ù„Ø§Ù…Ù„Ø§Ùƒ Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠÙ‡"
            ];
            
            // Ù†Ø¨Ø­Ø« Ø¹Ù† Ù…ÙˆÙ‚Ø¹ ÙƒÙ„Ù…Ø© "Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª" ÙƒØ¨Ø¯Ø§ÙŠØ© Ù…ÙØ¶Ù„Ø©ØŒ ÙˆØ¥Ø°Ø§ Ù„Ù… Ù†Ø¬Ø¯Ù‡Ø§ Ù†Ø¨Ø­Ø« Ø¹Ù† Ø£ÙˆÙ„ ÙƒÙ„Ù…Ø© Ù…ÙØªØ§Ø­ÙŠØ©
            let estateStart = clean.indexOf("Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª");
            if (estateStart === -1) estateStart = clean.indexOf("Ø¹Ù‚Ø§Ø±Ø§Øª"); // Ø¨Ø¯ÙˆÙ† Ø§Ù„
            
            // Ø¥Ø°Ø§ Ù„Ù… Ù†Ø¬Ø¯ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†ØŒ Ù†Ø¨Ø­Ø« Ø¹Ù† Ø£ÙˆÙ„ Ø¸Ù‡ÙˆØ± Ù„Ù€ "Ø§Ù„Ø¨ÙŠØ¹ ÙˆØ§Ù„Ø¥ÙØ±Ø§Øº"
            if (estateStart === -1) {
                estateStart = clean.search(/(Ø§Ù„Ø¨ÙŠØ¹ ÙˆØ§Ù„Ø§ÙØ±Ø§Øº|Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø«Ù…Ù†)/);
                if (estateStart !== -1) estateStart -= 20; // Ù†Ø±Ø¬Ø¹ Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„Ù„Ø®Ù„Ù Ù„Ù†Ø£Ø®Ø° Ø§Ù„Ø³ÙŠØ§Ù‚
            }

            // Ù†Ù‚Ø·Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ©: Ù†Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¨Ù†Ø¯ Ø§Ù„ØªØ§Ù„ÙŠ
            let estateEnd = clean.indexOf("Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø§Øª", estateStart + 10);
            if (estateEnd === -1) estateEnd = clean.indexOf("Ø§Ù„Ø´Ø±ÙƒØ§Øª", estateStart + 10);
            if (estateEnd === -1) estateEnd = clean.indexOf("Ø§Ù„Ø¨Ù†ÙˆÙƒ", estateStart + 10);
            if (estateEnd === -1) estateEnd = estateStart + 600; // Ø­Ø¯ Ø£Ù‚ØµÙ‰ Ù„Ù„Ø­Ø±ÙˆÙ

            let estateText = "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¨ÙŠØ¹ ØµØ±ÙŠØ­Ø©.";
            if (estateStart !== -1) {
                estateText = clean.substring(estateStart, estateEnd);
                // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
                estateText = estateText.replace(/^.*?Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª/s, ''); 
            } else {
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø£Ø®ÙŠØ±Ø©: Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¬Ù…Ù„ Ø¨ØºØ¶ Ø§Ù„Ù†Ø¸Ø± Ø¹Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹
                const foundSentences = estateKeywords.filter(w => clean.includes(w));
                if (foundSentences.length > 0) {
                    estateText = "âš ï¸ ØªÙ… Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ© Ù…Ù† Ø§Ù„Ù†Øµ Ø§Ù„Ù…ØªÙØ±Ù‚: " + foundSentences.join("ØŒ ") + "... (ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ØµÙƒ ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù„Ø£Ù† Ø§Ù„Ù†Øµ ØºÙŠØ± Ù…ØªØµÙ„).";
                }
            }
            document.getElementById('estateBox').innerText = estateText.trim();


            // 2. ØµÙŠØ¯ Ø¨Ù†Ø¯ Ø§Ù„Ù…Ø­Ø§ÙƒÙ… (Legal Hunting)
            let legalStart = clean.search(/(Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø§Øª ÙˆØ§Ù„Ù…Ø­Ø§ÙƒÙ…|Ù‚Ø³Ù…Ù‡ Ø§Ù„ØªØ±ÙƒÙ‡|ÙØ±Ø² Ø§Ù„Ù†ØµÙŠØ¨)/);
            let legalText = "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨Ù†Ø¯ Ù‚Ø³Ù…Ø© Ø§Ù„ØªØ±ÙƒØ©.";
            
            if (legalStart !== -1) {
                let legalEnd = clean.indexOf("Ø§Ù„Ø´Ø±ÙƒØ§Øª", legalStart);
                if (legalEnd === -1) legalEnd = clean.indexOf("Ø§Ù„Ø¨Ù†ÙˆÙƒ", legalStart);
                if (legalEnd === -1) legalEnd = legalStart + 400;
                legalText = clean.substring(legalStart, legalEnd);
            }
            document.getElementById('legalBox').innerText = legalText.trim();
        }

        // --- Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ---

        function analyzeHeirs(text) {
            const clean = toEngDigits(normalize(text));
            // Ù†ÙØªØ±Ø¶ Ø£Ù† Ø§Ù„Ù…ØªÙˆÙÙ‰ ÙŠØ¸Ù‡Ø± Ø£ÙˆÙ„Ø§Ù‹ Ø£Ùˆ ÙŠØªÙ… Ø°ÙƒØ±Ù‡ Ø¨ÙˆØ¶ÙˆØ­
            // Ù‡Ù†Ø§ Ø³Ù†Ù‚ÙˆÙ… Ø¨Ø¬Ù…Ø¹ ÙƒÙ„ Ø§Ù„Ù‡ÙˆÙŠØ§Øª ÙˆÙÙ„ØªØ±ØªÙ‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹
            const ids = [...new Set(clean.match(/1\d{9}/g) || [])];
            // Ø¹Ø§Ø¯Ø© ÙÙŠ ØµÙƒ Ø§Ù„Ø­ØµØ±ØŒ Ø§Ù„Ù…ØªÙˆÙÙ‰ Ù‡Ùˆ Ø£ÙˆÙ„ Ø§Ø³Ù…ØŒ Ø£Ùˆ Ù†Ø¨Ø­Ø« Ø¹Ù† ÙƒÙ„Ù…Ø© "Ø§Ù„Ù…ØªÙˆÙÙ‰"
            const deceasedIdx = clean.indexOf("Ø§Ù„Ù…ØªÙˆÙÙ‰");
            let deceasedId = null;
            if (deceasedIdx !== -1) {
                const afterDeceased = clean.substring(deceasedIdx, deceasedIdx + 100);
                const match = afterDeceased.match(/1\d{9}/);
                if(match) deceasedId = match[0];
            }
            // Ø¥Ø°Ø§ Ù„Ù… Ù†Ø¬Ø¯ØŒ Ù†Ø£Ø®Ø° Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„ØªÙŠ ØªØªÙƒØ±Ø± Ø¨ØµÙŠØºØ© Ù…Ø®ØªÙ„ÙØ© Ø£Ùˆ Ø£ÙˆÙ„ Ù‡ÙˆÙŠØ©
            return { deceasedId, heirs: ids.filter(id => id !== deceasedId) };
        }

        function analyzePOA(text) {
            const clean = toEngDigits(normalize(text));
            const ids = [...new Set(clean.match(/1\d{9}/g) || [])];
            
            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆÙƒÙŠÙ„: Ù†Ø¨Ø­Ø« Ø¹Ù† ÙƒÙ„Ù…Ø© "ÙˆÙƒÙŠÙ„" Ù‚Ø±Ø¨ Ø§Ù„Ø±Ù‚Ù…
            let agentId = null;
            ids.forEach(id => {
                const idx = clean.indexOf(id);
                const context = clean.substring(idx - 50, idx + 50);
                if (context.includes("ÙˆÙƒÙŠÙ„") && !context.includes("Ù…ÙˆÙƒÙ„")) agentId = id;
            });

            return { agentId, principals: ids.filter(id => id !== agentId) };
        }

        function renderTable(hData, pData) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = "";
            const allIds = [...new Set([...hData.heirs, ...pData.principals, pData.agentId, hData.deceasedId].filter(Boolean))];
            
            let matchCount = 0;

            allIds.forEach(id => {
                const isDeceased = id === hData.deceasedId;
                const isHeir = hData.heirs.includes(id);
                const isPoa = pData.principals.includes(id) || id === pData.agentId;

                let role = isDeceased ? "Ø§Ù„Ù…ØªÙˆÙÙ‰" : (isHeir ? "ÙˆØ§Ø±Ø«" : "-");
                let status = "";
                let bgClass = "";

                if (isDeceased) {
                    status = "-"; bgClass = "bg-gray-50 text-gray-400";
                } else if (isPoa) {
                    status = "âœ… ÙˆÙƒÙ‘Ù„"; bgClass = "bg-green-50 text-green-700";
                    if(isHeir) matchCount++;
                } else if (isHeir) {
                    status = "âŒ Ù„Ù… ÙŠÙˆÙƒÙ„"; bgClass = "bg-red-50 text-red-700";
                } else {
                    status = "Ø·Ø±Ù Ø®Ø§Ø±Ø¬ÙŠ"; bgClass = "bg-yellow-50 text-yellow-700";
                }

                tbody.innerHTML += `
                    <tr class="${bgClass} border-b last:border-0">
                        <td class="p-3 font-mono">${id}</td>
                        <td class="p-3">${role}</td>
                        <td class="p-3 font-bold">${status}</td>
                    </tr>`;
            });

            document.getElementById('heirCountBadge').innerText = `ØªÙ…Øª Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©: ${matchCount} Ù…Ù† ${hData.heirs.length}`;
        }

        // --- Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© (Tools) ---

        async function extractText(file) {
            if (file.type === 'application/pdf') {
                const pdf = await pdfjsLib.getDocument(await file.arrayBuffer()).promise;
                let txt = "";
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    txt += content.items.map(s => s.str).join(" ") + " \n ";
                }
                if (txt.length < 50) return await ocr(file); // PDF ØµÙˆØ±Ø©
                return txt;
            }
            return await ocr(file);
        }

        async function ocr(file) {
            const worker = await Tesseract.createWorker('ara');
            const res = await worker.recognize(file);
            await worker.terminate();
            return res.data.text;
        }

        function normalize(text) {
            return text
                .replace(/(Ø£|Ø¥|Ø¢)/g, 'Ø§').replace(/Ø©/g, 'Ù‡').replace(/Ù‰/g, 'ÙŠ')
                .replace(/\s+/g, ' '); // Ø¯Ù…Ø¬ Ø§Ù„Ù…Ø³Ø§ÙØ§Øª
        }

        function toEngDigits(str) {
            return str.replace(/[Ù -Ù©]/g, d => "0123456789"['Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©'.indexOf(d)]);
        }
    </script>
</body>
</html>
