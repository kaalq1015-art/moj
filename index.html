<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù…Ø­Ù„Ù„ Ø§Ù„Ø¹Ø¯Ù„ÙŠ Ø§Ù„Ù…Ø§Ø³ÙŠ | Ø¥ØµØ¯Ø§Ø± Ø§Ù„ÙˆÙƒÙŠÙ„</title>
    
    <!-- Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Ø®Ø·ÙˆØ· Ø¹Ø±Ø¨ÙŠØ© -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Cairo', sans-serif; background: #f8fafc; color: #1e293b; }
        
        /* Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ø³Ø­Ø¨ */
        .drop-zone {
            border: 3px dashed #cbd5e1;
            background: #ffffff;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .drop-zone:hover, .drop-zone.active {
            border-color: #f59e0b; /* Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ Ø¹Ù†Ø¯ Ø§Ù„ØªÙØ§Ø¹Ù„ */
            background: #fffbeb;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -5px rgba(245, 158, 11, 0.2);
        }
        .drop-zone input { position: absolute; inset: 0; opacity: 0; cursor: pointer; z-index: 10; }
        
        /* Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…ØªÙˆÙÙ‰ */
        .deceased-card {
            background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
            color: white;
            border-radius: 16px;
            position: relative;
            overflow: hidden;
        }
        .deceased-card::after {
            content: "Ø§Ù„Ù…ÙˆØ±Ø«";
            position: absolute;
            top: -10px;
            left: -10px;
            font-size: 4rem;
            opacity: 0.1;
            font-weight: 900;
        }

        /* ØªÙ…ÙŠÙŠØ² Ø§Ù„ÙˆÙƒÙŠÙ„ (Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨) */
        .agent-row {
            background-color: #fff7ed !important; /* Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ ÙØ§ØªØ­ */
            border-right: 4px solid #f97316 !important; /* Ø­Ø¯ÙˆØ¯ Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠØ© */
        }
        .agent-badge {
            background-color: #ffedd5;
            color: #c2410c;
            border: 1px solid #fdba74;
        }

        /* ØµÙ†Ø§Ø¯ÙŠÙ‚ Ø§Ù„Ø¨Ù†ÙˆØ¯ */
        .clause-box {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 1rem;
            font-size: 0.9rem;
            line-height: 1.8;
            max-height: 250px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .loader {
            width: 40px; height: 40px;
            border: 4px solid #f97316;
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div class="max-w-7xl mx-auto space-y-8">
        
        <!-- Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© -->
        <header class="bg-white p-6 rounded-2xl shadow-sm border-b-4 border-orange-500 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-black text-gray-800">Ø§Ù„Ù…Ø­Ù„Ù„ Ø§Ù„Ø¹Ø¯Ù„ÙŠ <span class="text-orange-600">Pro</span></h1>
                <p class="text-gray-500 font-medium mt-1">ØªÙ…ÙŠÙŠØ² Ø§Ù„ÙˆÙƒÙŠÙ„ â€¢ ÙØµÙ„ Ø§Ù„Ù…ÙˆØ±Ø« â€¢ Ø¯Ù…Ø¬ Ø§Ù„ØµÙØ§Øª</p>
            </div>
            <button onclick="location.reload()" class="text-sm text-gray-400 hover:text-orange-600 underline transition">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ø¸Ø§Ù…</button>
        </header>

        <!-- Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ø³Ø­Ø¨ (Drag & Drop) -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- ØµÙƒ Ø§Ù„Ø­ØµØ± -->
            <div id="heirsZone" class="drop-zone p-8 rounded-2xl text-center group">
                <input type="file" id="heirsFile" accept="application/pdf,image/*">
                <div class="text-5xl mb-3 opacity-50 group-hover:opacity-100 transition grayscale group-hover:grayscale-0">ğŸ“„</div>
                <h3 class="text-lg font-bold text-gray-700">1. ØµÙƒ Ø­ØµØ± Ø§Ù„ÙˆØ±Ø«Ø©</h3>
                <p id="heirsMsg" class="text-sm text-gray-400 mt-2">Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ù„Ù Ù„Ù„Ø¥ÙÙ„Ø§Øª</p>
            </div>

            <!-- Ø§Ù„ÙˆÙƒØ§Ù„Ø© -->
            <div id="poaZone" class="drop-zone p-8 rounded-2xl text-center group">
                <input type="file" id="poaFile" accept="application/pdf,image/*">
                <div class="text-5xl mb-3 opacity-50 group-hover:opacity-100 transition grayscale group-hover:grayscale-0">âš–ï¸</div>
                <h3 class="text-lg font-bold text-gray-700">2. ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„ÙˆÙƒØ§Ù„Ø©</h3>
                <p id="poaMsg" class="text-sm text-gray-400 mt-2">Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ù„Ù Ù„Ù„Ø¥ÙÙ„Ø§Øª</p>
            </div>
        </div>

        <!-- Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
        <div id="loaderSection" class="hidden text-center py-10">
            <span class="loader"></span>
            <p class="mt-4 text-orange-800 font-bold animate-pulse">Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ù‡ÙˆÙŠØ§Øª...</p>
        </div>

        <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ -->
        <div id="resultsSection" class="hidden space-y-8 animate-fade-in-up">
            
            <!-- 1. Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…ØªÙˆÙÙ‰ (Ù…ÙØµÙˆÙ„Ø©) -->
            <div id="deceasedSection" class="hidden deceased-card p-6 shadow-lg">
                <div class="flex items-center gap-4">
                    <div class="bg-white/10 p-3 rounded-full text-2xl">âš°ï¸</div>
                    <div>
                        <h2 class="text-gray-400 text-xs uppercase font-bold tracking-wider">Ø§Ù„Ù…ÙˆØ±Ø« (Ø§Ù„Ù…ØªÙˆÙÙ‰)</h2>
                        <div class="flex items-center gap-4 mt-1">
                            <span id="deceasedId" class="text-2xl font-mono font-bold text-white">---</span>
                            <span class="bg-gray-700 text-gray-300 text-xs px-2 py-1 rounded">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙˆØ±Ø«Ø© ÙˆØ§Ù„ÙˆÙƒÙ„Ø§Ø¡ -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="p-5 border-b bg-gray-50 flex justify-between items-center">
                    <h2 class="font-bold text-xl text-gray-800">ğŸ“Š Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø·Ø±Ø§Ù ÙˆØ§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©</h2>
                    <div id="statsBadge" class="text-xs font-bold px-3 py-1 rounded-full bg-blue-100 text-blue-800"></div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-right">
                        <thead class="bg-gray-100 text-gray-600 text-xs uppercase font-bold">
                            <tr>
                                <th class="p-4">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</th>
                                <th class="p-4">Ø§Ù„ØµÙØ© (Ø§Ù„Ù…Ø±ÙƒØ¨Ø©)</th>
                                <th class="p-4 text-center">Ø­Ø§Ù„Ø© Ø§Ù„ØªÙˆÙƒÙŠÙ„</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTable" class="divide-y divide-gray-100 text-sm font-medium"></tbody>
                    </table>
                </div>
            </div>

            <!-- 3. Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø© -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª -->
                <div class="bg-white p-1 rounded-xl shadow-sm border-t-4 border-blue-500">
                    <div class="p-4 flex items-center gap-2">
                        <span class="text-xl">ğŸ </span>
                        <h3 class="font-bold text-gray-800">Ø¨Ù†Ø¯ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª (Ø¨ÙŠØ¹ ÙˆØ¥ÙØ±Ø§Øº)</h3>
                    </div>
                    <div id="estateText" class="clause-box border-none bg-blue-50/50"></div>
                </div>

                <!-- Ø§Ù„Ù…Ø­Ø§ÙƒÙ… -->
                <div class="bg-white p-1 rounded-xl shadow-sm border-t-4 border-red-500">
                    <div class="p-4 flex items-center gap-2">
                        <span class="text-xl">âš–ï¸</span>
                        <h3 class="font-bold text-gray-800">Ø¨Ù†Ø¯ Ø§Ù„Ù…Ø­Ø§ÙƒÙ… (Ù‚Ø³Ù…Ø© Ø§Ù„ØªØ±ÙƒØ©)</h3>
                    </div>
                    <div id="legalText" class="clause-box border-none bg-red-50/50"></div>
                </div>
                
                <!-- Ø§Ù„Ù†Ø·Ø§Ù‚ -->
                <div class="bg-white p-1 rounded-xl shadow-sm border-t-4 border-amber-500 lg:col-span-2">
                    <div class="p-4 flex items-center gap-2">
                        <span class="text-xl">ğŸ“</span>
                        <h3 class="font-bold text-gray-800">Ù†Ø·Ø§Ù‚ Ø§Ù„ÙˆÙƒØ§Ù„Ø©</h3>
                    </div>
                    <div id="scopeText" class="clause-box border-none bg-amber-50/50"></div>
                </div>
            </div>

        </div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let files = { heirs: null, poa: null };

        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª
        setupDropZone('heirs');
        setupDropZone('poa');

        function setupDropZone(key) {
            const zone = document.getElementById(`${key}Zone`);
            const input = document.getElementById(`${key}File`);
            const msg = document.getElementById(`${key}Msg`);

            input.addEventListener('change', (e) => handleFile(e.target.files[0], key, zone, msg));
            zone.addEventListener('dragover', (e) => { e.preventDefault(); zone.classList.add('active'); });
            zone.addEventListener('dragleave', () => zone.classList.remove('active'));
            zone.addEventListener('drop', (e) => {
                e.preventDefault();
                zone.classList.remove('active');
                handleFile(e.dataTransfer.files[0], key, zone, msg);
            });
        }

        function handleFile(file, key, zone, msg) {
            if(!file) return;
            files[key] = file;
            zone.style.borderColor = '#f97316'; // Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ
            zone.style.backgroundColor = '#fff7ed';
            msg.innerHTML = `<span class="font-bold text-orange-700">${file.name}</span><br>âœ… ØªÙ… Ø§Ù„Ø±ÙØ¹`;
            
            if(files.heirs && files.poa) processFiles();
        }

        async function processFiles() {
            document.getElementById('loaderSection').classList.remove('hidden');
            document.getElementById('resultsSection').classList.add('hidden');

            try {
                // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†ØµÙˆØµ
                const hText = await extractText(files.heirs);
                const pText = await extractText(files.poa);

                // ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                const heirsData = parseHeirsDoc(hText);
                const poaData = parsePOADoc(pText);

                // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
                renderData(heirsData, poaData);

            } catch (err) {
                console.error(err);
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
            } finally {
                document.getElementById('loaderSection').classList.add('hidden');
                document.getElementById('resultsSection').classList.remove('hidden');
            }
        }

        // --- Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ­Ù„ÙŠÙ„ÙŠ ---

        function parseHeirsDoc(text) {
            const clean = toEng(normalize(text));
            // ÙØµÙ„ Ø§Ù„Ù…ØªÙˆÙÙ‰ Ø¹Ù† Ø§Ù„ÙˆØ±Ø«Ø©
            // Ù†Ø¨Ø­Ø« Ø¹Ù† "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ±Ø«Ø©" ÙƒÙ†Ù‚Ø·Ø© ÙØµÙ„
            let splitIdx = clean.indexOf("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ±Ø«Ø©");
            if (splitIdx === -1) splitIdx = clean.length * 0.3; // Ø§ÙØªØ±Ø§Ø¶ Ø£ÙˆÙ„ 30% Ù„Ù„Ù…ØªÙˆÙÙ‰

            const top = clean.substring(0, splitIdx);
            const bottom = clean.substring(splitIdx);

            const decId = (top.match(/1\d{9}/) || [])[0];
            let heirs = [...new Set(bottom.match(/1\d{9}/g) || [])];
            
            // ØªÙ†Ø¸ÙŠÙ Ø§Ù„ÙˆØ±Ø«Ø© Ù…Ù† Ù‡ÙˆÙŠØ© Ø§Ù„Ù…ØªÙˆÙÙ‰
            if(decId) heirs = heirs.filter(h => h !== decId);

            return { decId, heirs };
        }

        function parsePOADoc(text) {
            const clean = toEng(normalize(text));
            const raw = normalize(text);

            const allIds = [...new Set(clean.match(/1\d{9}/g) || [])];
            let agentId = null;
            let principals = [];

            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆÙƒÙŠÙ„ (Ø¨Ø­Ø« Ø³ÙŠØ§Ù‚ÙŠ Ø¯Ù‚ÙŠÙ‚)
            allIds.forEach(id => {
                const idx = clean.indexOf(id);
                // Ù†Ø§ÙØ°Ø© Ø¨Ø­Ø« 60 Ø­Ø±Ù
                const context = clean.substring(Math.max(0, idx - 60), Math.min(clean.length, idx + 60));
                
                // Ø¥Ø°Ø§ ÙˆØ¬Ø¯Ù†Ø§ ÙƒÙ„Ù…Ø© "ÙˆÙƒÙŠÙ„" ÙˆÙ„Ù… Ù†Ø¬Ø¯ "Ù…ÙˆÙƒÙ„" Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø±Ù‚Ù…
                if (context.includes("ÙˆÙƒÙŠÙ„") && !context.includes("Ù…ÙˆÙƒÙ„")) {
                    agentId = id;
                } else {
                    principals.push(id);
                }
            });

            // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨Ù†ÙˆØ¯
            const clauses = extractClauses(raw);

            return { agentId, principals, clauses };
        }

        function extractClauses(text) {
            // Ø¯Ø§Ù„Ø© ØªÙ†Ù‚ÙŠØ¨ Ø¨Ø³ÙŠØ·Ø© ÙˆÙØ¹Ø§Ù„Ø©
            const findBlock = (keywords) => {
                // ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ù†Øµ Ù„ÙƒØªÙ„ ÙˆØ§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…ÙØªØ§Ø­ÙŠØ©
                const chunks = text.split(/(-|\.|\n)/).filter(c => c.length > 20);
                let best = "";
                let maxScore = 0;
                
                chunks.forEach(chunk => {
                    let score = 0;
                    keywords.forEach(kw => { if(chunk.includes(kw)) score++; });
                    if(score > maxScore) { maxScore = score; best = chunk; }
                    else if (score > 0 && score === maxScore) { best += " ... " + chunk; }
                });
                return best;
            };

            const estate = findBlock(["Ø¨ÙŠØ¹", "Ø§ÙØ±Ø§Øº", "Ø«Ù…Ù†", "Ù…Ø´ØªØ±ÙŠ", "ØµÙƒÙˆÙƒ", "Ø¹Ù‚Ø§Ø±"]);
            const legal = findBlock(["Ù…Ø­Ø§ÙƒÙ…", "ØªØ±ÙƒØ©", "Ù‚Ø³Ù…Ø©", "Ù†ØµÙŠØ¨", "Ø¯Ø¹Ø§ÙˆÙ‰"]);
            const scope = findBlock(["Ù†Ø·Ø§Ù‚", "Ø§Ø±Ø«", "Ø¹Ø§Ø¦Ø¯", "Ù…ÙˆØ±Ø«"]);

            return {
                estate: estate || "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†Øµ ØµØ±ÙŠØ­ (Ù‚Ø¯ ØªÙƒÙˆÙ† Ø¬ÙˆØ¯Ø© Ø§Ù„ØµÙˆØ±Ø© Ø¶Ø¹ÙŠÙØ©)",
                legal: legal || "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†Øµ ØµØ±ÙŠØ­",
                scope: scope || "Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø¨ÙˆØ¶ÙˆØ­"
            };
        }

        function renderData(hData, pData) {
            // 1. Ø¹Ø±Ø¶ Ø§Ù„Ù…ØªÙˆÙÙ‰
            if (hData.decId) {
                document.getElementById('deceasedSection').classList.remove('hidden');
                document.getElementById('deceasedId').innerText = hData.decId;
            }

            // 2. Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙˆØ±Ø«Ø©
            const tbody = document.getElementById('resultsTable');
            tbody.innerHTML = "";
            
            // Ø¯Ù…Ø¬ Ø§Ù„Ù‡ÙˆÙŠØ§Øª (Ø¨Ø¯ÙˆÙ† Ø§Ù„Ù…ØªÙˆÙÙ‰)
            const allIds = [...new Set([...hData.heirs, ...pData.principals, pData.agentId].filter(Boolean))];

            let countMatched = 0;

            allIds.forEach(id => {
                const isHeir = hData.heirs.includes(id);
                const isAgent = id === pData.agentId;
                const isPrincipal = pData.principals.includes(id);

                // Ø¨Ù†Ø§Ø¡ "Ø§Ù„ØµÙØ© Ø§Ù„Ù…Ø±ÙƒØ¨Ø©"
                let roles = [];
                let rowClass = "hover:bg-gray-50"; // Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
                
                if (isHeir) roles.push("ÙˆØ§Ø±Ø«");
                
                // ØªÙ…ÙŠÙŠØ² Ø§Ù„ÙˆÙƒÙŠÙ„ Ø¨Ø§Ù„Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ (ÙƒÙ…Ø§ Ø·Ù„Ø¨Øª)
                if (isAgent) {
                    roles.push("ÙˆÙƒÙŠÙ„ Ø´Ø±Ø¹ÙŠ");
                    rowClass = "agent-row"; // ÙƒÙ„Ø§Ø³ CSS Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ
                } else if (isPrincipal) {
                    roles.push("Ù…ÙˆÙƒÙ„");
                }

                // ØªÙ†Ø³ÙŠÙ‚ Ø¹Ø±Ø¶ Ø§Ù„ØµÙØ§Øª
                let roleHtml = roles.map(r => {
                    if(r === "ÙˆÙƒÙŠÙ„ Ø´Ø±Ø¹ÙŠ") return `<span class="agent-badge px-2 py-1 rounded text-xs font-bold mx-1">â˜… ÙˆÙƒÙŠÙ„</span>`;
                    if(r === "ÙˆØ§Ø±Ø«") return `<span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs mx-1">ÙˆØ§Ø±Ø«</span>`;
                    return `<span class="text-gray-600 text-xs mx-1">${r}</span>`;
                }).join(" + ");

                if (roles.length === 0) roleHtml = '<span class="text-gray-400 text-xs">Ø·Ø±Ù Ø®Ø§Ø±Ø¬ÙŠ</span>';

                // Ø­Ø§Ù„Ø© Ø§Ù„ØªÙˆÙƒÙŠÙ„
                let status = "";
                if (isPrincipal || isAgent) {
                    status = '<span class="text-emerald-600 font-bold">âœ… ØªÙ… Ø§Ù„ØªÙˆÙƒÙŠÙ„</span>';
                    if(isHeir) countMatched++;
                } else if (isHeir) {
                    status = '<span class="text-red-500 font-bold">âŒ Ù„Ù… ÙŠÙˆÙƒÙ„</span>';
                } else {
                    status = '<span class="text-gray-400">-</span>';
                }

                tbody.innerHTML += `
                    <tr class="${rowClass} border-b last:border-0 transition-colors">
                        <td class="p-4 font-mono text-gray-700">${id}</td>
                        <td class="p-4">${roleHtml}</td>
                        <td class="p-4 text-center">${status}</td>
                    </tr>
                `;
            });

            document.getElementById('statsBadge').innerText = `Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©: ${countMatched} Ù…Ù† ${hData.heirs.length} ÙˆØ±Ø«Ø©`;
            
            // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨Ù†ÙˆØ¯
            document.getElementById('estateText').innerText = pData.clauses.estate;
            document.getElementById('legalText').innerText = pData.clauses.legal;
            document.getElementById('scopeText').innerText = pData.clauses.scope;
        }

        // --- Ø£Ø¯ÙˆØ§Øª ---
        async function extractText(file) {
            if(file.type === 'application/pdf') {
                const doc = await pdfjsLib.getDocument(await file.arrayBuffer()).promise;
                let t = "";
                for(let i=1; i<=doc.numPages; i++) {
                    const p = await doc.getPage(i);
                    const c = await p.getTextContent();
                    t += c.items.map(s=>s.str).join(" ") + " \n ";
                }
                if(t.length < 50) return await runOCR(file);
                return t;
            }
            return await runOCR(file);
        }

        async function runOCR(f) {
            const w = await Tesseract.createWorker('ara');
            const r = await w.recognize(f);
            await w.terminate();
            return r.data.text;
        }

        function toEng(s) { return s.replace(/[Ù -Ù©]/g, d => "0123456789"['Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©'.indexOf(d)]); }
        function normalize(t) { return t.replace(/(Ø£|Ø¥|Ø¢)/g, 'Ø§').replace(/Ø©/g, 'Ù‡').replace(/Ù‰/g, 'ÙŠ').replace(/\s+/g, ' '); }

    </script>
</body>
</html>
