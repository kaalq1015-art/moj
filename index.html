<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ูุธุงู ุงููุฏูู ุงูุนุฏูู ุงููุชูุฏู | MOJ Pro Analyzer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Tajawal', sans-serif; background: #f8fafc; color: #1e293b; }
        
        /* ุชุฃุซูุฑ ุงูุฒุฌุงุฌ ุงูุงุญุชุฑุงูู */
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.08);
        }

        /* ุชูุณูู ุงููุตูุต ุงููุณุชุฎุฑุฌุฉ */
        .extracted-text-box {
            background-color: #f1f5f9;
            border-right: 4px solid;
            font-size: 0.9rem;
            line-height: 1.8;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap; /* ูุญุงูุธ ุนูู ุงูุชูุณูู */
        }

        .loader-ring {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div class="max-w-7xl mx-auto space-y-8">
        
        <header class="text-center md:text-right flex flex-col md:flex-row justify-between items-center bg-white p-6 rounded-2xl shadow-sm border-b-4 border-emerald-600">
            <div>
                <h1 class="text-3xl font-black text-slate-800">ุงููุฏูู ุงูุนุฏูู ุงูุฐูู <span class="text-emerald-600">Pro</span></h1>
                <p class="text-slate-500 mt-2 font-medium">ูุธุงู ูุทุงุจูุฉ ุงูููุงูุงุช ูุชุญููู ุงูุจููุฏ ุจุฏูุฉ ุนุงููุฉ</p>
            </div>
            <button id="analyzeBtn" class="mt-4 md:mt-0 bg-emerald-600 hover:bg-emerald-700 text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-emerald-200 transition-all flex items-center gap-3">
                <span>ุชุดุบูู ุงูุชุญููู ุงูุดุงูู</span>
                <div id="loadingSpinner" class="hidden loader-ring"></div>
            </button>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="glass-panel p-6 rounded-2xl relative overflow-hidden group">
                <div class="absolute top-0 right-0 w-2 h-full bg-emerald-500"></div>
                <h3 class="text-xl font-bold text-emerald-900 mb-2 flex items-center gap-2">
                    ๐ 1. ุตู ุญุตุฑ ุงููุฑุซุฉ
                </h3>
                <p class="text-sm text-slate-500 mb-4">ุงููุตุฏุฑ ุงูุฃุณุงุณู ูุฃุณูุงุก ูุฃุฑูุงู ุงููุฑุซุฉ</p>
                <input type="file" id="heirsInput" accept="image/*,application/pdf" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-bold file:bg-emerald-50 file:text-emerald-700 hover:file:bg-emerald-100 cursor-pointer transition-colors">
            </div>

            <div class="glass-panel p-6 rounded-2xl relative overflow-hidden group">
                <div class="absolute top-0 right-0 w-2 h-full bg-blue-500"></div>
                <h3 class="text-xl font-bold text-blue-900 mb-2 flex items-center gap-2">
                    โ๏ธ 2. ูุซููุฉ ุงูููุงูุฉ
                </h3>
                <p class="text-sm text-slate-500 mb-4">ุงููุซููุฉ ุงููุฑุงุฏ ุงูุชุญูู ูู ุตูุงุญูุงุชูุง ูุฃุทุฑุงููุง</p>
                <input type="file" id="poaInput" accept="image/*,application/pdf" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-bold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer transition-colors">
            </div>
        </div>

        <div id="resultsArea" class="hidden space-y-8 animate-fade-in-up">
            
            <div class="glass-panel p-8 rounded-2xl">
                <h2 class="text-2xl font-bold text-slate-800 mb-6 border-b pb-4">ูุชุงุฆุฌ ูุทุงุจูุฉ ุงููููุงุช (Verification Report)</h2>
                <div class="overflow-x-auto rounded-xl border border-slate-200">
                    <table class="w-full text-right bg-white">
                        <thead class="bg-slate-50 text-slate-600 text-sm uppercase font-bold">
                            <tr>
                                <th class="p-4">ุฑูู ุงููููุฉ (English)</th>
                                <th class="p-4">ุงูุฏูุฑ ุงูููุชุดู</th>
                                <th class="p-4 text-center">ุงููุชูุฌุฉ ุงูููุงุฆูุฉ</th>
                            </tr>
                        </thead>
                        <tbody id="matchTableBody" class="divide-y divide-slate-100 font-mono text-sm"></tbody>
                    </table>
                </div>
                <div id="summaryFooter" class="mt-4 text-center font-bold text-lg"></div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <div class="flex items-center gap-2 mb-4">
                        <span class="w-3 h-3 rounded-full bg-amber-500"></span>
                        <h3 class="font-bold text-slate-800">ูุทุงู ุงูููุงูุฉ (Scope)</h3>
                    </div>
                    <div id="scopeBox" class="extracted-text-box p-4 rounded-lg border-amber-400 text-slate-600">
                        ุฌุงุฑู ุงูุงุณุชุฎุฑุงุฌ...
                    </div>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <div class="flex items-center gap-2 mb-4">
                        <span class="w-3 h-3 rounded-full bg-blue-500"></span>
                        <h3 class="font-bold text-slate-800">ุจูุฏ ุงูุนูุงุฑุงุช (Real Estate)</h3>
                    </div>
                    <div id="estateBox" class="extracted-text-box p-4 rounded-lg border-blue-400 text-slate-600">
                        ุฌุงุฑู ุงูุงุณุชุฎุฑุงุฌ...
                    </div>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <div class="flex items-center gap-2 mb-4">
                        <span class="w-3 h-3 rounded-full bg-red-500"></span>
                        <h3 class="font-bold text-slate-800">ุงููุทุงูุจุงุช ูุงููุณูุฉ (Legal)</h3>
                    </div>
                    <div id="legalBox" class="extracted-text-box p-4 rounded-lg border-red-400 text-slate-600">
                        ุฌุงุฑู ุงูุงุณุชุฎุฑุงุฌ...
                    </div>
                </div>

            </div>
        </div>

    </div>

    <script>
        // ุฅุนุฏุงุฏ ููุชุจุฉ PDF
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // ุฏุงูุฉ ุชุญููู ุงูุฃุฑูุงู ุงูุนุฑุจูุฉ ูุฅูุฌููุฒูุฉ (ุงูุณุฑ ูู ุงูุฏูุฉ)
        function toEnglishDigits(str) {
            const arabicNumbers = ["ู", "ูก", "ูข", "ูฃ", "ูค", "ูฅ", "ูฆ", "ูง", "ูจ", "ูฉ"];
            return str.replace(/[ู-ูฉ]/g, function(w) {
                return arabicNumbers.indexOf(w);
            });
        }

        // ุฏุงูุฉ ุชูุธูู ุงููุตูุต ุงูุนุฑุจูุฉ
        function normalizeArabic(text) {
            text = text.replace(/(ุฃ|ุฅ|ุข)/g, 'ุง');
            text = text.replace(/(ุฉ)/g, 'ู');
            text = text.replace(/(ู)/g, 'ู');
            // ุฅุฒุงูุฉ ุงูุชุดููู ูุงูุชุทููู
            text = text.replace(/[\u064B-\u065F\u0640]/g, '');
            return text;
        }

        let store = { heirs: [], poaPrincipals: [], poaAgent: null, poaText: "" };

        document.getElementById('analyzeBtn').addEventListener('click', async () => {
            const hFile = document.getElementById('heirsInput').files[0];
            const pFile = document.getElementById('poaInput').files[0];

            if(!hFile || !pFile) {
                alert("๐ด ูุถูุงู.. ูุฌุจ ุฅุฑูุงู ููู ุงููุฑุซุฉ ูููู ุงูููุงูุฉ ุฃููุงู");
                return;
            }

            // ุชูุนูู ุญุงูุฉ ุงูุชุญููู
            const btn = document.getElementById('analyzeBtn');
            const spinner = document.getElementById('loadingSpinner');
            btn.disabled = true;
            btn.classList.add('opacity-75');
            spinner.classList.remove('hidden');

            try {
                // 1. ูุนุงูุฌุฉ ุตู ุงูุญุตุฑ
                const hRawText = await extractText(hFile);
                // ุชุญููู ุงูุฃุฑูุงู ูุงุณุชุฎุฑุงุฌ ุงููููุงุช
                const hCleanText = toEnglishDigits(hRawText);
                store.heirs = [...new Set(hCleanText.match(/1\d{9}/g) || [])];

                // 2. ูุนุงูุฌุฉ ุงูููุงูุฉ
                const pRawText = await extractText(pFile);
                const pCleanText = toEnglishDigits(pRawText); // ูุณุฎุฉ ููุฃุฑูุงู
                store.poaText = normalizeArabic(pRawText); // ูุณุฎุฉ ูููุตูุต (ุจุฏูู ุชุญููู ุฃุฑูุงู ุนุดุงู ุงูุณูุงู)
                
                // ุงูุจุญุซ ุนู ุงููููู (ุงูุฐู ูุธูุฑ ุจุฌุงูุจู ูููุฉ ูููู)
                // ูุณุชุฎุฏู ุงููุต ุงูููุธู ููุจุญุซ ุนู "ูููู" ูุงููุต ุงูุฑููู ูุงุณุชุฎุฑุงุฌ ุงููููุฉ
                const pTextForAnalysis = toEnglishDigits(normalizeArabic(pRawText)); 
                
                // ุชุญุฏูุฏ ุงููููููู ูุงููููู
                const allPoaIds = [...new Set(pTextForAnalysis.match(/1\d{9}/g) || [])];
                
                store.poaPrincipals = [];
                store.poaAgent = null;

                // ููุทู ุฐูู ูุชุญุฏูุฏ ุงููููู: ุงูุจุญุซ ูู ูุญูุท ุงูุฑูู ุนู ูููุฉ "ูููู"
                allPoaIds.forEach(id => {
                    const index = pTextForAnalysis.indexOf(id);
                    const context = pTextForAnalysis.substring(Math.max(0, index - 50), Math.min(pTextForAnalysis.length, index + 50));
                    
                    if (context.includes("ูููู") && !context.includes("ูููู")) {
                        store.poaAgent = id;
                    } else {
                        store.poaPrincipals.push(id);
                    }
                });

                // ูู ุญุงู ูู ููุฌุญ ุงูู Regex ูู ุชุญุฏูุฏ ุงููููู ุจุฏูุฉุ ูุนุชุจุฑ ุฃูู ุงุณู ูู ุงูุฌุฏูู ูููููู ูุงูุฃุฎูุฑ ูููู (ุงูุชุฑุงุถ ุดุงุฆุน)
                // ููู ุณูุนุชูุฏ ุนูู ุงููุทุงุจูุฉ ูุน ุงููุฑุซุฉ ูุชุตุญูุญ ุฐูู

                renderResults();
                extractClauses(store.poaText); // ูุฑุณู ุงููุต ุงูุนุฑุจู ุงูุฃุตูู (ุงูููุธู) ูุงุณุชุฎุฑุงุฌ ุงูุจููุฏ

            } catch (err) {
                console.error(err);
                alert("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ูุฑุงุกุฉ ุงููููุงุชุ ุชุฃูุฏ ูู ุฌูุฏุฉ ุงูุตูุฑ.");
            } finally {
                btn.disabled = false;
                btn.classList.remove('opacity-75');
                spinner.classList.add('hidden');
            }
        });

        // ุฏุงูุฉ ุงูุงุณุชุฎุฑุงุฌ ุงูููุญุฏุฉ (PDF ุฃู ุตูุฑุฉ)
        async function extractText(file) {
            if (file.type === 'application/pdf') {
                const buffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(buffer).promise;
                let fullText = "";
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    fullText += textContent.items.map(s => s.str).join(" ");
                }
                // ุฅุฐุง ูุงู ุงูู PDF ุตูุฑุฉ (ููุณูุญ ุถูุฆูุงู)ุ ุงููุต ุณูููู ูุงุฑุบุงูุ ูุญููู ูุตูุฑ
                if (fullText.trim().length < 50) {
                    return await performOCR(file); // ูุณุชุฎุฏู OCR
                }
                return fullText;
            } else {
                return await performOCR(file);
            }
        }

        async function performOCR(file) {
            const worker = await Tesseract.createWorker('ara'); // ุงููุบุฉ ุงูุนุฑุจูุฉ
            const ret = await worker.recognize(file);
            await worker.terminate();
            return ret.data.text;
        }

        // ุงุณุชุฎุฑุงุฌ ุงูุจููุฏ ุจุฐูุงุก (Regex ูุชุทูุฑ)
        function extractClauses(text) {
            // ุชูุธูู ุงููุณุงูุงุช ุงูุฒุงุฆุฏุฉ ูุงูุฃุณุทุฑ ุงูุฌุฏูุฏุฉ ุงูุนุดูุงุฆูุฉ
            const clean = text.replace(/\s+/g, ' ');

            // 1. ุงููุทุงู: ูุฃุชู ุบุงูุจุงู ุจุนุฏ "ุงููุทุงู :" ููุจู "ุงูุจููุฏ"
            const scopeMatch = clean.match(/ุงููุทุงู\s*:?([\s\S]*?)(?=ุงูุจููุฏ|ุงูุจูุฏ)/);
            document.getElementById('scopeBox').innerText = scopeMatch ? scopeMatch[1].trim() : "ูู ูุชู ุงูุนุซูุฑ ุนูู ูุต ุงููุทุงู ุจุดูู ุตุฑูุญ.";

            // 2. ุงูุนูุงุฑุงุช: ูุจุญุซ ุนู ูููุฉ ุงูุนูุงุฑุงุช ููุง ุจุนุฏูุง ุญุชู ูุฌุฏ ูุงุตู ููุทูู
            const estateMatch = clean.match(/ุงูุนูุงุฑุงุช\s*([\s\S]*?)(?=ุงููุทุงูุจุงุช|ุงููุญุงูู|ุงูุจููู|ุงูุดุฑูุงุช|ุงูุจูุฏ|$)/);
            document.getElementById('estateBox').innerText = estateMatch ? estateMatch[1].trim() : "ูู ูุชู ุงูุนุซูุฑ ุนูู ุจูุฏ ุงูุนูุงุฑุงุช.";

            // 3. ุงููุญุงูู ูุงููุณูุฉ
            // ูุจุญุซ ุนู ุฃู ูู ุงููููุงุช ุงูููุชุงุญูุฉ
            const legalMatch = clean.match(/(ุงููุทุงูุจุงุช ูุงููุญุงูู|ูุณูู ุงูุชุฑูู|ูุฑุฒ ุงููุตูุจ)([\s\S]*?)(?=ุงูุจููู|ุงูุดุฑูุงุช|ุงูุนูุงุฑุงุช|ุงูุจูุฏ|$)/);
            document.getElementById('legalBox').innerText = legalMatch ? 
                (legalMatch[1] + " " + legalMatch[2]).trim() : 
                "โ๏ธ ูู ูุชู ุงูุนุซูุฑ ุนูู ูุต ุตุฑูุญ ููุณูุฉ ุงูุชุฑูุฉ ุฃู ุงููุญุงูู.";
        }

        function renderResults() {
            const container = document.getElementById('resultsArea');
            container.classList.remove('hidden');
            const tbody = document.getElementById('matchTableBody');
            tbody.innerHTML = '';

            // ุชุฌููุน ูู ุงููููุงุช ุงููุฑูุฏุฉ
            const allIdentities = [...new Set([...store.heirs, ...store.poaPrincipals, store.poaAgent].filter(Boolean))];
            
            let matchCount = 0;

            allIdentities.forEach(id => {
                const isHeir = store.heirs.includes(id);
                const isAgent = id === store.poaAgent;
                const isPrincipal = store.poaPrincipals.includes(id);

                // ุชุญุฏูุฏ ุงูุฏูุฑ
                let roleHTML = "";
                if (isAgent) roleHTML = '<span class="text-blue-600 font-bold bg-blue-50 px-2 py-1 rounded">ุงููููู ุงููููุถ ๐ค</span>';
                else if (isPrincipal) roleHTML = '<span class="text-emerald-700 font-bold">ูููู (ุทุฑู ูู ุงูููุงูุฉ)</span>';
                else roleHTML = '<span class="text-slate-400">ุบูุฑ ูุฐููุฑ ูู ุงูููุงูุฉ</span>';

                if (isHeir) roleHTML += ' <span class="text-xs text-amber-600 block mt-1">โจ (ุฃุญุฏ ุงููุฑุซุฉ)</span>';

                // ุชุญุฏูุฏ ุงููุชูุฌุฉ
                let statusHTML = "";
                if (isPrincipal || isAgent) {
                    statusHTML = '<span class="inline-flex items-center gap-1 bg-emerald-100 text-emerald-800 px-3 py-1 rounded-full font-bold">โ ุชู ุงูุชูููู</span>';
                    if(isHeir) matchCount++;
                } else {
                    statusHTML = '<span class="inline-flex items-center gap-1 bg-rose-100 text-rose-800 px-3 py-1 rounded-full font-bold">โ ูู ูููู</span>';
                }

                const tr = `
                    <tr class="hover:bg-slate-50 transition-colors">
                        <td class="p-4 text-slate-700 font-mono text-base">${id}</td>
                        <td class="p-4">${roleHTML}</td>
                        <td class="p-4 text-center">${statusHTML}</td>
                    </tr>
                `;
                tbody.innerHTML += tr;
            });

            // ููุฎุต ุงููุชูุฌุฉ
            const footer = document.getElementById('summaryFooter');
            const totalHeirs = store.heirs.length;
            
            if (totalHeirs > 0 && matchCount === totalHeirs) {
                footer.innerHTML = `<span class="text-emerald-600">๐ ุงูุชูู ุงููุตุงุจ! ุฌููุน ุงููุฑุซุฉ (${totalHeirs}) ูุงููุง ุจุฅุตุฏุงุฑ ุงูููุงูุฉ.</span>`;
            } else if (totalHeirs > 0) {
                footer.innerHTML = `<span class="text-amber-600">โ๏ธ ุชูุจูู: ุชู ุชูููู ${matchCount} ููุท ูู ุฃุตู ${totalHeirs} ูุฑุซุฉ.</span>`;
            }
        }
    </script>
</body>
</html>
