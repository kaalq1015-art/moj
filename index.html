<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù…Ø­Ù„Ù„ Ø§Ù„Ø¹Ø¯Ù„ÙŠ Ø§Ù„Ù…Ø§Ø³ÙŠ | MOJ Diamond Scanner</title>
    
    <!-- Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Ø®Ø·ÙˆØ· Ø¹Ø±Ø¨ÙŠØ© -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Cairo', sans-serif; background: #f3f4f6; color: #1f2937; }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ø³Ø­Ø¨ */
        .drop-area {
            border: 3px dashed #cbd5e1;
            background: #ffffff;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .drop-area.active {
            border-color: #059669;
            background: #ecfdf5;
            transform: scale(1.02);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .drop-area input {
            position: absolute; width: 100%; height: 100%; top: 0; left: 0; opacity: 0; cursor: pointer;
        }
        
        /* ØµÙ†Ø§Ø¯ÙŠÙ‚ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ */
        .result-card {
            background: white; border-radius: 16px; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            overflow: hidden;
        }
        
        .clause-content {
            white-space: pre-wrap;
            line-height: 1.8;
            font-size: 0.9rem;
            color: #374151;
            background: #f9fafb;
            border-top: 1px solid #e5e7eb;
            padding: 1rem;
            max-height: 300px;
            overflow-y: auto;
        }

        /* Ø´Ø§Ø±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© */
        .badge { padding: 4px 10px; border-radius: 8px; font-weight: 700; font-size: 0.75rem; display: inline-flex; align-items: center; gap: 4px; }
        .badge-green { background: #d1fae5; color: #065f46; }
        .badge-red { background: #fee2e2; color: #991b1b; }
        .badge-blue { background: #dbeafe; color: #1e40af; }
        .badge-gray { background: #f3f4f6; color: #4b5563; }
        
        .loader {
            width: 48px; height: 48px;
            border: 5px solid #059669;
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div class="max-w-7xl mx-auto space-y-8">
        
        <!-- Ø§Ù„Ø±Ø£Ø³ -->
        <header class="bg-white p-6 rounded-2xl shadow-sm border-b-4 border-emerald-600 flex flex-wrap justify-between items-center gap-4">
            <div>
                <h1 class="text-3xl font-black text-gray-800">Ø§Ù„Ù…Ø­Ù„Ù„ Ø§Ù„Ø¹Ø¯Ù„ÙŠ <span class="text-emerald-600">Ø§Ù„Ù…Ø§Ø³ÙŠ</span></h1>
                <p class="text-gray-500 font-medium mt-1">ØªÙ‚Ù†ÙŠØ© Ø§Ù„ØªÙ†Ù‚ÙŠØ¨ Ø¹Ù† Ø§Ù„Ø¨Ù†ÙˆØ¯ (Clause Mining) â€¢ Ù…Ø·Ø§Ø¨Ù‚Ø© Ø¯Ù‚ÙŠÙ‚Ø©</p>
            </div>
            <button onclick="location.reload()" class="text-sm text-red-500 hover:text-red-700 underline font-bold">Ø¨Ø¯Ø¡ ØªØ­Ù„ÙŠÙ„ Ø¬Ø¯ÙŠØ¯ â†»</button>
        </header>

        <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            
            <!-- ØµÙƒ Ø§Ù„Ø­ØµØ± -->
            <div id="heirsZone" class="drop-area p-8 rounded-2xl text-center group">
                <input type="file" id="heirsFile" accept="application/pdf,image/*">
                <div class="text-5xl mb-3 opacity-50 group-hover:opacity-100 transition">ğŸ“„</div>
                <h3 class="text-lg font-bold text-gray-700">1. ØµÙƒ Ø­ØµØ± Ø§Ù„ÙˆØ±Ø«Ø©</h3>
                <p id="heirsMsg" class="text-sm text-gray-400 mt-2">Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ù„Ù Ù‡Ù†Ø§</p>
            </div>

            <!-- Ø§Ù„ÙˆÙƒØ§Ù„Ø© -->
            <div id="poaZone" class="drop-area p-8 rounded-2xl text-center group">
                <input type="file" id="poaFile" accept="application/pdf,image/*">
                <div class="text-5xl mb-3 opacity-50 group-hover:opacity-100 transition">âš–ï¸</div>
                <h3 class="text-lg font-bold text-gray-700">2. ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„ÙˆÙƒØ§Ù„Ø©</h3>
                <p id="poaMsg" class="text-sm text-gray-400 mt-2">Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ù„Ù Ù‡Ù†Ø§</p>
            </div>
        </div>

        <!-- Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
        <div id="loadingSection" class="hidden text-center py-12">
            <span class="loader"></span>
            <p class="mt-4 text-emerald-800 font-bold animate-pulse text-lg">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†Ù‚ÙŠØ¨ Ø¹Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø¨Ù†ÙˆØ¯...</p>
        </div>

        <!-- Ø§Ù„Ù†ØªØ§Ø¦Ø¬ -->
        <div id="resultsSection" class="hidden space-y-8 animate-fade-in">
            
            <!-- 1. Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© -->
            <div class="result-card">
                <div class="p-4 bg-gray-50 border-b flex justify-between items-center">
                    <h2 class="font-bold text-xl text-gray-800">ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø·Ø±Ø§Ù (Ø§Ù„ÙˆØ±Ø«Ø© ÙˆØ§Ù„ÙˆÙƒÙ„Ø§Ø¡)</h2>
                    <span id="matchSummary" class="text-sm font-bold px-3 py-1 rounded-lg bg-gray-200"></span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-right">
                        <thead class="bg-gray-100 text-gray-600 text-xs uppercase font-bold">
                            <tr>
                                <th class="p-4">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</th>
                                <th class="p-4">Ø§Ù„ØµÙØ© ÙÙŠ Ø§Ù„Ø­ØµØ±</th>
                                <th class="p-4">Ø§Ù„Ø¯ÙˆØ± ÙÙŠ Ø§Ù„ÙˆÙƒØ§Ù„Ø©</th>
                                <th class="p-4 text-center">Ø§Ù„Ù†ØªÙŠØ¬Ø©</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTable" class="divide-y divide-gray-100 text-sm font-medium"></tbody>
                    </table>
                </div>
            </div>

            <!-- 2. Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø© (Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© Ø§Ù„ØªÙ†Ù‚ÙŠØ¨) -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                
                <!-- Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª -->
                <div class="result-card border-t-4 border-blue-500">
                    <div class="p-4 flex items-center gap-2 bg-white">
                        <span class="text-2xl">ğŸ </span>
                        <h3 class="font-bold text-lg text-gray-800">Ø¨Ù†Ø¯ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª (Ø¨ÙŠØ¹ ÙˆØ¥ÙØ±Ø§Øº)</h3>
                    </div>
                    <div id="estateText" class="clause-content">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</div>
                </div>

                <!-- Ø§Ù„Ù…Ø­Ø§ÙƒÙ… -->
                <div class="result-card border-t-4 border-red-500">
                    <div class="p-4 flex items-center gap-2 bg-white">
                        <span class="text-2xl">âš–ï¸</span>
                        <h3 class="font-bold text-lg text-gray-800">Ø¨Ù†Ø¯ Ø§Ù„Ù…Ø­Ø§ÙƒÙ… (Ù‚Ø³Ù…Ø© Ø§Ù„ØªØ±ÙƒØ©)</h3>
                    </div>
                    <div id="legalText" class="clause-content">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</div>
                </div>

                <!-- Ø§Ù„Ù†Ø·Ø§Ù‚ -->
                <div class="result-card border-t-4 border-amber-500 lg:col-span-2">
                    <div class="p-4 flex items-center gap-2 bg-white">
                        <span class="text-2xl">ğŸ“</span>
                        <h3 class="font-bold text-lg text-gray-800">Ù†Ø·Ø§Ù‚ Ø§Ù„ÙˆÙƒØ§Ù„Ø© (Ø§Ù„ÙˆØ±Ø«Ø© Ø§Ù„Ù…Ø´Ù…ÙˆÙ„ÙŠÙ†)</h3>
                    </div>
                    <div id="scopeText" class="clause-content">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</div>
                </div>

            </div>
            
            <div class="text-center mt-4">
                <button onclick="toggleDebug()" class="text-xs text-gray-400 underline hover:text-gray-600">Ø¹Ø±Ø¶ Ø§Ù„Ù†Øµ Ø§Ù„Ø®Ø§Ù… Ù„Ù„Ù…Ø¨Ø±Ù…Ø¬</button>
                <div id="debugBox" class="hidden mt-4 p-4 bg-gray-900 text-green-400 text-left dir-ltr font-mono text-xs rounded-lg h-64 overflow-auto"></div>
            </div>
        </div>

    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let files = { heirs: null, poa: null };

        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª
        ['heirs', 'poa'].forEach(type => {
            const zone = document.getElementById(`${type}Zone`);
            const input = document.getElementById(`${type}File`);
            const msg = document.getElementById(`${type}Msg`);

            // Event Listeners
            input.addEventListener('change', (e) => handleFile(e.target.files[0], type, zone, msg));
            zone.addEventListener('dragover', (e) => { e.preventDefault(); zone.classList.add('active'); });
            zone.addEventListener('dragleave', () => zone.classList.remove('active'); );
            zone.addEventListener('drop', (e) => {
                e.preventDefault();
                zone.classList.remove('active');
                handleFile(e.dataTransfer.files[0], type, zone, msg);
            });
        });

        function handleFile(file, type, zone, msg) {
            if(!file) return;
            files[type] = file;
            zone.style.borderColor = '#10b981';
            zone.style.backgroundColor = '#ecfdf5';
            msg.innerHTML = `<span class="font-bold text-emerald-700">${file.name}</span><br>âœ… ØªÙ… Ø§Ù„Ø±ÙØ¹`;
            
            if(files.heirs && files.poa) startProcessing();
        }

        async function startProcessing() {
            document.getElementById('loadingSection').classList.remove('hidden');
            document.getElementById('resultsSection').classList.add('hidden');

            try {
                // 1. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†ØµÙˆØµ (OCR Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±)
                const hText = await extractContent(files.heirs);
                const pText = await extractContent(files.poa);

                // Ø¹Ø±Ø¶ Ø§Ù„Ù†Øµ Ø§Ù„Ø®Ø§Ù… Ù„Ù„ØªØµØ­ÙŠØ­
                document.getElementById('debugBox').innerText = "--- POA RAW TEXT ---\n" + pText;

                // 2. ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                const heirsData = parseHeirship(hText);
                const poaData = parsePOA(pText);

                // 3. Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
                renderResults(heirsData, poaData);

            } catch (err) {
                console.error(err);
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£: " + err.message);
            } finally {
                document.getElementById('loadingSection').classList.add('hidden');
                document.getElementById('resultsSection').classList.remove('hidden');
            }
        }

        // --- Ù…Ø­Ø±Ùƒ Ø§Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„ (Core Engine) ---

        function parseHeirship(text) {
            const clean = toEnglishDigits(normalize(text));
            
            // ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ù†Øµ Ø¥Ù„Ù‰ Ø¬Ø²Ø£ÙŠÙ†: Ø§Ù„Ù…ØªÙˆÙÙ‰ (Ø¹Ø§Ø¯Ø© ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰) ÙˆØ§Ù„ÙˆØ±Ø«Ø© (ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„)
            // Ù…ÙØªØ§Ø­ Ø§Ù„ÙØµÙ„: "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ±Ø«Ø©" Ø£Ùˆ "ØµÙ„Ø© Ø§Ù„Ù‚Ø±Ø§Ø¨Ø©"
            let splitIndex = clean.indexOf("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ±Ø«Ø©");
            if (splitIndex === -1) splitIndex = clean.indexOf("ØµÙ„Ø© Ø§Ù„Ù‚Ø±Ø§Ø¨Ø©");
            if (splitIndex === -1) splitIndex = clean.length * 0.4; // Ø§ÙØªØ±Ø§Ø¶ÙŠ: Ø£ÙˆÙ„ 40% Ù„Ù„Ù…ØªÙˆÙÙ‰

            const topPart = clean.substring(0, splitIndex);
            const bottomPart = clean.substring(splitIndex);

            // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù‡ÙˆÙŠØ© Ø§Ù„Ù…ØªÙˆÙÙ‰ (Ø£ÙˆÙ„ Ù‡ÙˆÙŠØ© ÙÙŠ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø¹Ù„ÙˆÙŠ)
            const deceasedMatch = topPart.match(/1\d{9}/);
            const deceasedId = deceasedMatch ? deceasedMatch[0] : null;

            // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ÙˆØ±Ø«Ø©
            let heirIds = [...new Set(bottomPart.match(/1\d{9}/g) || [])];
            
            // ØªÙ†Ø¸ÙŠÙ: ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù…ØªÙˆÙÙ‰ Ù„ÙŠØ³ Ø¶Ù…Ù† Ø§Ù„ÙˆØ±Ø«Ø©
            if(deceasedId) heirIds = heirIds.filter(id => id !== deceasedId);

            return { deceasedId, heirIds };
        }

        function parsePOA(text) {
            const clean = toEnglishDigits(normalize(text));
            const rawClean = normalize(text); // Ù†Øµ Ø¹Ø±Ø¨ÙŠ Ù…Ù†Ø¸Ù Ù„Ù„Ø£Ø­Ø±Ù

            // 1. ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£Ø·Ø±Ø§Ù
            const allIds = [...new Set(clean.match(/1\d{9}/g) || [])];
            let agentId = null;
            let principals = [];

            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆÙƒÙŠÙ„ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ§Ù‚ (ÙƒÙ„Ù…Ø© "ÙˆÙƒÙŠÙ„" Ø£Ùˆ Ø¢Ø®Ø± Ø§Ø³Ù… ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©)
            // ÙÙŠ ØµÙƒÙˆÙƒ Ø§Ù„ÙˆÙƒØ§Ù„Ø©ØŒ Ø¹Ø§Ø¯Ø© Ø§Ù„ÙˆÙƒÙŠÙ„ Ù‡Ùˆ Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ Ø£Ùˆ Ø§Ù„Ù…Ø°ÙƒÙˆØ± Ø¨ØµÙØ© "ÙˆÙƒÙŠÙ„"
            
            // Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆÙƒÙŠÙ„:
            // Ù†Ø¨Ø­Ø« Ø¹Ù† ÙƒÙ„ Ø±Ù‚Ù… Ù‡ÙˆÙŠØ© ÙÙŠ Ø§Ù„Ù†ØµØŒ ÙˆÙ†ÙØ­Øµ Ø§Ù„Ù€ 50 Ø­Ø±Ù Ø§Ù„Ù…Ø­ÙŠØ·Ø© Ø¨Ù‡
            let foundAgent = false;
            allIds.forEach(id => {
                const idx = clean.indexOf(id);
                // Ù†Ø£Ø®Ø° Ù†Ø§ÙØ°Ø© Ù…Ù† Ø§Ù„Ù†Øµ Ø§Ù„Ø£ØµÙ„ÙŠ (Ø§Ù„Ø¹Ø±Ø¨ÙŠ) Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„ Ù„Ù„Ù…ÙˆÙ‚Ø¹
                // (Ù‡Ø°Ø§ ØªÙ‚Ø±ÙŠØ¨ÙŠ Ù„Ø£Ù† ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ù„Ø§ ÙŠØºÙŠØ± Ø·ÙˆÙ„ Ø§Ù„Ù†Øµ)
                const context = clean.substring(Math.max(0, idx - 60), Math.min(clean.length, idx + 60));
                
                if (context.includes("ÙˆÙƒÙŠÙ„") && !context.includes("Ù…ÙˆÙƒÙ„")) {
                    agentId = id;
                    foundAgent = true;
                } else {
                    principals.push(id);
                }
            });

            // Fallback: Ø¥Ø°Ø§ Ù„Ù… Ù†Ø¬Ø¯ ÙƒÙ„Ù…Ø© "ÙˆÙƒÙŠÙ„" ØµØ±ÙŠØ­Ø© Ø¨Ø¬Ø§Ù†Ø¨ Ø±Ù‚Ù…ØŒ Ù†Ø¹ØªØ¨Ø± Ø¢Ø®Ø± Ø±Ù‚Ù… ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù‡Ùˆ Ø§Ù„ÙˆÙƒÙŠÙ„ (Ø´Ø§Ø¦Ø¹ ÙÙŠ Ø§Ù„ÙˆÙƒØ§Ù„Ø§Øª)
            // ÙˆÙ„ÙƒÙ† ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø£ÙƒØ«Ø± Ù…Ù† Ø±Ù‚Ù…
            if (!foundAgent && allIds.length > 1) {
                // ÙÙŠ Ø§Ù„ØºØ§Ù„Ø¨ØŒ Ø§Ù„ÙˆÙƒÙŠÙ„ ÙŠØ°ÙƒØ± ÙÙŠ Ø§Ù„Ù†Ù‡Ø§ÙŠØ© Ø£Ùˆ ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ù…Ù†ÙØµÙ„
                // Ø³Ù†ØªØ±ÙƒÙ‡Ø§ ÙƒÙ…Ø§ Ù‡ÙŠ (ÙƒÙ„Ù‡Ù… Ù…ÙˆÙƒÙ„ÙŠÙ†) Ù…Ø§ Ù„Ù… Ù†ÙƒÙ† Ù…ØªØ£ÙƒØ¯ÙŠÙ†ØŒ Ø£Ùˆ Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ù…Ø¹ Ø§Ù„ÙˆØ±Ø«Ø©
            }

            // 2. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨Ù†ÙˆØ¯ (Clause Mining)
            const clauses = mineClauses(rawClean);

            return { agentId, principals, clauses };
        }

        // --- Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© Ø§Ù„ØªÙ†Ù‚ÙŠØ¨ Ø¹Ù† Ø§Ù„Ø¨Ù†ÙˆØ¯ (Clause Mining Algorithm) ---
        function mineClauses(text) {
            // ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ù†Øµ Ø¥Ù„Ù‰ ÙÙ‚Ø±Ø§Øª Ø£Ùˆ Ø¬Ù…Ù„ Ø·ÙˆÙŠÙ„Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„ØªØ±Ù‚ÙŠÙ… Ø£Ùˆ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚
            // Ø¨Ù…Ø§ Ø£Ù† Ø§Ù„Ù€ OCR ÙŠØ¯Ù…Ø¬ Ø§Ù„Ø£Ø³Ø·Ø±ØŒ Ø³Ù†Ù‚Ø³Ù… Ø§Ù„Ù†Øµ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ÙƒÙ„Ù…Ø§Øª Ù…ÙØªØ§Ø­ÙŠØ© ÙƒØ¨ÙŠØ±Ø© Ø£Ùˆ ÙÙˆØ§ØµÙ„
            
            // Ù†Ù‚Ø³Ù… Ø§Ù„Ù†Øµ Ù„Ù†ÙˆØ§ÙØ° Ù…ØªØ¯Ø§Ø®Ù„Ø© Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£ÙØ¶Ù„ ØªØ·Ø§Ø¨Ù‚
            const chunks = text.split(/(-|\.|\n\n)/).map(c => c.trim()).filter(c => c.length > 20);
            
            // ÙƒÙ„Ù…Ø§Øª Ù…ÙØªØ§Ø­ÙŠØ© Ù„ÙƒÙ„ Ø¨Ù†Ø¯ (ÙˆØ²Ù† Ø¹Ø§Ù„ÙŠ)
            const estateKeys = ["Ø¨ÙŠØ¹", "Ø§ÙØ±Ø§Øº", "Ø«Ù…Ù†", "Ù…Ø´ØªØ±ÙŠ", "ØµÙƒÙˆÙƒ", "Ø¹Ù‚Ø§Ø±", "Ø´ÙŠÙƒ", "Ù‡Ø¨Ø©", "Ø±Ù‡Ù†"];
            const legalKeys = ["Ù…Ø­Ø§ÙƒÙ…", "Ø¯Ø¹Ø§ÙˆÙ‰", "Ù…Ø±Ø§ÙØ¹Ø©", "ØªØ±ÙƒØ©", "Ù†ØµÙŠØ¨", "ÙˆØµÙŠØ©", "Ø¬Ù„Ø³Ø§Øª", "ØµÙ„Ø­"];
            const scopeKeys = ["Ù†Ø·Ø§Ù‚", "Ø§Ø±Ø«", "Ø¹Ø§Ø¦Ø¯", "Ù…ÙˆØ±Ø«", "Ø­ØµØ±", "Ù…ØªÙˆÙÙ‰"];

            let estateText = "";
            let legalText = "";
            let scopeText = "";

            // Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ… (Scoring)
            const scoreChunk = (chunk, keys) => {
                let score = 0;
                keys.forEach(k => { if(chunk.includes(k)) score += 1; });
                return score;
            };

            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£ÙØ¶Ù„ Ø§Ù„ÙÙ‚Ø±Ø§Øª
            chunks.forEach(chunk => {
                if (scoreChunk(chunk, estateKeys) >= 2) estateText += chunk + " ... \n";
                if (scoreChunk(chunk, legalKeys) >= 2) legalText += chunk + " ... \n";
                if (scoreChunk(chunk, scopeKeys) >= 1) scopeText += chunk + " ... \n";
            });

            // Ø¥Ø°Ø§ Ù„Ù… Ù†Ø¬Ø¯ Ø´ÙŠØ¡ Ø¨Ø§Ù„ØªÙ‚Ø·ÙŠØ¹ØŒ Ù†Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù†Øµ Ø§Ù„ÙƒØ§Ù…Ù„ (Ø¨Ø­Ø« Ø´Ø§Ù…Ù„)
            if (!estateText) {
                const idx = text.search(/(Ø¨ÙŠØ¹|Ø§ÙØ±Ø§Øº)/);
                if (idx > -1) estateText = text.substring(idx, Math.min(text.length, idx + 400)) + "...";
            }
            if (!legalText) {
                const idx = text.search(/(Ù…Ø­Ø§ÙƒÙ…|ØªØ±ÙƒØ©)/);
                if (idx > -1) legalText = text.substring(idx, Math.min(text.length, idx + 400)) + "...";
            }

            return {
                estate: estateText || "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¨ÙŠØ¹ ØµØ±ÙŠØ­Ø© (ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬ÙˆØ¯Ø© Ø§Ù„ØµÙˆØ±Ø©).",
                legal: legalText || "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØµÙ„Ø§Ø­ÙŠØ§Øª Ù…Ø­Ø§ÙƒÙ… Ø£Ùˆ Ù‚Ø³Ù…Ø©.",
                scope: scopeText || "Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø¨Ø¯Ù‚Ø©."
            };
        }

        function renderResults(heirsData, poaData) {
            const tbody = document.getElementById('resultsTable');
            tbody.innerHTML = "";
            
            // Ø¯Ù…Ø¬ ÙƒÙ„ Ø§Ù„Ù‡ÙˆÙŠØ§Øª
            const allIds = [...new Set([heirsData.deceasedId, ...heirsData.heirIds, ...poaData.principals, poaData.agentId].filter(Boolean))];
            
            let matchedHeirs = 0;

            allIds.forEach(id => {
                const isDeceased = id === heirsData.deceasedId;
                const isHeir = heirsData.heirIds.includes(id);
                const isAgent = id === poaData.agentId;
                const isPrincipal = poaData.principals.includes(id);

                let roleHtml = isDeceased ? '<span class="badge badge-gray">Ø§Ù„Ù…ØªÙˆÙÙ‰ âš°ï¸</span>' : (isHeir ? '<span class="badge badge-blue">ÙˆØ§Ø±Ø« ğŸ‘¤</span>' : '<span class="text-xs text-gray-400">-</span>');
                
                let poaRoleHtml = isAgent ? '<span class="badge badge-green">Ø§Ù„ÙˆÙƒÙŠÙ„ Ø§Ù„Ù…ÙÙˆØ¶ ğŸŒŸ</span>' : (isPrincipal ? '<span class="font-bold text-gray-700">Ù…ÙˆÙƒÙ„</span>' : '<span class="text-red-300 text-xs">ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯</span>');

                let resultHtml = "";
                if (isDeceased) {
                    resultHtml = '<span class="text-gray-400 font-mono">-</span>';
                } else if (isPrincipal || isAgent) {
                    resultHtml = '<span class="badge badge-green">âœ… ÙˆÙƒÙ‘Ù„</span>';
                    if(isHeir) matchedHeirs++;
                } else if (isHeir) {
                    resultHtml = '<span class="badge badge-red">âŒ Ù„Ù… ÙŠÙˆÙƒÙ„</span>';
                } else {
                    resultHtml = '<span class="badge badge-gray">Ø·Ø±Ù Ø®Ø§Ø±Ø¬ÙŠ</span>';
                }

                tbody.innerHTML += `
                    <tr class="hover:bg-gray-50 border-b last:border-0">
                        <td class="p-4 font-mono text-gray-600">${id}</td>
                        <td class="p-4">${roleHtml}</td>
                        <td class="p-4">${poaRoleHtml}</td>
                        <td class="p-4 text-center">${resultHtml}</td>
                    </tr>`;
            });

            document.getElementById('matchSummary').innerText = `ØªÙ… ØªÙˆÙƒÙŠÙ„ ${matchedHeirs} Ù…Ù† Ø£ØµÙ„ ${heirsData.heirIds.length} ÙˆØ±Ø«Ø©`;
            
            // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨Ù†ÙˆØ¯
            document.getElementById('estateText').innerText = poaData.clauses.estate;
            document.getElementById('legalText').innerText = poaData.clauses.legal;
            document.getElementById('scopeText').innerText = poaData.clauses.scope;
        }

        // --- Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© (Utils) ---

        async function extractContent(file) {
            if (file.type === 'application/pdf') {
                const buffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(buffer).promise;
                let fullText = "";
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    // Ø¯Ù…Ø¬ Ø§Ù„Ù†Øµ Ø¨Ù…Ø³Ø§ÙØ© Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø§Ù„ØªØµØ§Ù‚ Ø§Ù„ÙƒÙ„Ù…Ø§Øª
                    fullText += content.items.map(item => item.str).join(" ") + " \n ";
                }
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù†Øµ Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ø¬Ø¯Ø§Ù‹ (ØµÙˆØ±Ø©)ØŒ Ù†Ø³ØªØ®Ø¯Ù… OCR
                if (fullText.length < 50) return await performOCR(file);
                return fullText;
            }
            return await performOCR(file);
        }

        async function performOCR(file) {
            const worker = await Tesseract.createWorker('ara');
            const ret = await worker.recognize(file);
            await worker.terminate();
            return ret.data.text;
        }

        function toEnglishDigits(str) {
            return str.replace(/[Ù -Ù©]/g, d => "0123456789"['Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©'.indexOf(d)]);
        }

        function normalize(text) {
            return text
                .replace(/(Ø£|Ø¥|Ø¢)/g, 'Ø§')
                .replace(/Ø©/g, 'Ù‡')
                .replace(/Ù‰/g, 'ÙŠ')
                .replace(/[\u064B-\u065F\u0640]/g, '') // ØªØ´ÙƒÙŠÙ„
                .replace(/\s+/g, ' '); // ØªÙˆØ­ÙŠØ¯ Ø§Ù„Ù…Ø³Ø§ÙØ§Øª
        }
        
        function toggleDebug() {
            document.getElementById('debugBox').classList.toggle('hidden');
        }
    </script>
</body>
</html>
