<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù…Ø­Ù„Ù„ Ø§Ù„Ø¹Ø¯Ù„ÙŠ Ø§Ù„Ù…Ø§Ø³ÙŠ | MOJ Diamond Parser</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Cairo', sans-serif; background: #f3f4f6; color: #1f2937; }
        
        .drop-area {
            border: 3px dashed #d1d5db;
            transition: all 0.3s ease;
            background: #ffffff;
        }
        .drop-area.active {
            border-color: #10b981;
            background: #ecfdf5;
            transform: scale(1.01);
        }
        
        .data-box {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }
        
        .clause-text {
            white-space: pre-wrap;
            line-height: 1.8;
            font-size: 0.95rem;
            color: #374151;
            max-height: 250px;
            overflow-y: auto;
            padding: 1rem;
            background: #f9fafb;
            border-top: 1px solid #e5e7eb;
        }

        /* Ø´Ø§Ø±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© */
        .badge { padding: 4px 12px; border-radius: 99px; font-weight: 700; font-size: 0.75rem; display: inline-flex; align-items: center; gap: 4px; }
        .badge-heir { background: #dbeafe; color: #1e40af; } /* Ø£Ø²Ø±Ù‚ Ù„Ù„ÙˆØ±Ø«Ø© */
        .badge-deceased { background: #fee2e2; color: #991b1b; } /* Ø£Ø­Ù…Ø± Ù„Ù„Ù…ØªÙˆÙÙ‰ */
        .badge-agent { background: #fef3c7; color: #92400e; } /* Ø°Ù‡Ø¨ÙŠ Ù„Ù„ÙˆÙƒÙŠÙ„ */
        
        .loader {
            width: 48px; height: 48px;
            border: 5px solid #10b981;
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-6 min-h-screen">

    <div class="max-w-7xl mx-auto space-y-8">
        
        <header class="bg-white p-6 rounded-2xl shadow-sm border-b-4 border-emerald-600 flex flex-wrap justify-between items-center gap-4">
            <div>
                <h1 class="text-3xl font-black text-gray-800">Ø§Ù„Ù…Ø­Ù„Ù„ Ø§Ù„Ø¹Ø¯Ù„ÙŠ <span class="text-emerald-600">Ø§Ù„Ù…Ø§Ø³ÙŠ</span></h1>
                <p class="text-gray-500 font-medium mt-1">ÙØµÙ„ Ø§Ù„Ù…ØªÙˆÙÙ‰ Ø¹Ù† Ø§Ù„ÙˆØ±Ø«Ø© â€¢ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆÙƒÙŠÙ„ Ø¨Ø¯Ù‚Ø© â€¢ Ø³Ø­Ø¨ Ø§Ù„Ù†Ø·Ø§Ù‚</p>
            </div>
            <button id="resetBtn" class="text-sm text-gray-400 hover:text-red-500 underline" onclick="location.reload()">Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©</button>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            
            <div id="heirsZone" class="drop-area p-8 rounded-2xl text-center cursor-pointer group relative">
                <input type="file" id="heirsFile" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                <div class="icon text-5xl mb-3 opacity-50 group-hover:opacity-100 transition">ğŸ“„</div>
                <h3 class="text-lg font-bold text-gray-700">1. ØµÙƒ Ø­ØµØ± Ø§Ù„ÙˆØ±Ø«Ø©</h3>
                <p id="heirsMsg" class="text-sm text-gray-400 mt-2">Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ù„Ù Ù‡Ù†Ø§</p>
            </div>

            <div id="poaZone" class="drop-area p-8 rounded-2xl text-center cursor-pointer group relative">
                <input type="file" id="poaFile" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                <div class="icon text-5xl mb-3 opacity-50 group-hover:opacity-100 transition">âš–ï¸</div>
                <h3 class="text-lg font-bold text-gray-700">2. ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„ÙˆÙƒØ§Ù„Ø©</h3>
                <p id="poaMsg" class="text-sm text-gray-400 mt-2">Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ù„Ù Ù‡Ù†Ø§</p>
            </div>
        </div>

        <div id="loadingSection" class="hidden text-center py-10">
            <span class="loader"></span>
            <p class="mt-4 text-emerald-800 font-bold animate-pulse">Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†ØµÙˆØµ ÙˆÙØµÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
        </div>

        <div id="resultsSection" class="hidden space-y-8 animate-fade-in">
            
            <div class="data-box">
                <div class="p-4 bg-gray-50 border-b flex justify-between items-center">
                    <h2 class="font-bold text-xl text-gray-800">ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø·Ø±Ø§Ù ÙˆØ§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©</h2>
                    <span id="matchSummary" class="text-sm font-bold px-3 py-1 rounded-lg bg-gray-200"></span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-right">
                        <thead class="bg-gray-100 text-gray-600 text-xs uppercase">
                            <tr>
                                <th class="p-4">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</th>
                                <th class="p-4">Ø§Ù„ØµÙØ© ÙÙŠ Ø§Ù„Ø­ØµØ±</th>
                                <th class="p-4">Ø§Ù„Ø¯ÙˆØ± ÙÙŠ Ø§Ù„ÙˆÙƒØ§Ù„Ø©</th>
                                <th class="p-4 text-center">Ø§Ù„Ù†ØªÙŠØ¬Ø©</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTable" class="divide-y divide-gray-100 text-sm font-medium"></tbody>
                    </table>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                
                <div class="data-box border-t-4 border-amber-500">
                    <div class="p-4 flex items-center gap-2">
                        <span class="text-2xl">ğŸ“</span>
                        <h3 class="font-bold text-lg">Ù†Ø·Ø§Ù‚ Ø§Ù„ÙˆÙƒØ§Ù„Ø© (Scope)</h3>
                    </div>
                    <div id="scopeText" class="clause-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬...</div>
                </div>

                <div class="data-box border-t-4 border-blue-500">
                    <div class="p-4 flex items-center gap-2">
                        <span class="text-2xl">ğŸ </span>
                        <h3 class="font-bold text-lg">Ø¨Ù†Ø¯ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª (Real Estate)</h3>
                    </div>
                    <div id="estateText" class="clause-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬...</div>
                </div>

                <div class="data-box border-t-4 border-red-500 lg:col-span-2">
                    <div class="p-4 flex items-center gap-2">
                        <span class="text-2xl">âš–ï¸</span>
                        <h3 class="font-bold text-lg">Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø§Øª ÙˆØ§Ù„Ù…Ø­Ø§ÙƒÙ… ÙˆÙ‚Ø³Ù…Ø© Ø§Ù„ØªØ±ÙƒØ©</h3>
                    </div>
                    <div id="legalText" class="clause-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬...</div>
                </div>

            </div>
        </div>

    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let files = { heirs: null, poa: null };

        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª
        ['heirs', 'poa'].forEach(type => {
            const zone = document.getElementById(`${type}Zone`);
            const input = document.getElementById(`${type}File`);
            const msg = document.getElementById(`${type}Msg`);

            input.addEventListener('change', (e) => handleFile(e.target.files[0], type, zone, msg));
            zone.addEventListener('dragover', (e) => { e.preventDefault(); zone.classList.add('active'); });
            zone.addEventListener('dragleave', () => zone.classList.remove('active'));
            zone.addEventListener('drop', (e) => {
                e.preventDefault();
                zone.classList.remove('active');
                handleFile(e.dataTransfer.files[0], type, zone, msg);
            });
        });

        function handleFile(file, type, zone, msg) {
            if(!file) return;
            files[type] = file;
            zone.style.borderColor = type === 'heirs' ? '#10b981' : '#3b82f6';
            zone.style.background = '#f0fdf4';
            msg.innerHTML = `<span class="font-bold text-gray-800">${file.name}</span><br>âœ… ØªÙ… Ø§Ù„Ø±ÙØ¹`;
            checkAndRun();
        }

        function checkAndRun() {
            if(files.heirs && files.poa) startAnalysis();
        }

        async function startAnalysis() {
            document.getElementById('loadingSection').classList.remove('hidden');
            document.getElementById('resultsSection').classList.add('hidden');

            try {
                // 1. ØªØ­Ù„ÙŠÙ„ ØµÙƒ Ø§Ù„Ø­ØµØ± (ÙØµÙ„ Ø§Ù„Ù…ØªÙˆÙÙ‰ Ø¹Ù† Ø§Ù„ÙˆØ±Ø«Ø©)
                const hText = await extractText(files.heirs);
                const heirsData = parseHeirshipDoc(hText);

                // 2. ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙˆÙƒØ§Ù„Ø© (ÙØµÙ„ Ø§Ù„ÙˆÙƒÙŠÙ„ Ø¹Ù† Ø§Ù„Ù…ÙˆÙƒÙ„ÙŠÙ† ÙˆØ§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨Ù†ÙˆØ¯)
                const pText = await extractText(files.poa);
                const poaData = parsePOADoc(pText);

                // 3. Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
                renderResults(heirsData, poaData);

            } catch (err) {
                console.error(err);
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„ÙØ§ØªØŒ ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¶ÙˆØ­ Ø§Ù„ØµÙˆØ±.");
            } finally {
                document.getElementById('loadingSection').classList.add('hidden');
                document.getElementById('resultsSection').classList.remove('hidden');
            }
        }

        // --- Ù…Ø­Ø±Ùƒ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ù…ØªÙ‚Ø¯Ù… ---

        function parseHeirshipDoc(text) {
            const clean = normalizeText(text);
            const enText = toEnglishDigits(clean);
            
            // Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø°ÙƒÙŠØ©: Ø§Ù„Ù…ØªÙˆÙÙ‰ ÙŠØ£ØªÙŠ Ø¹Ø§Ø¯Ø© ÙÙŠ Ø¬Ø¯ÙˆÙ„ "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªÙˆÙÙ‰" Ø£Ùˆ ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰
            // Ø³Ù†Ø¨Ø­Ø« Ø¹Ù† Ø£ÙˆÙ„ Ù‡ÙˆÙŠØ© ØªØ¸Ù‡Ø± Ù‚Ø¨Ù„ ÙƒÙ„Ù…Ø© "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ±Ø«Ø©"
            
            const splitPoint = enText.indexOf("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ±Ø«Ø©");
            const deceasedSection = splitPoint > -1 ? enText.substring(0, splitPoint) : enText.substring(0, 300); // Ø£ÙˆÙ„ Ø¬Ø²Ø¡
            const heirsSection = splitPoint > -1 ? enText.substring(splitPoint) : enText;

            // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù‡ÙˆÙŠØ© Ø§Ù„Ù…ØªÙˆÙÙ‰ (Ø£ÙˆÙ„ Ù‡ÙˆÙŠØ© ÙÙŠ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø¹Ù„ÙˆÙŠ)
            const deceasedMatch = deceasedSection.match(/1\d{9}/);
            const deceasedId = deceasedMatch ? deceasedMatch[0] : null;

            // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ÙˆØ±Ø«Ø© (ÙƒÙ„ Ø§Ù„Ù‡ÙˆÙŠØ§Øª ÙÙŠ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø³ÙÙ„ÙŠ)
            let heirsIds = [...new Set(heirsSection.match(/1\d{9}/g) || [])];
            
            // ØªÙ†Ø¸ÙŠÙ: Ø¥Ø°Ø§ ØªÙƒØ±Ø±Øª Ù‡ÙˆÙŠØ© Ø§Ù„Ù…ØªÙˆÙÙ‰ ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ØŒ Ù†Ø­Ø°ÙÙ‡Ø§
            if(deceasedId) heirsIds = heirsIds.filter(id => id !== deceasedId);

            return { deceasedId, heirsIds };
        }

        function parsePOADoc(text) {
            const clean = normalizeText(text);
            const enText = toEnglishDigits(clean); // Ù„Ù„Ø£Ø±Ù‚Ø§Ù…
            const rawText = text; // Ù„Ù„Ù†ØµÙˆØµ (Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ù†ÙˆØ¯)

            // 1. ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆÙƒÙŠÙ„
            // Ù†Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„ØªÙŠ ÙŠØ³Ø¨Ù‚Ù‡Ø§ Ø£Ùˆ ÙŠØªØ¨Ø¹Ù‡Ø§ ÙƒÙ„Ù…Ø© "ÙˆÙƒÙŠÙ„" Ø¨Ù…Ø³Ø§ÙØ© Ù‚Ø±ÙŠØ¨Ø©
            // ÙÙŠ Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„ÙˆÙƒØ§Ù„Ø§ØªØŒ Ø¹Ù…ÙˆØ¯ "Ø§Ù„Ø·Ø±Ù" ÙŠØ­Ø¯Ø¯ Ø§Ù„ØµÙØ©
            
            const allIds = [...new Set(enText.match(/1\d{9}/g) || [])];
            let agentId = null;
            let principals = [];

            // Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø³ÙŠØ§Ù‚ÙŠ Ø¹Ù† Ø§Ù„ÙˆÙƒÙŠÙ„
            // Ù†Ø­ÙˆÙ„ Ø§Ù„Ù†Øµ Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ù„Ù…ØµÙÙˆÙØ© ÙƒÙ„Ù…Ø§Øª Ù„Ù†Ø¨Ø­Ø« Ø¨Ø¯Ù‚Ø©
            const normalizedForSearch = normalizeText(rawText);
            
            // Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆÙƒÙŠÙ„:
            // Ø¹Ø§Ø¯Ø© Ø§Ù„ÙˆÙƒÙŠÙ„ ÙŠØ°ÙƒØ± Ù…Ù†ÙØ±Ø¯Ø§Ù‹ Ø¨Ø§Ø³Ù… "Ø§Ù„ÙˆÙƒÙŠÙ„" Ø£Ùˆ "Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ" Ø£Ùˆ ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø¨ØµÙØ© "ÙˆÙƒÙŠÙ„"
            // Ø³Ù†ÙØªØ±Ø¶ Ø£Ù† Ø£ÙŠ Ù‡ÙˆÙŠØ© ÙŠØ­ÙŠØ· Ø¨Ù‡Ø§ ÙƒÙ„Ù…Ø© "ÙˆÙƒÙŠÙ„" Ù‡ÙŠ Ù„Ù„ÙˆÙƒÙŠÙ„ØŒ ÙˆØ§Ù„Ø¨Ø§Ù‚ÙŠ Ù…ÙˆÙƒÙ„ÙŠÙ†
            
            // Ø·Ø±ÙŠÙ‚Ø© Ø£Ø¨Ø³Ø· ÙˆØ£Ø¯Ù‚ Ù„Ù„ÙˆÙƒØ§Ù„Ø§Øª Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©: Ø§Ù„ÙˆÙƒÙŠÙ„ Ø¹Ø§Ø¯Ø© Ù‡Ùˆ Ø¢Ø®Ø± Ø§Ø³Ù… Ø°ÙƒØ± Ø£Ùˆ ÙŠØªÙ… ØªÙ…ÙŠÙŠØ²Ù‡
            // Ù„ÙƒÙ† Ø³Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙƒÙ„Ù…Ø§Øª:
            
            allIds.forEach(id => {
                // Ù†Ø¨Ø­Ø« Ø¹Ù† Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø±Ù‚Ù… ÙÙŠ Ø§Ù„Ù†Øµ Ø§Ù„Ø£ØµÙ„ÙŠ (Ø¨Ø¹Ø¯ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙÙŠÙ‡ Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ù„Ù„Ø¨Ø­Ø«)
                const index = enText.indexOf(id);
                if (index === -1) { principals.push(id); return; }

                // Ù†Ø£Ø®Ø° Ù†Ø§ÙØ°Ø© Ù†ØµÙŠØ© Ø­ÙˆÙ„ Ø§Ù„Ø±Ù‚Ù… (Ù…Ø«Ù„Ø§Ù‹ 50 Ø­Ø±Ù Ù‚Ø¨Ù„Ù‡ ÙˆØ¨Ø¹Ø¯Ù‡)
                const window = normalizedForSearch.substring(Math.max(0, index - 100), Math.min(normalizedForSearch.length, index + 100));
                
                // Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„ÙˆÙƒÙŠÙ„
                if (window.includes("ÙˆÙƒÙŠÙ„") && !window.includes("Ù…ÙˆÙƒÙ„")) {
                    agentId = id; // ÙˆØ¬Ø¯Ù†Ø§ Ø§Ù„ÙˆÙƒÙŠÙ„
                } else if (window.includes("Ø¹Ù† Ù†ÙØ³Ù‡") || window.includes("Ù…ÙˆÙƒÙ„")) {
                    principals.push(id);
                } else {
                    principals.push(id); // Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù…ÙˆÙƒÙ„
                }
            });

            // Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¯Ù‚ÙŠÙ‚ØŒ Ù†ÙØªØ±Ø¶ Ø£ÙˆÙ„ ÙˆØ§Ø­Ø¯ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙˆÙƒÙŠÙ„ (Ù†Ø§Ø¯Ø± Ø§Ù„Ø­Ø¯ÙˆØ« ÙÙŠ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„)
            // ÙˆÙ„ÙƒÙ† Ø³Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹

            // 2. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨Ù†ÙˆØ¯ (Ø§Ù„Ù†Ø·Ø§Ù‚ØŒ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª...)
            // ØªØ­Ø³ÙŠÙ†: Ù†Ø³ØªØ®Ø¯Ù… ØªØ¹Ø§Ø¨ÙŠØ± ÙØ¶ÙØ§Ø¶Ø© (Fuzzy Regex) Ù„Ø£Ù† OCR Ù‚Ø¯ ÙŠØ®Ø·Ø¦ ÙÙŠ Ø§Ù„Ù…Ø³Ø§ÙØ§Øª
            
            const nitaq = extractSection(rawText, ["Ø§Ù„Ù†Ø·Ø§Ù‚", "Ø­Ø¯ÙˆØ¯ Ø§Ù„ÙˆÙƒØ§Ù„Ø©"], ["Ø§Ù„Ø¨Ù†ÙˆØ¯", "Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª", "Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø§Øª"]);
            const estate = extractSection(rawText, ["Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª", "Ø¹Ù‚Ø§Ø±Ø§Øª"], ["Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø§Øª", "Ø§Ù„Ù…Ø­Ø§ÙƒÙ…", "Ø§Ù„Ø¨Ù†ÙˆÙƒ", "ØµØ¯Ø±Øª"]);
            const legal = extractSection(rawText, ["Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø§Øª ÙˆØ§Ù„Ù…Ø­Ø§ÙƒÙ…", "Ø§Ù„Ù…Ø­Ø§ÙƒÙ…", "Ù‚Ø³Ù…Ø© Ø§Ù„ØªØ±ÙƒØ©"], ["Ø§Ù„Ø¨Ù†ÙˆÙƒ", "Ø§Ù„Ø´Ø±ÙƒØ§Øª", "ØµØ¯Ø±Øª"]);

            return { agentId, principals, clauses: { nitaq, estate, legal } };
        }

        // Ø¯Ø§Ù„Ø© Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø°ÙƒÙŠØ© Ù„Ù„Ù†ØµÙˆØµ Ø¨ÙŠÙ† Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†
        function extractSection(text, startKeywords, endKeywords) {
            // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Øµ Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„Ù„Ø¨Ø­Ø«
            const clean = text.replace(/\s+/g, ' ');
            
            // ØªÙƒÙˆÙŠÙ† Regex Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ
            const startPattern = startKeywords.join("|");
            const endPattern = endKeywords.join("|");
            
            // Ù†Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
            const regex = new RegExp(`(${startPattern})\\s*[:\\.-]?\\s*([\\s\\S]*?)(?=${endPattern}|$)`, 'i');
            const match = clean.match(regex);
            
            if (match && match[2].trim().length > 5) {
                return match[2].trim();
            }
            return "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù†Øµ Ø¨Ø´ÙƒÙ„ ØµØ±ÙŠØ­ Ø£Ùˆ Ø£Ù† Ø¬ÙˆØ¯Ø© Ø§Ù„ØµÙˆØ±Ø© Ø¶Ø¹ÙŠÙØ©.";
        }

        function renderResults(heirsData, poaData) {
            const tbody = document.getElementById('resultsTable');
            tbody.innerHTML = "";
            
            // ØªØ¬Ù…ÙŠØ¹ ÙƒÙ„ Ø§Ù„Ù‡ÙˆÙŠØ§Øª Ø§Ù„ÙØ±ÙŠØ¯Ø©
            const allIds = [...new Set([heirsData.deceasedId, ...heirsData.heirsIds, ...poaData.principals, poaData.agentId].filter(Boolean))];

            let heirsCovered = 0;

            allIds.forEach(id => {
                const isDeceased = id === heirsData.deceasedId;
                const isHeir = heirsData.heirsIds.includes(id);
                const isAgent = id === poaData.agentId;
                const isPrincipal = poaData.principals.includes(id);

                // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØµÙØ© ÙÙŠ Ø§Ù„Ø­ØµØ±
                let heirBadge = "";
                if (isDeceased) heirBadge = '<span class="badge badge-deceased">Ø§Ù„Ù…ØªÙˆÙÙ‰ âš°ï¸</span>';
                else if (isHeir) heirBadge = '<span class="badge badge-heir">ÙˆØ§Ø±Ø« ğŸ‘¤</span>';
                else heirBadge = '<span class="text-gray-400 text-xs">-</span>';

                // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¯ÙˆØ± ÙÙŠ Ø§Ù„ÙˆÙƒØ§Ù„Ø©
                let poaRole = "";
                if (isAgent) poaRole = '<span class="badge badge-agent">Ø§Ù„ÙˆÙƒÙŠÙ„ Ø§Ù„Ø´Ø±Ø¹ÙŠ ğŸŒŸ</span>';
                else if (isPrincipal) poaRole = '<span class="text-gray-700 font-bold">Ù…ÙˆÙƒÙ„</span>';
                else poaRole = '<span class="text-red-300 text-xs">ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯</span>';

                // Ø§Ù„Ù†ØªÙŠØ¬Ø©
                let status = "";
                if (isDeceased) {
                    status = '<span class="text-gray-400 font-bold">-</span>';
                } else if (isPrincipal || isAgent) {
                    status = '<span class="text-emerald-600 font-bold">âœ… ØªÙ… Ø§Ù„ØªÙˆÙƒÙŠÙ„</span>';
                    if (isHeir) heirsCovered++;
                } else if (isHeir) {
                    status = '<span class="text-red-500 font-bold">âŒ Ù„Ù… ÙŠÙˆÙƒÙ„ Ø¨Ø¹Ø¯</span>';
                } else {
                    status = '<span class="text-gray-400 text-xs">Ø·Ø±Ù Ø®Ø§Ø±Ø¬ÙŠ</span>';
                }

                tbody.innerHTML += `
                    <tr class="hover:bg-gray-50 border-b last:border-0">
                        <td class="p-4 font-mono text-gray-600">${id}</td>
                        <td class="p-4">${heirBadge}</td>
                        <td class="p-4">${poaRole}</td>
                        <td class="p-4 text-center">${status}</td>
                    </tr>
                `;
            });

            // Ù…Ù„Ø®Øµ
            const totalHeirs = heirsData.heirsIds.length;
            document.getElementById('matchSummary').innerText = `ØªÙ… ØªÙˆÙƒÙŠÙ„ ${heirsCovered} Ù…Ù† Ø£ØµÙ„ ${totalHeirs} ÙˆØ±Ø«Ø©`;
            
            // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨Ù†ÙˆØ¯
            document.getElementById('scopeText').innerText = poaData.clauses.nitaq;
            document.getElementById('estateText').innerText = poaData.clauses.estate;
            document.getElementById('legalText').innerText = poaData.clauses.legal;
        }

        // --- Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© ---

        async function extractText(file) {
            if (file.type === 'application/pdf') {
                const buffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(buffer).promise;
                let fullText = "";
                // Ù†Ù‚Ø±Ø£ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙØ­Ø§Øª
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    // Ø¯Ù…Ø¬ Ø§Ù„Ù†ØµÙˆØµ Ù…Ø¹ Ù…Ø³Ø§ÙØ§Øª Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ„Ù…Ø§Øª
                    fullText += content.items.map(item => item.str).join(" ") + " \n ";
                }
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù†Øµ Ù‚ØµÙŠØ±Ø§Ù‹ Ø¬Ø¯Ø§Ù‹ (ØµÙˆØ±Ø© Ø¯Ø§Ø®Ù„ PDF)ØŒ Ù†Ø³ØªØ®Ø¯Ù… OCR
                if (fullText.length < 100) return await runOCR(file);
                return fullText;
            } else {
                return await runOCR(file);
            }
        }

        async function runOCR(file) {
            const worker = await Tesseract.createWorker('ara');
            const ret = await worker.recognize(file);
            await worker.terminate();
            return ret.data.text;
        }

        function toEnglishDigits(str) {
            return str.replace(/[Ù -Ù©]/g, d => "0123456789"['Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©'.indexOf(d)]);
        }

        function normalizeText(text) {
            return text
                .replace(/(Ø£|Ø¥|Ø¢)/g, 'Ø§')
                .replace(/(Ø©)/g, 'Ù‡')
                .replace(/(Ù‰)/g, 'ÙŠ')
                .replace(/[\u064B-\u065F\u0640]/g, '') // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ´ÙƒÙŠÙ„
                .replace(/\u200B/g, ''); // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙÙˆØ§ØµÙ„ Ø§Ù„Ø®ÙÙŠØ©
        }
    </script>
</body>
</html>
