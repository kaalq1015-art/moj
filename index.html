<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام استخراج البيانات الذكي - النسخة الاحترافية 2026</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'IBM Plex Sans Arabic', sans-serif; background-color: #f8fafc; }
        .drop-zone { border: 3px dashed #cbd5e1; transition: all 0.3s ease; }
        .drop-zone.dragover { border-color: #2563eb; background: #eff6ff; }
        .loader { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #2563eb; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .id-valid { color: #10b981; font-weight: bold; }
        .id-invalid { color: #ef4444; font-weight: bold; }
        .ar-text { line-height: 1.8; text-align: justify; }
    </style>
</head>
<body class="antialiased text-slate-800">

    <div class="min-h-screen flex flex-col">
        <nav class="bg-white border-b px-8 py-4 flex justify-between items-center sticky top-0 z-50 shadow-sm">
            <div class="flex items-center gap-4">
                <div class="bg-blue-600 p-2 rounded-lg text-white">
                    <i data-lucide="scale" class="w-6 h-6"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold">نظام استخراج البيانات الذكي</h1>
                    <p class="text-xs text-slate-500 uppercase tracking-wider">تحليل الصكوك والوكالات عبر AI [2026]</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <span id="system-date" class="text-sm font-medium bg-slate-100 px-3 py-1 rounded-full"></span>
                <button onclick="location.reload()" class="text-sm text-blue-600 hover:underline">تحليل جديد</button>
            </div>
        </nav>

        <main class="p-6 max-w-7xl mx-auto w-full space-y-8">
            
            <section id="upload-section" class="bg-white p-10 rounded-3xl shadow-sm border border-slate-200 text-center">
                <div id="drop-zone" class="drop-zone rounded-2xl p-12 cursor-pointer">
                    <input type="file" id="file-input" class="hidden" accept=".pdf" multiple>
                    <i data-lucide="upload-cloud" class="w-16 h-16 text-blue-500 mx-auto mb-4"></i>
                    <h3 class="text-xl font-bold mb-2">اسحب وأفلت صكوك الوكالة أو حصر الورثة</h3>
                    <p class="text-slate-500 text-sm">سيقوم النظام بربط البيانات آلياً بين المستندات</p>
                </div>
                <div id="file-list" class="mt-6 space-y-2 text-right"></div>
                <button id="process-btn" disabled class="mt-8 w-full bg-blue-600 text-white py-4 rounded-xl font-bold disabled:opacity-50 transition-all hover:bg-blue-700">
                    بدء التحليل القانوني الذكي
                </button>
            </section>

            <section id="loading-ui" class="hidden bg-white p-10 rounded-3xl shadow-sm border border-slate-200">
                <div class="text-center space-y-4">
                    <div class="loader mx-auto"></div>
                    <h2 class="text-2xl font-bold" id="status-title">جاري استخراج البيانات...</h2>
                    <p id="status-desc" class="text-slate-500 italic"></p>
                    <div class="w-full bg-slate-100 h-2 rounded-full mt-4">
                        <div id="main-progress" class="bg-blue-600 h-full rounded-full transition-all" style="width: 0%"></div>
                    </div>
                </div>
            </section>

            <section id="results-ui" class="hidden space-y-6">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                        <h3 class="font-bold text-lg mb-4 flex items-center gap-2 text-blue-700">
                            <i data-lucide="sparkles" class="w-5 h-5"></i> ملخص التحليل القانوني (Gemini AI)
                        </h3>
                        <div id="ai-legal-summary" class="ar-text text-sm text-slate-700 bg-blue-50/50 p-4 rounded-xl border border-blue-100 min-h-[150px]">
                            جاري صياغة الملخص...
                        </div>
                    </div>
                    
                    <div class="bg-slate-900 text-white p-6 rounded-2xl shadow-sm overflow-hidden relative">
                        <i data-lucide="database" class="absolute -bottom-4 -left-4 w-24 h-24 opacity-10"></i>
                        <h3 class="font-bold text-lg mb-4">إحصائيات الاستخراج</h3>
                        <div class="grid grid-cols-2 gap-4 text-center">
                            <div class="bg-white/10 p-4 rounded-xl">
                                <span class="block text-2xl font-bold" id="stat-names">0</span>
                                <span class="text-xs opacity-70">أفراد</span>
                            </div>
                            <div class="bg-white/10 p-4 rounded-xl">
                                <span class="block text-2xl font-bold" id="stat-docs">0</span>
                                <span class="text-xs opacity-70">مستندات</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="p-6 border-b flex justify-between items-center">
                        <h3 class="font-bold text-lg">الأفراد والارتباطات القانونية</h3>
                        <button onclick="exportToExcel()" class="text-sm bg-emerald-50 text-emerald-700 px-4 py-2 rounded-lg font-bold border border-emerald-200">تصدير Excel</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-right">
                            <thead class="bg-slate-50 text-slate-500 text-xs font-bold uppercase">
                                <tr>
                                    <th class="p-4">الاسم الكامل</th>
                                    <th class="p-4">رقم الهوية</th>
                                    <th class="p-4">الحالة</th>
                                    <th class="p-4">الصفة</th>
                                    <th class="p-4">المصدر</th>
                                </tr>
                            </thead>
                            <tbody id="individuals-table" class="text-sm divide-y"></tbody>
                        </table>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        lucide.createIcons();
        document.getElementById('system-date').textContent = new Date().toLocaleDateString('ar-SA');

        const SystemState = {
            files: new Map(),
            results: { individuals: [], estates: [], summary: "" },
            apiKey: "" // ضع مفتاح Gemini هنا أو عبر وظائف Vercel
        };

        // --- محرك الاستخراج الذكي ---

        async function callGemini(prompt) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${SystemState.apiKey}`;
            const response = await fetch(url, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        }

        // خوارزمية التحقق من الهوية السعودية
        function checkSaudiID(id) {
            const cleanID = id.trim();
            if (!/^[12]\d{9}$/.test(cleanID)) return false;
            let sum = 0;
            for (let i = 0; i < 10; i++) {
                if (i % 2 === 0) {
                    let s = String(Number(cleanID[i]) * 2);
                    sum += Number(s[0]) + (s[1] ? Number(s[1]) : 0);
                } else {
                    sum += Number(cleanID[i]);
                }
            }
            return sum % 10 === 0;
        }

        async function processFiles() {
            const files = Array.from(SystemState.files.values());
            toggleUI('loading');
            let combinedText = "";

            for(let i=0; i < files.length; i++) {
                updateStatus(`جاري معالجة: ${files[i].name}`, (i/files.length)*50);
                const text = await extractTextFromPDF(files[i]);
                combinedText += `\nالمستند: ${files[i].name}\n${text}`;
            }

            updateStatus("جاري التحليل القانوني عبر الذكاء الاصطناعي...", 70);

            const prompt = `
                أنت محلل قانوني سعودي خبير. حلل النص التالي المستخرج من صكوك قانونية:
                1. استخرج قائمة بالأفراد (الاسم، رقم الهوية، الصفة مثل وكيل/موكل/وريث).
                2. استخرج أي بيانات عقارية.
                3. اكتب ملخصاً قانونياً قصيراً جداً لأهم الالتزامات.
                أعد النتائج كـ JSON حصراً بهذا الهيكل:
                {"individuals": [{"name": "", "id": "", "role": ""}], "summary": ""}
                
                النص: ${combinedText}
            `;

            try {
                const aiResponse = await callGemini(prompt);
                const data = JSON.parse(aiResponse.replace(/```json|```/g, ""));
                SystemState.results = data;
                renderResults();
                toggleUI('results');
            } catch(e) {
                alert("حدث خطأ في تحليل AI. تأكد من إدخال مفتاح API الصحيح.");
                toggleUI('upload');
            }
        }

        // --- وظائف الواجهة ---

        function renderResults() {
            const table = document.getElementById('individuals-table');
            table.innerHTML = "";
            
            SystemState.results.individuals.forEach(ind => {
                const isValid = checkSaudiID(ind.id);
                const row = `
                    <tr class="hover:bg-slate-50 transition-colors">
                        <td class="p-4 font-bold">${ind.name}</td>
                        <td class="p-4 font-mono">${ind.id}</td>
                        <td class="p-4">
                            <span class="${isValid ? 'text-emerald-600' : 'text-rose-600'} flex items-center gap-1 text-xs">
                                <i data-lucide="${isValid ? 'check-circle' : 'alert-circle'}" class="w-4 h-4"></i>
                                ${isValid ? 'هوية صحيحة' : 'تحتاج تدقيق'}
                            </span>
                        </td>
                        <td class="p-4"><span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs font-bold">${ind.role}</span></td>
                        <td class="p-4 text-xs text-slate-400">تحليل ذكي</td>
                    </tr>
                `;
                table.insertAdjacentHTML('beforeend', row);
            });

            document.getElementById('ai-legal-summary').innerHTML = marked.parse(SystemState.results.summary || "تم استخراج البيانات بنجاح.");
            document.getElementById('stat-names').textContent = SystemState.results.individuals.length;
            document.getElementById('stat-docs').textContent = SystemState.files.size;
            lucide.createIcons();
        }

        async function extractTextFromPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
            let fullText = "";
            for(let i=1; i<=pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                fullText += content.items.map(item => item.str).join(' ');
            }
            return fullText;
        }

        function toggleUI(state) {
            document.getElementById('upload-section').classList.toggle('hidden', state !== 'upload');
            document.getElementById('loading-ui').classList.toggle('hidden', state !== 'loading');
            document.getElementById('results-ui').classList.toggle('hidden', state !== 'results');
        }

        function updateStatus(text, progress) {
            document.getElementById('status-desc').textContent = text;
            document.getElementById('main-progress').style.width = `${progress}%`;
        }

        // --- الأحداث ---
        const fileInput = document.getElementById('file-input');
        const processBtn = document.getElementById('process-btn');

        fileInput.addEventListener('change', (e) => {
            for(let file of e.target.files) SystemState.files.set(file.name, file);
            document.getElementById('file-list').innerHTML = Array.from(SystemState.files.keys()).map(name => `<div class="text-sm bg-blue-50 p-2 rounded">${name}</div>`).join('');
            processBtn.disabled = SystemState.files.size === 0;
        });

        document.getElementById('drop-zone').onclick = () => fileInput.click();
        processBtn.onclick = processFiles;

        function exportToExcel() {
            const ws = XLSX.utils.json_to_sheet(SystemState.results.individuals);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "الأفراد");
            XLSX.writeFile(wb, `تقرير_البيانات_${new Date().getTime()}.xlsx`);
        }
    </script>
</body>
</html>
